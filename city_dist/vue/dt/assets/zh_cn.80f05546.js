import{h as e,i as t,V as n,R as o,j as i,k as s,M as r,e as a,g as l,Q as c,B as u,l as h,G as d,m as p,T as f,D as m,n as g,o as y,p as v,q as w,F as x,r as b,s as M,t as S,u as T,C as P,v as A,w as _,x as E,y as I,O as C,z as R,a as k,H as L,J as D,K as O,N as z,X as F,Y as N,Z as Y,_ as U,A as j,$ as H,a0 as B,a1 as G,a2 as J,a3 as X,a4 as V,a5 as W,a6 as K,a7 as q,a8 as Z,a9 as Q,aa as $,ab as ee,ac as te,ad as ne,ae as oe,af as ie,ag as se,ah as re,ai as ae,aj as le,ak as ce,al as ue,am as he,an as de,ao as pe,ap as fe,aq as me,ar as ge,as as ye,at as ve,au as we,av as xe,aw as be,ax as Me,ay as Se,az as Te,aA as Pe,aB as Ae,aC as _e,aD as Ee,aE as Ie,aF as Ce,aG as Re,aH as ke,aI as Le,aJ as De,aK as Oe,aL as ze,aM as Fe,S as Ne,W as Ye,f as Ue}from"./stats.module.57945d58.js";import{L as je,c as He,a as Be,F as Ge,f as Je,o as Xe,n as Ve,t as We,h as Ke,v as qe}from"./index.29050639.js";class Ze extends e{constructor(e,c,u,h,d,p,f,m,g){super(),void 0===h&&(console.warn('THREE.FirstPersonControls: The second parameter "domElement" is now mandatory.'),h=document);var y=this;this.mouseButtons={ORBIT:t.LEFT,ZOOM:t.MIDDLE,PAN:t.RIGHT};var v=-1,w=0,x=1,b=2,M=v;this.domElement=h;var S,T=new n,P=!1,A=new o;this.HitModel=function(){};var _,E=null;new i;new o;let I=null;const C=e=>{if(!R(T)&&null!=c&&null!=c.getObjectByName("pointsParent")){(A=new o).setFromCamera(e,u);var t=A.intersectObjects(c.getObjectByName("pointsParent").children,!0);if(t.length>0)return S=t[0].object,d(S,t[0].point),k==S.name&&L<.5||(L=0),void(k=S.name);d(null),L<.5?this.DoubleClick_none():L=0}},R=t=>{(A=new o).setFromCamera(t,u);var n=A.intersectObjects(e.canHitModelList,!0);return n.length>0?(S=n[0].object,m(S,n[0].point),I=S,!0):(I=null,!1)};var k="";this.DoubleClick_none=function(){},this.onMouseDown=function(e){switch(e.preventDefault(),T.x=e.clientX/window.innerWidth*2-1,T.y=-e.clientY/window.innerHeight*2+1,P=!0,e.button){case y.mouseButtons.ORBIT:if(M=w,R(T))return;C(T);break;case y.mouseButtons.ZOOM:M=x;break;case y.mouseButtons.PAN:M=b}},this.onMouseMove=function(t){t.preventDefault(),T.x=t.clientX/h.clientWidth*2-1,T.y=-t.clientY/h.clientHeight*2+1,(t=>{if(null!=c&&0!=e.canHitModelList.length){var n;if(A.setFromCamera(t,u),(n=A.intersectObjects(e.canHitModelList,!0)).length>0){if((_=n[0].object)==I)return;return f(_,n[0].point),I=_,!0}I=null,f(null)}})(T),P&&C(T)},this.onMouseUp=function(e){switch(P=!1,M){case w:case x:break;case b:g()}M=v},this.onTouchStart=function(e){var t=e.touches[0];T.x=Number(t.pageX)/window.innerWidth*2-1,T.y=-Number(t.pageY)/window.innerHeight*2+1,R(T)||(C(T),P=!0)},this.onTouchMove=function(e){var t=e.touches[0];T.x=Number(t.pageX)/window.innerWidth*2-1,T.y=-Number(t.pageY)/window.innerHeight*2+1,P&&C(T)},this.onTouchEnd=function(e){P=!1},function(){let e=new s(.3,.3);var t=new r({color:16777215,transparent:!0,opacity:0,depthTest:!0});(E=new a(e,t)).rotation.x=-.5*Math.PI,E.position.x=0,E.position.y=0,E.position.z=0,c.add(E),E.visible=!1}();var L=0,D=new l;!function e(){L+=D.getDelta(),requestAnimationFrame(e)}(),this.dispose=function(){this.domElement.removeEventListener("contextmenu",Qe),this.domElement.removeEventListener("mousedown",z),this.domElement.removeEventListener("mousemove",O),this.domElement.removeEventListener("mouseup",F),this.domElement.removeEventListener("touchstart",N,!1),this.domElement.removeEventListener("touchend",Y,!1),this.domElement.removeEventListener("touchmove",U,!1)};const O=this.onMouseMove.bind(this),z=this.onMouseDown.bind(this),F=this.onMouseUp.bind(this),N=this.onTouchStart.bind(this),Y=this.onTouchEnd.bind(this),U=this.onTouchMove.bind(this);this.domElement.addEventListener("contextmenu",Qe),this.domElement.addEventListener("mousemove",O),this.domElement.addEventListener("mousedown",z),this.domElement.addEventListener("mouseup",F),this.domElement.addEventListener("touchstart",N,!1),this.domElement.addEventListener("touchend",Y,!1),this.domElement.addEventListener("touchmove",U,!1)}}function Qe(e){e.preventDefault()}new i,new i;var $e,et={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-et.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*et.Bounce.In(2*e):.5*et.Bounce.Out(2*e-1)+.5}}},tt="undefined"==typeof self&&"undefined"!=typeof process&&process.hrtime?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof self&&void 0!==self.performance&&void 0!==self.performance.now?self.performance.now.bind(self.performance):void 0!==Date.now?Date.now:function(){return(new Date).getTime()},nt=function(){function e(){this._tweens={},this._tweensAddedDuringUpdate={}}return e.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map((function(t){return e._tweens[t]}))},e.prototype.removeAll=function(){this._tweens={}},e.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},e.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},e.prototype.update=function(e,t){void 0===e&&(e=tt()),void 0===t&&(t=!1);var n=Object.keys(this._tweens);if(0===n.length)return!1;for(;n.length>0;){this._tweensAddedDuringUpdate={};for(var o=0;o<n.length;o++){var i=this._tweens[n[o]],s=!t;i&&!1===i.update(e,s)&&!t&&delete this._tweens[n[o]]}n=Object.keys(this._tweensAddedDuringUpdate)}return!0},e}(),ot={Linear:function(e,t){var n=e.length-1,o=n*t,i=Math.floor(o),s=ot.Utils.Linear;return t<0?s(e[0],e[1],o):t>1?s(e[n],e[n-1],n-o):s(e[i],e[i+1>n?n:i+1],o-i)},Bezier:function(e,t){for(var n=0,o=e.length-1,i=Math.pow,s=ot.Utils.Bernstein,r=0;r<=o;r++)n+=i(1-t,o-r)*i(t,r)*e[r]*s(o,r);return n},CatmullRom:function(e,t){var n=e.length-1,o=n*t,i=Math.floor(o),s=ot.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(i=Math.floor(o=n*(1+t))),s(e[(i-1+n)%n],e[i],e[(i+1)%n],e[(i+2)%n],o-i)):t<0?e[0]-(s(e[0],e[0],e[1],e[1],-o)-e[0]):t>1?e[n]-(s(e[n],e[n],e[n-1],e[n-1],o-n)-e[n]):s(e[i?i-1:0],e[i],e[n<i+1?n:i+1],e[n<i+2?n:i+2],o-i)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=ot.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:($e=[1],function(e){var t=1;if($e[e])return $e[e];for(var n=e;n>1;n--)t*=n;return $e[e]=t,t}),CatmullRom:function(e,t,n,o,i){var s=.5*(n-e),r=.5*(o-t),a=i*i;return(2*t-2*n+s+r)*(i*a)+(-3*t+3*n-2*s-r)*a+s*i+t}}},it=function(){function e(){}return e.nextId=function(){return e._nextId++},e._nextId=0,e}(),st=new nt,rt=function(){function e(e,t){void 0===t&&(t=st),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=et.Linear.None,this._interpolationFunction=ot.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._id=it.nextId(),this._isChainStopped=!1,this._goToEnd=!1}return e.prototype.getId=function(){return this._id},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.isPaused=function(){return this._isPaused},e.prototype.to=function(e,t){return this._valuesEnd=Object.create(e),void 0!==t&&(this._duration=t),this},e.prototype.duration=function(e){return this._duration=e,this},e.prototype.start=function(e){if(this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed)for(var t in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(t),this._valuesStart[t]=this._valuesStartRepeat[t];return this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=void 0!==e?"string"==typeof e?tt()+parseFloat(e):e:tt(),this._startTime+=this._delayTime,this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat),this},e.prototype._setupProperties=function(e,t,n,o){for(var i in n){var s=e[i],r=Array.isArray(s),a=r?"array":typeof s,l=!r&&Array.isArray(n[i]);if("undefined"!==a&&"function"!==a){if(l){var c=n[i];if(0===c.length)continue;c=c.map(this._handleRelativeValue.bind(this,s)),n[i]=[s].concat(c)}if("object"!==a&&!r||!s||l)void 0===t[i]&&(t[i]=s),r||(t[i]*=1),o[i]=l?n[i].slice().reverse():t[i]||0;else{for(var u in t[i]=r?[]:{},s)t[i][u]=s[u];o[i]=r?[]:{},this._setupProperties(s,t[i],n[i],o[i])}}}},e.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},e.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},e.prototype.pause=function(e){return void 0===e&&(e=tt()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this)),this},e.prototype.resume=function(e){return void 0===e&&(e=tt()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this):this},e.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},e.prototype.group=function(e){return this._group=e,this},e.prototype.delay=function(e){return this._delayTime=e,this},e.prototype.repeat=function(e){return this._initialRepeat=e,this._repeat=e,this},e.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},e.prototype.yoyo=function(e){return this._yoyo=e,this},e.prototype.easing=function(e){return this._easingFunction=e,this},e.prototype.interpolation=function(e){return this._interpolationFunction=e,this},e.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},e.prototype.onStart=function(e){return this._onStartCallback=e,this},e.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},e.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},e.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},e.prototype.onStop=function(e){return this._onStopCallback=e,this},e.prototype.update=function(e,t){if(void 0===e&&(e=tt()),void 0===t&&(t=!0),this._isPaused)return!0;var n,o,i=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>i)return!1;t&&this.start(e)}if(this._goToEnd=!1,e<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),o=(e-this._startTime)/this._duration,o=0===this._duration||o>1?1:o;var s=this._easingFunction(o);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,s),this._onUpdateCallback&&this._onUpdateCallback(this._object,o),1===o){if(this._repeat>0){for(n in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[n]||(this._valuesStartRepeat[n]=this._valuesStartRepeat[n]+parseFloat(this._valuesEnd[n])),this._yoyo&&this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var r=0,a=this._chainedTweens.length;r<a;r++)this._chainedTweens[r].start(this._startTime+this._duration);return this._isPlaying=!1,!1}return!0},e.prototype._updateProperties=function(e,t,n,o){for(var i in n)if(void 0!==t[i]){var s=t[i]||0,r=n[i],a=Array.isArray(e[i]),l=Array.isArray(r);!a&&l?e[i]=this._interpolationFunction(r,o):"object"==typeof r&&r?this._updateProperties(e[i],s,r,o):"number"==typeof(r=this._handleRelativeValue(s,r))&&(e[i]=s+(r-s)*o)}},e.prototype._handleRelativeValue=function(e,t){return"string"!=typeof t?t:"+"===t.charAt(0)||"-"===t.charAt(0)?e+parseFloat(t):parseFloat(t)},e.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],n=this._valuesEnd[e];this._valuesStartRepeat[e]="string"==typeof n?this._valuesStartRepeat[e]+parseFloat(n):this._valuesEnd[e],this._valuesEnd[e]=t},e}(),at=it.nextId,lt=st,ct=lt.getAll.bind(lt),ut=lt.removeAll.bind(lt),ht=lt.add.bind(lt),dt=lt.remove.bind(lt),pt=lt.update.bind(lt),ft={Easing:et,Group:nt,Interpolation:ot,now:tt,Sequence:it,nextId:at,Tween:rt,VERSION:"18.6.4",getAll:ct,removeAll:ut,add:ht,remove:dt,update:pt};class mt{constructor(e,n,s,r){void 0===s&&(console.warn('THREE.FirstPersonControls: The second parameter "domElement" is now mandatory.'),s=document);var f=this;this.enabled=!0,this.mouseButtons={ORBIT:t.LEFT,ZOOM:t.MIDDLE,PAN:t.RIGHT};var m=-1,g=0,y=1,v=2,w=m;this.domElement=s,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=4,this.enablePan=!0,this.keyPanSpeed=7,performance.now(),new i;var x=null,b=null;let M=null,S=null,T=null,P=null,A=new i(-54,60,120),_=new i(0,0,0);this.SetNiaokanPos=e=>{A.set(e.x,e.y,e.z)},this.SetNiaokanLookatPos=e=>{_.set(e.x,e.y,e.z)};let E=1.6;this.SetCameraOffsetY=function(e){E=e};let I=new i(0,5,-7);this.SetCameraOffset=function(e){I.x=e.x,I.y=e.y,I.z=e.z,T.position.set(I.x,I.y,I.z)};(()=>{let t=new u(.1,.1,.1),o=new h({color:16777215,opacity:0,transparent:!0});(x=new a(t,o)).position.set(0,0,0),e.add(x),b=new a(t,o),e.add(b),b.position.set(0,0,0),b.name="camTarget",e.add(n),S=new d,e.add(S),P=new d,e.add(P),T=new d,P.add(T),T.position.set(I.x,I.y,I.z),M=new d,b.add(M),M.position.set(0,0,0),M.rotation.set(0,1.57,0),n.position.set(A.x,A.y,A.z),n.lookAt(_.x,_.y,_.z)})();var C=0,R=1,k=C;function L(){if(console.log(" 切换控制模式 ",k),k!=R){Pe=!1,Ue=!1,ye=!1,Ce=!1,xe=!1;let e=pe.rotation.clone();0==e.x||(e.x<0?e.y-=Math.PI+Math.PI/2:e.y+=Math.PI),pe.rotation.set(0,e.y,0),b.add(n),b.position.set(0,E,0);let t=I.y-E,o=Math.abs(I.z),i=Math.sqrt(t*t+o*o),s=Math.asin(t/i);N=-i,b.rotation.set(0,-Math.PI/2,-s),n.rotation.set(0,-Math.PI/2,0),n.position.set(N,0,0),he(),Je=!0}else{let t=pe.getWorldPosition(new i);De.lerp(t,1),P.position.set(De.x,De.y,De.z);let o=pe.getWorldQuaternion(new c);P.quaternion.rotateTowards(o,10),e.add(n),me.rotation.set(0,Math.PI/2,0);let s=T.getWorldPosition(new i);ke.lerp(s,1),n.position.set(ke.x,ke.y,ke.z);let r=pe.position.clone();r.y+=E,Le.lerp(r,1),n.lookAt(Le)}}this.SetContrlState=function(e,t){0==e&&(k=C,this.addMouseEventListener(),N=t,t>=-1&&F(!1)),1==e&&(k=R)},this.SetContrlState2=function(){let e=0;return k==C&&(e=0),k==R&&(e=1),e++,e>=2&&(e=0),this.SetContrlState(e),e},this.ChangeCtrlState=function(){L()},this.SetConctrollerInitPos=function(e){x.position.set(e.x,e.y,e.z)},new l;var D=!0;function O(e){var t=new i;return e.getWorldPosition(t),t}this.getWorldPosition=function(e){var t=new i;return e.getWorldPosition(t),t},this.GetRotateY=function(){return x.rotation.y+ge};let z=!0;function F(e){z!=e&&null!=me&&(e?(me.scale.set(1,1,1),1==Z&&(Z=0)):me.scale.set(0,0,0),z=e)}this.mouseX=0,this.mouseY=0,this.mouseXold=0,this.mouseYold=0,this.wheelMin=-20,this.wheelMax=-1;var N=-15;function Y(){k!=R&&null!=me&&(ge=Xe/2,me.rotation.set(0,ge,0),ce())}function U(e,t){pe.rotation.y-=e,b.rotation.z+t<f.minY?b.rotation.z=f.minY:b.rotation.z+t>f.maxY?b.rotation.z=f.maxY:b.rotation.z+=t}this.minY=-1.25,this.maxY=-.03,this.SetMinMax=function(e){this.minY=e.x,this.maxY=e.y},this.onMouseDown=function(e){if(!1!==f.enabled)switch(this.domElement.focus(),e.preventDefault(),e.button){case f.mouseButtons.ORBIT:if(!1===f.enableRotate)return;w=g;break;case f.mouseButtons.ZOOM:if(!1===f.enableZoom)return;w=y;break;case f.mouseButtons.PAN:if(!1===f.enablePan)return;return void(w=v)}},this.onMouseUp=function(e){w=m},this.onMouseWheel=function(e){!1!==this.enabled&&!1!==this.enableZoom&&(e.preventDefault(),e.deltaY<0?N+=.1:e.deltaY>0&&(N-=.1),N<=this.wheelMin&&(N=this.wheelMin),N>=this.wheelMax&&(N=this.wheelMax),ie.set(N,0,0),n.position.set(N,0,0),F(N!=this.wheelMax))},this.onMouseMove=function(e){if(!1!==f.enabled){this.mouseX=e.clientX/window.innerWidth*2-1,this.mouseY=-e.clientY/window.innerHeight*2+1;var t=this.mouseX-this.mouseXold,n=this.mouseY-this.mouseYold;switch(e.preventDefault(),w){case g:if(!1===f.enableRotate)return;U(t*this.rotateSpeed,n),Y();break;case y:if(!1===f.enableZoom)return;break;case v:if(!1===f.enablePan)return;U(t*this.rotateSpeed,n),Y()}this.mouseXold=this.mouseX,this.mouseYold=this.mouseY}},this.mouseDragOn=!1;var j=0,H=0;this.onTouchStart=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.mouseDragOn=!0,!(H>0)){var t=e.touches;j=t.length>1?1:0,H++}},this.onTouchEnd=function(e){this.mouseDragOn=!1,this.lookSpeed=0,J=0,j=0,H>0&&(H=0)};var B=0,G=0,J=0,X=!0,V=!1,W=!1,K=!1,q=!1;this.onTouchMove=function(e){var t=e.target.localName;if("button"!=t&&"div"!=t&&"input"!=t){var n=e.target.id;if(!(n.indexOf("left")>-1||n.indexOf("right")>-1))if(this.mouseDragOn){var o=e.touches,i=e.touches[0];i=o.length>1?e.touches[j]:e.touches[0],J<1&&(B=i.pageX,G=i.pageY,J+=1),B==i.pageX&&G==i.pageY||(this.lookSpeed=.1),this.mouseX=.005*(i.pageX-B),this.mouseY=.005*-(i.pageY-G),pe.rotation.y-=this.mouseX,Y(),b.rotation.z+=this.mouseY,B=i.pageX,G=i.pageY}else J=0}},this.onKeyDown=function(e){if(D){switch(e.code){case"ArrowUp":case"KeyW":X=!0;break;case"ArrowLeft":case"KeyA":V=!0;break;case"ArrowDown":case"KeyS":W=!0;break;case"ArrowRight":case"KeyD":K=!0;break;case"KeyR":q=!0;break;case"KeyF":this.ClickInteractive();break;case"Space":if(e.preventDefault(),e.stopPropagation(),this.ClickJump(),!r.$parent.avatarData.setting.canEnableGravity)return;q=!0}null!=de&&(0==k&&he(),de.onKeyDown(e))}};let Z=0;this.onKeyUp=function(e){if(D){switch(e.code){case"ArrowUp":case"KeyW":X=!1;break;case"ArrowLeft":case"KeyA":V=!1;break;case"ArrowDown":case"KeyS":W=!1;break;case"ArrowRight":case"KeyD":K=!1;break;case"KeyR":case"Space":q=!1;break;case"KeyF":break;case"KeyM":r.$parent.clickOpenPanel("小地图");break;case"KeyC":if(!r.$parent.avatarData.setting.keyC)return;k==R?(k=C,de.ChangeContrlState(0)):(k=R,de.ChangeContrlState(1)),L();break;case"KeyG":if(!r.$parent.avatarData.setting.canEnableGravity)return;de.ToggleGravityActive();break;case"KeyQ":if(!r.$parent.avatarData.setting.keyQ)return;0==Z?(n.position.set(0,0,0),F(!1),Z=1):(n.position.set(N,0,0),Z=0,F(N!=this.wheelMax))}null!=de&&de.onKeyUp(e)}},X=!1,W=!1,V=!1,K=!1;var Q=!1;this.ClickJump=function(){{let e={code:"Space"};if(function(){if(!D)return;Q=!0}(),null==de)return;de.onKeyDown(e)}},this.ClickInteractive=function(){r._YJSceneManager.ClickInteractive()};var $=!1,ee=new i;new i;var te=new i,ne=0,oe=new i;new i;var ie=new i,se=!1,re=null;new p,new c,this.MoveToTarget=e=>{oe.x=x.position.x,oe.y=x.position.y,oe.z=x.position.z,(ee=e).y=oe.y,se=!0,ne=0,me.lookAt(ee),ge=me.rotation.y;var t=oe.distanceTo(ee);null!=re&&re.stop();(re=new ft.Tween(oe).to(ee,700*t).easing(ft.Easing.Linear.None)).onUpdate((()=>{x.position.set(oe.x,oe.y,oe.z)})),re.start(),re.onComplete((()=>{se=!1}))};var ae=null;function le(e,t){null!=de&&(he(),de.MoveByJoystickAxis(e,t))}function ce(){null!=re&&(re.stop(),se=!1,re=null)}this.RotaByJoystickAxis=function(e,t){null!=de&&U(.03*e,.03*-t)},this.MoveByJoystickAxis=(e,t)=>{D&&(0!=e||0!=t?(se=!0,X=!0,ge=t>0?2*Xe+(e-1)*Xe/2:2*Xe-(e-1)*Xe/2,me.rotation.set(0,ge,0),null!=ae&&clearTimeout(ae),ae=setTimeout((()=>{se=!1,X=!1}),100),ce(),le(1*-e,1*-t)):se&&(le(0,0),se=!1,X=!1))};var ue=4;function he(){de.SetMoveSpeed(ue)}this.SetMoveSpeed=e=>{ue=e,he()};var de,pe=null;this.SetAmmoPlayer=function(e,t){t&&(e.add(x),x.position.set(0,-t/2,0),x.rotation.set(0,-1.57,0)),(pe=e).rotation.y=3.14,pe.add(b),b.rotation.set(0,3.14,0)};let fe=2;this.SetCamTargetHeight=function(e){fe=e,console.log("角色高度为 "+fe)},this.SetAmmoPlayer2=function(){(pe=x).rotation.y=3.14},this.GetAmmoPlayer=function(){return pe},this.SetPlayerRota=function(e){pe.rotation.y=e.y+Math.PI},this.SetAmmoCtrl=function(e){de=e},this.AddAudioListener=function(e){b.add(e),e.rotation.y=3.14};var me=null,ge=0;this.SetPlayerToCamTarget=e=>{console.log(" 添加角色 "),me=e,e.position.set(0,-0,0),ge=Xe/2,me.rotation.set(0,ge,0)},this.SetPlayerGroup=e=>{x.add(e),e.position.set(0,0,0)},this.GetPlayerParent=()=>x,this.GetPlayer=()=>me,this.RemovePlayer=()=>{console.log(" 删除本地角色 "),x.remove(me)},this.GetCameraWorldPos=function(){return O(n)},this.GetPlayerWorldPos=function(){return O(pe)},this.GetCamTargetWorldDire=function(){return M.getWorldDirection(new i)},new i(0,0,0),this.SetToOldPos=()=>{D=!0,console.log(" in SetPlayerParentPos ")},this.SetToOtherPos=function(e,t){console.log(" in SetToOtherPos ")},this.SetTarget=(e,t)=>{},this.SetTargetHeight=e=>{console.log(" in SetTargetHeight ",e),b.position.y=e},this.SetCamPos=e=>{n.position.set(N,0,0),b.rotation.set(targetRota.x,targetRota.y,targetRota.z)},this.SetRootRota=e=>{x.rotation.set(e.x,e.y,e.z)},this.SetTargetRota=e=>{b.rotation.set(e.x,e.y,e.z)},this.SetTargetPos=e=>{console.log(" in SetTargetPos ",e.y),b.position.set(e.x,e.y,e.z)},this.SetLerpToTarget=(e,t,n)=>{var o;ee=e,N=n,te.set(n,0,0),o=b.rotation,new i(o.x,o.y,o.z),$=!0};let ye=!1,ve=0,we=new c,xe=!1,be=0;new c,this.SetChangeViewBegin=function(){if(!r.$parent.avatarData.setting.hasAerialView){let e=pe.getWorldQuaternion(new c);P.quaternion.rotateTowards(e,10),De=P.getWorldPosition(new i);let t=pe.getWorldPosition(new i);P.position.set(t.x,t.y,t.z);let o=T.getWorldPosition(new i);n.position.set(o.x,o.y,o.z);let s=pe.position.clone();return s.y+=E,n.lookAt(s),ke=n.getWorldPosition(new i),Le.x=s.x,Le.y=s.y,void(Le.z=s.z)}let e=pe.getWorldQuaternion(new c);P.quaternion.rotateTowards(e,10),De=P.getWorldPosition(new i),n.position.set(A.x,A.y,A.z),ke=n.getWorldPosition(new i),n.lookAt(_.x,_.y,_.z),Le.x=_.x,Le.y=_.y,Le.z=_.z,console.log(" 鸟瞰开场 ")};let Me,Se=!1;this.SetChangeViewBeginEnter=function(e){Me=e,r.$parent.avatarData.setting.inMinMapEditor||(r.$parent.avatarData.setting.hasAerialView?(Se=!0,setTimeout((()=>{Ce=!0,xe=!0}),1e3)):Me&&Me())},this.SetCamNiaokanPos=function(e,t,o,s,r,a){n.position.set(e,t,o),ke=n.getWorldPosition(new i),n.lookAt(s,r,a),console.log(" 编辑小地图界面里面的设置鸟瞰坐标 ")},this.ResetToNiaokanView=function(){if(Te=!Te,Te){ke=n.getWorldPosition(new i);let t=pe.position.clone();t.y+=E,Le.x=t.x,Le.y=t.y,Le.z=t.z,e.attach(n),ye=!1,Ue=!1,Ie=!1,ve=0,Re=0,Ae=0,Pe=!0,_e=!1}else Ce=!0,xe=!0,_e=!0,ve=0,Re=0,Ae=0,Pe=!1};let Te=!1,Pe=!1,Ae=0;let _e=!1;var Ee=new i;let Ie=!1,Ce=!1,Re=0,ke=new i(0,0,0),Le=new i(0,0,0),De=new i(0,0,0);function Oe(){if(Ce){let o=pe.getWorldPosition(new i);De.lerp(o,3*Re),P.position.set(De.x,De.y,De.z),Re+=.001,k==R&&Re>=.05&&(Re=.05);let s=T.getWorldPosition(new i);ke.lerp(s,Re),n.position.set(ke.x,ke.y,ke.z);let r=pe.position.clone();r.y+=E,Le.lerp(r,Re),n.lookAt(Le),ke.distanceTo(s),e=ke,t=s,Math.abs(e.z-t.z)<.01&&Math.abs(e.x-t.x)<.01&&Math.abs(e.y-t.y)<.01&&!xe&&(Ce=!1,Re=0,Se&&k!=R&&(console.log("鸟瞰拉近完成！"),Se=!1,Me&&Me()))}var e,t}let ze=new i(0,0,0),Fe=new i(0,0,0),Ne=new i(0,0,0),Ye=null;this.lookAtPos=function(e){k==R&&(ze=e.clone(),e.y=pe.position.y,Ne=e,null==Ye&&(Ye=Ne.clone()),S.position.copy(pe.position),S.lookAt(Ne),Pe=!1,ye=!0,Ue=!0,Ie=!1,Ce=!0,xe=!0,ve=0)},new i(0,0,0),new i(1,0,0);let Ue=!1,je=0,He=0;var Be=null;this.SetPlayer=e=>{Be=e},this.GetYJPlayer=()=>Be,this.GetCam=()=>n;var Ge="idle";this.setJumpToFalse=()=>{if(Q)return Q=!1,void Be.SetFlyMountDisplay(!1)},this.SetFlyMountDisplay=e=>{de.GetGravityActive()||Be.SetFlyMountDisplay(e)};let Je=!0;this.SetLineRaycast=e=>{Je=e};var Xe=Math.PI;new i,this.update=function(){if(performance.now(),function(){if(Ue){de.SetMoveForward(!0),de.MoveBegin(),X=!0,Fe=O(pe);let e=Fe.clone(),t=ze.clone();e.y=t.y=0;let n=e.distanceTo(t),o=pe.getWorldPosition(new i);if(P.position.set(o.x,o.y,o.z),He++,He>=30){if(Math.abs(n-je)<.01)return X=!1,de.SetMoveForward(!1),Ue=!1,void Be.SetWalkWeight(0);He=0}n<2&&de.MoveEnd(),Be.SetWalkWeight(de.GetMoveSpeed()),n<.5?(X=!1,de.SetMoveForward(!1),Ue=!1,Be.SetWalkWeight(0)):(Ne.y=pe.position.y,ye||pe.lookAt(Ne)),je=n}}(),function(){if(ye){ve+=.25,we=S.getWorldQuaternion(new c),pe.quaternion.rotateTowards(we,ve);let e=pe.quaternion;Math.abs(we.z-e.z)<.01&&Math.abs(we.x-e.x)<.01&&Math.abs(we.y-e.y)<.01&&Math.abs(we.w-e.w)<.01&&(ye=!1,ve=0)}if(xe){be+=.002,be>=.02&&(be=.02);let e=pe.getWorldQuaternion(new c);P.quaternion.rotateTowards(e,be);let t=P.quaternion;Math.abs(e.z-t.z)<.01&&Math.abs(e.x-t.x)<.01&&Math.abs(e.y-t.y)<.01&&Math.abs(e.w-t.w)<.01&&(xe=!1,be=0)}}(),$&&((ee=pe.position.clone()).y+=E,ne+=.001,oe.lerp(ee,ne),console.log(" in ChangeView ",oe.y),b.position.set(oe.x,oe.y,oe.z),Ee.lerp(te,ne),n.position.set(Ee.x,0,0),Math.abs(ee.z-oe.z)<.01&&Math.abs(ee.x-oe.x)<.01&&Math.abs(ee.y-oe.y)<.01&&Math.abs(Ee.x-te.x)<.01&&0==Ue&&($=!1,ne=0)),Pe&&(Ae+=.01,ke.lerp(A,Ae),n.position.set(ke.x,ke.y,ke.z),Le.lerp(_,Ae),n.lookAt(Le),A.distanceTo(ke)<.01&&(Pe=!1,Ae=0,console.log("已移动 鸟瞰 位置"))),Oe(),function(){if(_e){let e=pe.getWorldPosition(new i);De.lerp(e,3*Re),P.position.set(De.x,De.y,De.z);let t=T.getWorldPosition(new i);Ae+=.001,ke.lerp(t,Ae),n.position.set(ke.x,ke.y,ke.z);let o=pe.position.clone();o.y+=E,Le.lerp(o,Ae),n.lookAt(Le),ke.distanceTo(t)<.01&&(_e=!1,Ae=0,k!=R&&Me&&Me())}}(),function(){if(!Je||!r.$parent.avatarData.setting.hasCamRaycast||1==Z)return;let t=O(M),s=M.getWorldDirection(new i);var a=new o(t,s,0,-N-.2).intersectObjects(e.children,!0);if(a.length>0){let e=a[0].object;if("player"==e.parent.name||"ignoreRaycast"==e.parent.name||null!=e.isLine&&1==e.isLine||"ignoreRaycast"==e.name)return;n.position.set(.2-a[0].distance,0,0)}else n.position.set(N,0,0)}(),ft.update(),null!=Be&&null!=me&&(!function(){if(q){if(null==de)return;de.SetJumpFly()}}(),Ge=Q?"jump":X||V||K||W?"walk":"idle",Be.ChangeAnim(Ge),k!=R&&(X?(ge=Xe/2,V&&(ge=3*Xe/4),K&&(ge=Xe/4),me.rotation.set(0,ge,0)):(V&&(ge=Xe,me.rotation.set(0,ge,0)),K&&(ge=0,me.rotation.set(0,ge,0))),W&&(ge=Xe+Xe/2,V&&(ge=5*Xe/4),K&&(ge=7*Xe/4),me.rotation.set(0,ge,0)))),X||V||K||W){if(k!=R&&"walk"==Ge&&Be.SetWalkWeight(1),O(me).y<-20)return void r._YJSceneManager.SetPlayerPos({x:0,y:10,z:0});r._YJSceneManager.UpdateLightPos()}};var Ve=!1;this.dispose=function(){Ve&&(Ve=!1,console.log("移除操作响应"),this.domElement.removeEventListener("contextmenu",gt),this.domElement.removeEventListener("mousemove",We),this.domElement.removeEventListener("mousedown",Ke),this.domElement.removeEventListener("mouseup",qe),this.domElement.removeEventListener("wheel",$e))},this.addMouseEventListener=function(){this.domElement.addEventListener("mousemove",We),this.domElement.addEventListener("mousedown",Ke),this.domElement.addEventListener("mouseup",qe),this.domElement.addEventListener("wheel",$e),window.addEventListener("keydown",Ze),window.addEventListener("keyup",Qe)},this.addEventListener=function(){Ve||(Ve=!0,this.domElement.addEventListener("contextmenu",gt))};const We=this.onMouseMove.bind(this),Ke=this.onMouseDown.bind(this),qe=this.onMouseUp.bind(this),Ze=this.onKeyDown.bind(this),Qe=this.onKeyUp.bind(this),$e=this.onMouseWheel.bind(this);this.onTouchStart.bind(this),this.onTouchEnd.bind(this),this.onTouchMove.bind(this),this.addEventListener()}}function gt(e){e.preventDefault()}
/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/
var yt={},vt=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))},wt=function(e){return new Worker(e)};try{URL.revokeObjectURL(vt(""))}catch(e){vt=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)},wt=function(e){return new Worker(e,{type:"module"})}}var xt=Uint8Array,bt=Uint16Array,Mt=Uint32Array,St=new xt([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Tt=new xt([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Pt=new xt([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),At=function(e,t){for(var n=new bt(31),o=0;o<31;++o)n[o]=t+=1<<e[o-1];var i=new Mt(n[30]);for(o=1;o<30;++o)for(var s=n[o];s<n[o+1];++s)i[s]=s-n[o]<<5|o;return[n,i]},_t=At(St,2),Et=_t[0],It=_t[1];Et[28]=258,It[258]=28;for(var Ct=At(Tt,0),Rt=Ct[0],kt=Ct[1],Lt=new bt(32768),Dt=0;Dt<32768;++Dt){var Ot=(43690&Dt)>>>1|(21845&Dt)<<1;Ot=(61680&(Ot=(52428&Ot)>>>2|(13107&Ot)<<2))>>>4|(3855&Ot)<<4,Lt[Dt]=((65280&Ot)>>>8|(255&Ot)<<8)>>>1}var zt=function(e,t,n){for(var o=e.length,i=0,s=new bt(t);i<o;++i)++s[e[i]-1];var r,a=new bt(t);for(i=0;i<t;++i)a[i]=a[i-1]+s[i-1]<<1;if(n){r=new bt(1<<t);var l=15-t;for(i=0;i<o;++i)if(e[i])for(var c=i<<4|e[i],u=t-e[i],h=a[e[i]-1]++<<u,d=h|(1<<u)-1;h<=d;++h)r[Lt[h]>>>l]=c}else for(r=new bt(o),i=0;i<o;++i)e[i]&&(r[i]=Lt[a[e[i]-1]++]>>>15-e[i]);return r},Ft=new xt(288);for(Dt=0;Dt<144;++Dt)Ft[Dt]=8;for(Dt=144;Dt<256;++Dt)Ft[Dt]=9;for(Dt=256;Dt<280;++Dt)Ft[Dt]=7;for(Dt=280;Dt<288;++Dt)Ft[Dt]=8;var Nt=new xt(32);for(Dt=0;Dt<32;++Dt)Nt[Dt]=5;var Yt=zt(Ft,9,0),Ut=zt(Ft,9,1),jt=zt(Nt,5,0),Ht=zt(Nt,5,1),Bt=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Gt=function(e,t,n){var o=t/8|0;return(e[o]|e[o+1]<<8)>>(7&t)&n},Jt=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},Xt=function(e){return(e/8|0)+(7&e&&1)},Vt=function(e,t,n){(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length);var o=new(e instanceof bt?bt:e instanceof Mt?Mt:xt)(n-t);return o.set(e.subarray(t,n)),o},Wt=function(e,t,n){var o=e.length;if(!o||n&&!n.l&&o<5)return t||new xt(0);var i=!t||n,s=!n||n.i;n||(n={}),t||(t=new xt(3*o));var r=function(e){var n=t.length;if(e>n){var o=new xt(Math.max(2*n,e));o.set(t),t=o}},a=n.f||0,l=n.p||0,c=n.b||0,u=n.l,h=n.d,d=n.m,p=n.n,f=8*o;do{if(!u){n.f=a=Gt(e,l,1);var m=Gt(e,l+1,3);if(l+=3,!m){var g=e[(_=Xt(l)+4)-4]|e[_-3]<<8,y=_+g;if(y>o){if(s)throw"unexpected EOF";break}i&&r(c+g),t.set(e.subarray(_,y),c),n.b=c+=g,n.p=l=8*y;continue}if(1==m)u=Ut,h=Ht,d=9,p=5;else{if(2!=m)throw"invalid block type";var v=Gt(e,l,31)+257,w=Gt(e,l+10,15)+4,x=v+Gt(e,l+5,31)+1;l+=14;for(var b=new xt(x),M=new xt(19),S=0;S<w;++S)M[Pt[S]]=Gt(e,l+3*S,7);l+=3*w;var T=Bt(M),P=(1<<T)-1,A=zt(M,T,1);for(S=0;S<x;){var _,E=A[Gt(e,l,P)];if(l+=15&E,(_=E>>>4)<16)b[S++]=_;else{var I=0,C=0;for(16==_?(C=3+Gt(e,l,3),l+=2,I=b[S-1]):17==_?(C=3+Gt(e,l,7),l+=3):18==_&&(C=11+Gt(e,l,127),l+=7);C--;)b[S++]=I}}var R=b.subarray(0,v),k=b.subarray(v);d=Bt(R),p=Bt(k),u=zt(R,d,1),h=zt(k,p,1)}if(l>f){if(s)throw"unexpected EOF";break}}i&&r(c+131072);for(var L=(1<<d)-1,D=(1<<p)-1,O=l;;O=l){var z=(I=u[Jt(e,l)&L])>>>4;if((l+=15&I)>f){if(s)throw"unexpected EOF";break}if(!I)throw"invalid length/literal";if(z<256)t[c++]=z;else{if(256==z){O=l,u=null;break}var F=z-254;if(z>264){var N=St[S=z-257];F=Gt(e,l,(1<<N)-1)+Et[S],l+=N}var Y=h[Jt(e,l)&D],U=Y>>>4;if(!Y)throw"invalid distance";l+=15&Y;k=Rt[U];if(U>3){N=Tt[U];k+=Jt(e,l)&(1<<N)-1,l+=N}if(l>f){if(s)throw"unexpected EOF";break}i&&r(c+131072);for(var j=c+F;c<j;c+=4)t[c]=t[c-k],t[c+1]=t[c+1-k],t[c+2]=t[c+2-k],t[c+3]=t[c+3-k];c=j}}n.l=u,n.p=O,n.b=c,u&&(a=1,n.m=d,n.d=h,n.n=p)}while(!a);return c==t.length?t:Vt(t,0,c)},Kt=function(e,t,n){n<<=7&t;var o=t/8|0;e[o]|=n,e[o+1]|=n>>>8},qt=function(e,t,n){n<<=7&t;var o=t/8|0;e[o]|=n,e[o+1]|=n>>>8,e[o+2]|=n>>>16},Zt=function(e,t){for(var n=[],o=0;o<e.length;++o)e[o]&&n.push({s:o,f:e[o]});var i=n.length,s=n.slice();if(!i)return[sn,0];if(1==i){var r=new xt(n[0].s+1);return r[n[0].s]=1,[r,1]}n.sort((function(e,t){return e.f-t.f})),n.push({s:-1,f:25001});var a=n[0],l=n[1],c=0,u=1,h=2;for(n[0]={s:-1,f:a.f+l.f,l:a,r:l};u!=i-1;)a=n[n[c].f<n[h].f?c++:h++],l=n[c!=u&&n[c].f<n[h].f?c++:h++],n[u++]={s:-1,f:a.f+l.f,l:a,r:l};var d=s[0].s;for(o=1;o<i;++o)s[o].s>d&&(d=s[o].s);var p=new bt(d+1),f=Qt(n[u-1],p,0);if(f>t){o=0;var m=0,g=f-t,y=1<<g;for(s.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));o<i;++o){var v=s[o].s;if(!(p[v]>t))break;m+=y-(1<<f-p[v]),p[v]=t}for(m>>>=g;m>0;){var w=s[o].s;p[w]<t?m-=1<<t-p[w]++-1:++o}for(;o>=0&&m;--o){var x=s[o].s;p[x]==t&&(--p[x],++m)}f=t}return[new xt(p),f]},Qt=function(e,t,n){return-1==e.s?Math.max(Qt(e.l,t,n+1),Qt(e.r,t,n+1)):t[e.s]=n},$t=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new bt(++t),o=0,i=e[0],s=1,r=function(e){n[o++]=e},a=1;a<=t;++a)if(e[a]==i&&a!=t)++s;else{if(!i&&s>2){for(;s>138;s-=138)r(32754);s>2&&(r(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(r(i),--s;s>6;s-=6)r(8304);s>2&&(r(s-3<<5|8208),s=0)}for(;s--;)r(i);s=1,i=e[a]}return[n.subarray(0,o),t]},en=function(e,t){for(var n=0,o=0;o<t.length;++o)n+=e[o]*t[o];return n},tn=function(e,t,n){var o=n.length,i=Xt(t+2);e[i]=255&o,e[i+1]=o>>>8,e[i+2]=255^e[i],e[i+3]=255^e[i+1];for(var s=0;s<o;++s)e[i+s+4]=n[s];return 8*(i+4+o)},nn=function(e,t,n,o,i,s,r,a,l,c,u){Kt(t,u++,n),++i[256];for(var h=Zt(i,15),d=h[0],p=h[1],f=Zt(s,15),m=f[0],g=f[1],y=$t(d),v=y[0],w=y[1],x=$t(m),b=x[0],M=x[1],S=new bt(19),T=0;T<v.length;++T)S[31&v[T]]++;for(T=0;T<b.length;++T)S[31&b[T]]++;for(var P=Zt(S,7),A=P[0],_=P[1],E=19;E>4&&!A[Pt[E-1]];--E);var I,C,R,k,L=c+5<<3,D=en(i,Ft)+en(s,Nt)+r,O=en(i,d)+en(s,m)+r+14+3*E+en(S,A)+(2*S[16]+3*S[17]+7*S[18]);if(L<=D&&L<=O)return tn(t,u,e.subarray(l,l+c));if(Kt(t,u,1+(O<D)),u+=2,O<D){I=zt(d,p,0),C=d,R=zt(m,g,0),k=m;var z=zt(A,_,0);Kt(t,u,w-257),Kt(t,u+5,M-1),Kt(t,u+10,E-4),u+=14;for(T=0;T<E;++T)Kt(t,u+3*T,A[Pt[T]]);u+=3*E;for(var F=[v,b],N=0;N<2;++N){var Y=F[N];for(T=0;T<Y.length;++T){var U=31&Y[T];Kt(t,u,z[U]),u+=A[U],U>15&&(Kt(t,u,Y[T]>>>5&127),u+=Y[T]>>>12)}}}else I=Yt,C=Ft,R=jt,k=Nt;for(T=0;T<a;++T)if(o[T]>255){U=o[T]>>>18&31;qt(t,u,I[U+257]),u+=C[U+257],U>7&&(Kt(t,u,o[T]>>>23&31),u+=St[U]);var j=31&o[T];qt(t,u,R[j]),u+=k[j],j>3&&(qt(t,u,o[T]>>>5&8191),u+=Tt[j])}else qt(t,u,I[o[T]]),u+=C[o[T]];return qt(t,u,I[256]),u+C[256]},on=new Mt([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),sn=new xt(0),rn=function(e,t,n,o,i,s){var r=e.length,a=new xt(o+r+5*(1+Math.ceil(r/7e3))+i),l=a.subarray(o,a.length-i),c=0;if(!t||r<8)for(var u=0;u<=r;u+=65535){var h=u+65535;h<r?c=tn(l,c,e.subarray(u,h)):(l[u]=s,c=tn(l,c,e.subarray(u,r)))}else{for(var d=on[t-1],p=d>>>13,f=8191&d,m=(1<<n)-1,g=new bt(32768),y=new bt(m+1),v=Math.ceil(n/3),w=2*v,x=function(t){return(e[t]^e[t+1]<<v^e[t+2]<<w)&m},b=new Mt(25e3),M=new bt(288),S=new bt(32),T=0,P=0,A=(u=0,0),_=0,E=0;u<r;++u){var I=x(u),C=32767&u,R=y[I];if(g[C]=R,y[I]=C,_<=u){var k=r-u;if((T>7e3||A>24576)&&k>423){c=nn(e,l,0,b,M,S,P,A,E,u-E,c),A=T=P=0,E=u;for(var L=0;L<286;++L)M[L]=0;for(L=0;L<30;++L)S[L]=0}var D=2,O=0,z=f,F=C-R&32767;if(k>2&&I==x(u-F))for(var N=Math.min(p,k)-1,Y=Math.min(32767,u),U=Math.min(258,k);F<=Y&&--z&&C!=R;){if(e[u+D]==e[u+D-F]){for(var j=0;j<U&&e[u+j]==e[u+j-F];++j);if(j>D){if(D=j,O=F,j>N)break;var H=Math.min(F,j-2),B=0;for(L=0;L<H;++L){var G=u-F+L+32768&32767,J=G-g[G]+32768&32767;J>B&&(B=J,R=G)}}}F+=(C=R)-(R=g[C])+32768&32767}if(O){b[A++]=268435456|It[D]<<18|kt[O];var X=31&It[D],V=31&kt[O];P+=St[X]+Tt[V],++M[257+X],++S[V],_=u+D,++T}else b[A++]=e[u],++M[e[u]]}}c=nn(e,l,s,b,M,S,P,A,E,u-E,c),!s&&7&c&&(c=tn(l,c+1,sn))}return Vt(a,0,o+Xt(c)+i)},an=function(){for(var e=new Mt(256),t=0;t<256;++t){for(var n=t,o=9;--o;)n=(1&n&&3988292384)^n>>>1;e[t]=n}return e}(),ln=function(){var e=-1;return{p:function(t){for(var n=e,o=0;o<t.length;++o)n=an[255&n^t[o]]^n>>>8;e=n},d:function(){return~e}}},cn=function(){var e=1,t=0;return{p:function(n){for(var o=e,i=t,s=n.length,r=0;r!=s;){for(var a=Math.min(r+2655,s);r<a;++r)i+=o+=n[r];o=(65535&o)+15*(o>>16),i=(65535&i)+15*(i>>16)}e=o,t=i},d:function(){return(255&(e%=65521))<<24|e>>>8<<16|(255&(t%=65521))<<8|t>>>8}}},un=function(e,t,n,o,i){return rn(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,n,o,!i)},hn=function(e,t){var n={};for(var o in e)n[o]=e[o];for(var o in t)n[o]=t[o];return n},dn=function(e,t,n){for(var o=e(),i=e.toString(),s=i.slice(i.indexOf("[")+1,i.lastIndexOf("]")).replace(/ /g,"").split(","),r=0;r<o.length;++r){var a=o[r],l=s[r];if("function"==typeof a){t+=";"+l+"=";var c=a.toString();if(a.prototype)if(-1!=c.indexOf("[native code]")){var u=c.indexOf(" ",8)+1;t+=c.slice(u,c.indexOf("(",u))}else for(var h in t+=c,a.prototype)t+=";"+l+".prototype."+h+"="+a.prototype[h].toString();else t+=c}else n[l]=a}return[t,n]},pn=[],fn=function(e,t,n,o){var i;if(!pn[n]){for(var s="",r={},a=e.length-1,l=0;l<a;++l)s=(i=dn(e[l],s,r))[0],r=i[1];pn[n]=dn(e[a],s,r)}var c=hn({},pn[n][1]);return function(e,t,n,o,i){var s=wt(yt[t]||(yt[t]=vt(e)));return s.onerror=function(e){return i(e.error,null)},s.onmessage=function(e){return i(null,e.data)},s.postMessage(n,o),s}(pn[n][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+t.toString()+"}",n,c,function(e){var t=[];for(var n in e)(e[n]instanceof xt||e[n]instanceof bt||e[n]instanceof Mt)&&t.push((e[n]=new e[n].constructor(e[n])).buffer);return t}(c),o)},mn=function(){return[xt,bt,Mt,St,Tt,Pt,Et,Rt,Ut,Ht,Lt,zt,Bt,Gt,Jt,Xt,Vt,Wt,Gn,bn,Mn]},gn=function(){return[xt,bt,Mt,St,Tt,Pt,It,kt,Yt,Ft,jt,Nt,Lt,on,sn,zt,Kt,qt,Zt,Qt,$t,en,tn,nn,Xt,Vt,rn,un,Un,bn]},yn=function(){return[Cn,Ln,In,ln,an]},vn=function(){return[Rn,kn]},wn=function(){return[Dn,In,cn]},xn=function(){return[On]},bn=function(e){return postMessage(e,[e.buffer])},Mn=function(e){return e&&e.size&&new xt(e.size)},Sn=function(e,t,n,o,i,s){var r=fn(n,o,i,(function(e,t){r.terminate(),s(e,t)}));return r.postMessage([e,t],t.consume?[e.buffer]:[]),function(){r.terminate()}},Tn=function(e){return e.ondata=function(e,t){return postMessage([e,t],[e.buffer])},function(t){return e.push(t.data[0],t.data[1])}},Pn=function(e,t,n,o,i){var s,r=fn(e,o,i,(function(e,n){e?(r.terminate(),t.ondata.call(t,e)):(n[1]&&r.terminate(),t.ondata.call(t,e,n[0],n[1]))}));r.postMessage(n),t.push=function(e,n){if(s)throw"stream finished";if(!t.ondata)throw"no stream handler";r.postMessage([e,s=n],[e.buffer])},t.terminate=function(){r.terminate()}},An=function(e,t){return e[t]|e[t+1]<<8},_n=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},En=function(e,t){return _n(e,t)+4294967296*_n(e,t+4)},In=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8},Cn=function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&In(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var o=0;o<=n.length;++o)e[o+10]=n.charCodeAt(o)}},Rn=function(e){if(31!=e[0]||139!=e[1]||8!=e[2])throw"invalid gzip data";var t=e[3],n=10;4&t&&(n+=e[10]|2+(e[11]<<8));for(var o=(t>>3&1)+(t>>4&1);o>0;o-=!e[n++]);return n+(2&t)},kn=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},Ln=function(e){return 10+(e.filename&&e.filename.length+1||0)},Dn=function(e,t){var n=t.level,o=0==n?0:n<6?1:9==n?3:2;e[0]=120,e[1]=o<<6|(o?32-2*o:1)},On=function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function zn(e,t){return t||"function"!=typeof e||(t=e,e={}),this.ondata=t,e}var Fn=function(){function e(e,t){t||"function"!=typeof e||(t=e,e={}),this.ondata=t,this.o=e||{}}return e.prototype.p=function(e,t){this.ondata(un(e,this.o,0,0,!t),t)},e.prototype.push=function(e,t){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=t,this.p(e,t||!1)},e}(),Nn=function(){return function(e,t){Pn([gn,function(){return[Tn,Fn]}],this,zn.call(this,e,t),(function(e){var t=new Fn(e.data);onmessage=Tn(t)}),6)}}();function Yn(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Sn(e,t,[gn],(function(e){return bn(Un(e.data[0],e.data[1]))}),0,n)}function Un(e,t){return un(e,t||{},0,0)}var jn=function(){function e(e){this.s={},this.p=new xt(0),this.ondata=e}return e.prototype.e=function(e){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var t=this.p.length,n=new xt(t+e.length);n.set(this.p),n.set(e,t),this.p=n},e.prototype.c=function(e){this.d=this.s.i=e||!1;var t=this.s.b,n=Wt(this.p,this.o,this.s);this.ondata(Vt(n,t,this.s.b),this.d),this.o=Vt(n,this.s.b-32768),this.s.b=this.o.length,this.p=Vt(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}(),Hn=function(){return function(e){this.ondata=e,Pn([mn,function(){return[Tn,jn]}],this,0,(function(){var e=new jn;onmessage=Tn(e)}),7)}}();function Bn(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Sn(e,t,[mn],(function(e){return bn(Gn(e.data[0],Mn(e.data[1])))}),1,n)}function Gn(e,t){return Wt(e,t)}var Jn=function(){function e(e,t){this.c=ln(),this.l=0,this.v=1,Fn.call(this,e,t)}return e.prototype.push=function(e,t){Fn.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e),this.l+=e.length;var n=un(e,this.o,this.v&&Ln(this.o),t&&8,!t);this.v&&(Cn(n,this.o),this.v=0),t&&(In(n,n.length-8,this.c.d()),In(n,n.length-4,this.l)),this.ondata(n,t)},e}(),Xn=function(){return function(e,t){Pn([gn,yn,function(){return[Tn,Fn,Jn]}],this,zn.call(this,e,t),(function(e){var t=new Jn(e.data);onmessage=Tn(t)}),8)}}();function Vn(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Sn(e,t,[gn,yn,function(){return[Wn]}],(function(e){return bn(Wn(e.data[0],e.data[1]))}),2,n)}function Wn(e,t){t||(t={});var n=ln(),o=e.length;n.p(e);var i=un(e,t,Ln(t),8),s=i.length;return Cn(i,t),In(i,s-8,n.d()),In(i,s-4,o),i}var Kn=function(){function e(e){this.v=1,jn.call(this,e)}return e.prototype.push=function(e,t){if(jn.prototype.e.call(this,e),this.v){var n=this.p.length>3?Rn(this.p):4;if(n>=this.p.length&&!t)return;this.p=this.p.subarray(n),this.v=0}if(t){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}jn.prototype.c.call(this,t)},e}(),qn=function(){return function(e){this.ondata=e,Pn([mn,vn,function(){return[Tn,jn,Kn]}],this,0,(function(){var e=new Kn;onmessage=Tn(e)}),9)}}();function Zn(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Sn(e,t,[mn,vn,function(){return[Qn]}],(function(e){return bn(Qn(e.data[0]))}),3,n)}function Qn(e,t){return Wt(e.subarray(Rn(e),-8),t||new xt(kn(e)))}var $n=function(){function e(e,t){this.c=cn(),this.v=1,Fn.call(this,e,t)}return e.prototype.push=function(e,t){Fn.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e);var n=un(e,this.o,this.v&&2,t&&4,!t);this.v&&(Dn(n,this.o),this.v=0),t&&In(n,n.length-4,this.c.d()),this.ondata(n,t)},e}(),eo=function(){return function(e,t){Pn([gn,wn,function(){return[Tn,Fn,$n]}],this,zn.call(this,e,t),(function(e){var t=new $n(e.data);onmessage=Tn(t)}),10)}}();function to(e,t){t||(t={});var n=cn();n.p(e);var o=un(e,t,2,4);return Dn(o,t),In(o,o.length-4,n.d()),o}var no=function(){function e(e){this.v=1,jn.call(this,e)}return e.prototype.push=function(e,t){if(jn.prototype.e.call(this,e),this.v){if(this.p.length<2&&!t)return;this.p=this.p.subarray(2),this.v=0}if(t){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}jn.prototype.c.call(this,t)},e}(),oo=function(){return function(e){this.ondata=e,Pn([mn,xn,function(){return[Tn,jn,no]}],this,0,(function(){var e=new no;onmessage=Tn(e)}),11)}}();function io(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Sn(e,t,[mn,xn,function(){return[so]}],(function(e){return bn(so(e.data[0],Mn(e.data[1])))}),5,n)}function so(e,t){return Wt((On(e),e.subarray(2,-4)),t)}var ro=function(){function e(e){this.G=Kn,this.I=jn,this.Z=no,this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(e,t);else{if(this.p&&this.p.length){var n=new xt(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length)}else this.p=e;if(this.p.length>2){var o=this,i=function(){o.ondata.apply(o,arguments)};this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(i):8!=(15&this.p[0])||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(i):new this.Z(i),this.s.push(this.p,t),this.p=null}}},e}(),ao=function(){function e(e){this.G=qn,this.I=Hn,this.Z=oo,this.ondata=e}return e.prototype.push=function(e,t){ro.prototype.push.call(this,e,t)},e}();var lo=function(e,t,n,o){for(var i in e){var s=e[i],r=t+i;s instanceof xt?n[r]=[s,o]:Array.isArray(s)?n[r]=[s[0],hn(o,s[1])]:lo(s,r+"/",n,o)}},co="undefined"!=typeof TextEncoder&&new TextEncoder,uo="undefined"!=typeof TextDecoder&&new TextDecoder,ho=0;try{uo.decode(sn,{stream:!0}),ho=1}catch(e){}var po=function(e){for(var t="",n=0;;){var o=e[n++],i=(o>127)+(o>223)+(o>239);if(n+i>e.length)return[t,Vt(e,n-1)];i?3==i?(o=((15&o)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t+=String.fromCharCode(55296|o>>10,56320|1023&o)):t+=1&i?String.fromCharCode((31&o)<<6|63&e[n++]):String.fromCharCode((15&o)<<12|(63&e[n++])<<6|63&e[n++]):t+=String.fromCharCode(o)}},fo=function(){function e(e){this.ondata=e,ho?this.t=new TextDecoder:this.p=sn}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(t=!!t,this.t){if(this.ondata(this.t.decode(e,{stream:!0}),t),t){if(this.t.decode().length)throw"invalid utf-8 data";this.t=null}}else{if(!this.p)throw"stream finished";var n=new xt(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length);var o=po(n),i=o[0],s=o[1];if(t){if(s.length)throw"invalid utf-8 data";this.p=null}else this.p=s;this.ondata(i,t)}},e}(),mo=function(){function e(e){this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(this.d)throw"stream finished";this.ondata(go(e),this.d=t||!1)},e}();function go(e,t){if(t){for(var n=new xt(e.length),o=0;o<e.length;++o)n[o]=e.charCodeAt(o);return n}if(co)return co.encode(e);var i=e.length,s=new xt(e.length+(e.length>>1)),r=0,a=function(e){s[r++]=e};for(o=0;o<i;++o){if(r+5>s.length){var l=new xt(r+8+(i-o<<1));l.set(s),s=l}var c=e.charCodeAt(o);c<128||t?a(c):c<2048?(a(192|c>>6),a(128|63&c)):c>55295&&c<57344?(a(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++o))>>18),a(128|c>>12&63),a(128|c>>6&63),a(128|63&c)):(a(224|c>>12),a(128|c>>6&63),a(128|63&c))}return Vt(s,0,r)}function yo(e,t){if(t){for(var n="",o=0;o<e.length;o+=16384)n+=String.fromCharCode.apply(null,e.subarray(o,o+16384));return n}if(uo)return uo.decode(e);var i=po(e),s=i[0];if(i[1].length)throw"invalid utf-8 data";return s}var vo=function(e){return 1==e?3:e<6?2:9==e?1:0},wo=function(e,t){return t+30+An(e,t+26)+An(e,t+28)},xo=function(e,t,n){var o=An(e,t+28),i=yo(e.subarray(t+46,t+46+o),!(2048&An(e,t+8))),s=t+46+o,r=_n(e,t+20),a=n&&4294967295==r?bo(e,s):[r,_n(e,t+24),_n(e,t+42)],l=a[0],c=a[1],u=a[2];return[An(e,t+10),l,c,i,s+An(e,t+30)+An(e,t+32),u]},bo=function(e,t){for(;1!=An(e,t);t+=4+An(e,t+2));return[En(e,t+12),En(e,t+4),En(e,t+20)]},Mo=function(e){var t=0;if(e)for(var n in e){var o=e[n].length;if(o>65535)throw"extra field too long";t+=o+4}return t},So=function(e,t,n,o,i,s,r,a){var l=o.length,c=n.extra,u=a&&a.length,h=Mo(c);In(e,t,null!=r?33639248:67324752),t+=4,null!=r&&(e[t++]=20,e[t++]=n.os),e[t]=20,t+=2,e[t++]=n.flag<<1|(null==s&&8),e[t++]=i&&8,e[t++]=255&n.compression,e[t++]=n.compression>>8;var d=new Date(null==n.mtime?Date.now():n.mtime),p=d.getFullYear()-1980;if(p<0||p>119)throw"date not in range 1980-2099";if(In(e,t,p<<25|d.getMonth()+1<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|d.getSeconds()>>>1),t+=4,null!=s&&(In(e,t,n.crc),In(e,t+4,s),In(e,t+8,n.size)),In(e,t+12,l),In(e,t+14,h),t+=16,null!=r&&(In(e,t,u),In(e,t+6,n.attrs),In(e,t+10,r),t+=14),e.set(o,t),t+=l,h)for(var f in c){var m=c[f],g=m.length;In(e,t,+f),In(e,t+2,g),e.set(m,t+4),t+=4+g}return u&&(e.set(a,t),t+=u),t},To=function(e,t,n,o,i){In(e,t,101010256),In(e,t+8,n),In(e,t+10,n),In(e,t+12,o),In(e,t+16,i)},Po=function(){function e(e){this.filename=e,this.c=ln(),this.size=0,this.compression=0}return e.prototype.process=function(e,t){this.ondata(null,e,t)},e.prototype.push=function(e,t){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(e),this.size+=e.length,t&&(this.crc=this.c.d()),this.process(e,t||!1)},e}(),Ao=function(){function e(e,t){var n=this;t||(t={}),Po.call(this,e),this.d=new Fn(t,(function(e,t){n.ondata(null,e,t)})),this.compression=8,this.flag=vo(t.level)}return e.prototype.process=function(e,t){try{this.d.push(e,t)}catch(e){this.ondata(e,null,t)}},e.prototype.push=function(e,t){Po.prototype.push.call(this,e,t)},e}(),_o=function(){function e(e,t){var n=this;t||(t={}),Po.call(this,e),this.d=new Nn(t,(function(e,t,o){n.ondata(e,t,o)})),this.compression=8,this.flag=vo(t.level),this.terminate=this.d.terminate}return e.prototype.process=function(e,t){this.d.push(e,t)},e.prototype.push=function(e,t){Po.prototype.push.call(this,e,t)},e}(),Eo=function(){function e(e){this.ondata=e,this.u=[],this.d=1}return e.prototype.add=function(e){var t=this;if(2&this.d)throw"stream finished";var n=go(e.filename),o=n.length,i=e.comment,s=i&&go(i),r=o!=e.filename.length||s&&i.length!=s.length,a=o+Mo(e.extra)+30;if(o>65535)throw"filename too long";var l=new xt(a);So(l,0,e,n,r);var c=[l],u=function(){for(var e=0,n=c;e<n.length;e++){var o=n[e];t.ondata(null,o,!1)}c=[]},h=this.d;this.d=0;var d=this.u.length,p=hn(e,{f:n,u:r,o:s,t:function(){e.terminate&&e.terminate()},r:function(){if(u(),h){var e=t.u[d+1];e?e.r():t.d=1}h=1}}),f=0;e.ondata=function(n,o,i){if(n)t.ondata(n,o,i),t.terminate();else if(f+=o.length,c.push(o),i){var s=new xt(16);In(s,0,134695760),In(s,4,e.crc),In(s,8,f),In(s,12,e.size),c.push(s),p.c=f,p.b=a+f+16,p.crc=e.crc,p.size=e.size,h&&p.r(),h=1}else h&&u()},this.u.push(p)},e.prototype.end=function(){var e=this;if(2&this.d){if(1&this.d)throw"stream finishing";throw"stream finished"}this.d?this.e():this.u.push({r:function(){1&e.d&&(e.u.splice(-1,1),e.e())},t:function(){}}),this.d=3},e.prototype.e=function(){for(var e=0,t=0,n=0,o=0,i=this.u;o<i.length;o++){n+=46+(l=i[o]).f.length+Mo(l.extra)+(l.o?l.o.length:0)}for(var s=new xt(n+22),r=0,a=this.u;r<a.length;r++){var l=a[r];So(s,e,l,l.f,l.u,l.c,t,l.o),e+=46+l.f.length+Mo(l.extra)+(l.o?l.o.length:0),t+=l.b}To(s,e,this.u.length,n,t),this.ondata(null,s,!0),this.d=2},e.prototype.terminate=function(){for(var e=0,t=this.u;e<t.length;e++){t[e].t()}this.d=2},e}();var Io=function(){function e(){}return e.prototype.push=function(e,t){this.ondata(null,e,t)},e.compression=0,e}(),Co=function(){function e(){var e=this;this.i=new jn((function(t,n){e.ondata(null,t,n)}))}return e.prototype.push=function(e,t){try{this.i.push(e,t)}catch(n){this.ondata(n,e,t)}},e.compression=8,e}(),Ro=function(){function e(e,t){var n=this;t<32e4?this.i=new jn((function(e,t){n.ondata(null,e,t)})):(this.i=new Hn((function(e,t,o){n.ondata(e,t,o)})),this.terminate=this.i.terminate)}return e.prototype.push=function(e,t){this.i.terminate&&(e=Vt(e,0)),this.i.push(e,t)},e.compression=8,e}(),ko=function(){function e(e){this.onfile=e,this.k=[],this.o={0:Io},this.p=sn}return e.prototype.push=function(e,t){var n=this;if(!this.onfile)throw"no callback";if(!this.p)throw"stream finished";if(this.c>0){var o=Math.min(this.c,e.length),i=e.subarray(0,o);if(this.c-=o,this.d?this.d.push(i,!this.c):this.k[0].push(i),(e=e.subarray(o)).length)return this.push(e,t)}else{var s=0,r=0,a=void 0,l=void 0;this.p.length?e.length?((l=new xt(this.p.length+e.length)).set(this.p),l.set(e,this.p.length)):l=this.p:l=e;for(var c=l.length,u=this.c,h=u&&this.d,d=function(){var e,t=_n(l,r);if(67324752==t){s=1,a=r,p.d=null,p.c=0;var o=An(l,r+6),i=An(l,r+8),h=2048&o,d=8&o,f=An(l,r+26),m=An(l,r+28);if(c>r+30+f+m){var g=[];p.k.unshift(g),s=2;var y,v=_n(l,r+18),w=_n(l,r+22),x=yo(l.subarray(r+30,r+=30+f),!h);4294967295==v?(e=d?[-2]:bo(l,r),v=e[0],w=e[1]):d&&(v=-1),r+=m,p.c=v;var b={name:x,compression:i,start:function(){if(!b.ondata)throw"no callback";if(v){var e=n.o[i];if(!e)throw"unknown compression type "+i;(y=v<0?new e(x):new e(x,v,w)).ondata=function(e,t,n){b.ondata(e,t,n)};for(var t=0,o=g;t<o.length;t++){var s=o[t];y.push(s,!1)}n.k[0]==g&&n.c?n.d=y:y.push(sn,!0)}else b.ondata(null,sn,!0)},terminate:function(){y&&y.terminate&&y.terminate()}};v>=0&&(b.size=v,b.originalSize=w),p.onfile(b)}return"break"}if(u){if(134695760==t)return a=r+=12+(-2==u&&8),s=3,p.c=0,"break";if(33639248==t)return a=r-=4,s=3,p.c=0,"break"}},p=this;r<c-4;++r){if("break"===d())break}if(this.p=sn,u<0){var f=s?l.subarray(0,a-12-(-2==u&&8)-(134695760==_n(l,a-16)&&4)):l.subarray(0,r);h?h.push(f,!!s):this.k[+(2==s)].push(f)}if(2&s)return this.push(l.subarray(r),t);this.p=l.subarray(r)}if(t){if(this.c)throw"invalid zip file";this.p=null}},e.prototype.register=function(e){this.o[e.compression]=e},e}();var Lo=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",Deflate:Fn,AsyncDeflate:Nn,deflate:Yn,deflateSync:Un,Inflate:jn,AsyncInflate:Hn,inflate:Bn,inflateSync:Gn,Gzip:Jn,AsyncGzip:Xn,gzip:Vn,gzipSync:Wn,Gunzip:Kn,AsyncGunzip:qn,gunzip:Zn,gunzipSync:Qn,Zlib:$n,AsyncZlib:eo,zlib:function(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Sn(e,t,[gn,wn,function(){return[to]}],(function(e){return bn(to(e.data[0],e.data[1]))}),4,n)},zlibSync:to,Unzlib:no,AsyncUnzlib:oo,unzlib:io,unzlibSync:so,compress:Vn,AsyncCompress:Xn,compressSync:Wn,Compress:Jn,Decompress:ro,AsyncDecompress:ao,decompress:function(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return 31==e[0]&&139==e[1]&&8==e[2]?Zn(e,t,n):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?Bn(e,t,n):io(e,t,n)},decompressSync:function(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?Qn(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?Gn(e,t):so(e,t)},DecodeUTF8:fo,EncodeUTF8:mo,strToU8:go,strFromU8:yo,ZipPassThrough:Po,ZipDeflate:Ao,AsyncZipDeflate:_o,Zip:Eo,zip:function(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";var o={};lo(e,"",o,t);var i=Object.keys(o),s=i.length,r=0,a=0,l=s,c=new Array(s),u=[],h=function(){for(var e=0;e<u.length;++e)u[e]()},d=function(){var e=new xt(a+22),t=r,o=a-r;a=0;for(var i=0;i<l;++i){var s=c[i];try{var u=s.c.length;So(e,a,s,s.f,s.u,u);var h=30+s.f.length+Mo(s.extra),d=a+h;e.set(s.c,d),So(e,r,s,s.f,s.u,u,a,s.m),r+=16+h+(s.m?s.m.length:0),a=d+u}catch(e){return n(e,null)}}To(e,r,c.length,o,t),n(null,e)};s||d();for(var p=function(e){var t=i[e],l=o[t],p=l[0],f=l[1],m=ln(),g=p.length;m.p(p);var y=go(t),v=y.length,w=f.comment,x=w&&go(w),b=x&&x.length,M=Mo(f.extra),S=0==f.level?0:8,T=function(o,i){if(o)h(),n(o,null);else{var l=i.length;c[e]=hn(f,{size:g,crc:m.d(),c:i,f:y,m:x,u:v!=t.length||x&&w.length!=b,compression:S}),r+=30+v+M+l,a+=76+2*(v+M)+(b||0)+l,--s||d()}};if(v>65535&&T("filename too long",null),S)if(g<16e4)try{T(null,Un(p,f))}catch(e){T(e,null)}else u.push(Yn(p,f,T));else T(null,p)},f=0;f<l;++f)p(f);return h},zipSync:function(e,t){t||(t={});var n={},o=[];lo(e,"",n,t);var i=0,s=0;for(var r in n){var a=n[r],l=a[0],c=a[1],u=0==c.level?0:8,h=(S=go(r)).length,d=c.comment,p=d&&go(d),f=p&&p.length,m=Mo(c.extra);if(h>65535)throw"filename too long";var g=u?Un(l,c):l,y=g.length,v=ln();v.p(l),o.push(hn(c,{size:l.length,crc:v.d(),c:g,f:S,m:p,u:h!=r.length||p&&d.length!=f,o:i,compression:u})),i+=30+h+m+y,s+=76+2*(h+m)+(f||0)+y}for(var w=new xt(s+22),x=i,b=s-i,M=0;M<o.length;++M){var S=o[M];So(w,S.o,S,S.f,S.u,S.c.length);var T=30+S.f.length+Mo(S.extra);w.set(S.c,S.o+T),So(w,i,S,S.f,S.u,S.c.length,S.o,S.m),i+=16+T+(S.m?S.m.length:0)}return To(w,i,o.length,b,x),w},UnzipPassThrough:Io,UnzipInflate:Co,AsyncUnzipInflate:Ro,Unzip:ko,unzip:function(e,t){if("function"!=typeof t)throw"no callback";for(var n=[],o=function(){for(var e=0;e<n.length;++e)n[e]()},i={},s=e.length-22;101010256!=_n(e,s);--s)if(!s||e.length-s>65558)return void t("invalid zip file",null);var r=An(e,s+8);r||t(null,{});var a=r,l=_n(e,s+16),c=4294967295==l;if(c){if(s=_n(e,s-12),101075792!=_n(e,s))return void t("invalid zip file",null);a=r=_n(e,s+32),l=_n(e,s+48)}for(var u=function(s){var a=xo(e,l,c),u=a[0],h=a[1],d=a[2],p=a[3],f=a[4],m=a[5],g=wo(e,m);l=f;var y=function(e,n){e?(o(),t(e,null)):(i[p]=n,--r||t(null,i))};if(u)if(8==u){var v=e.subarray(g,g+h);if(h<32e4)try{y(null,Gn(v,new xt(d)))}catch(e){y(e,null)}else n.push(Bn(v,{size:d},y))}else y("unknown compression type "+u,null);else y(null,Vt(e,g,g+h))},h=0;h<a;++h)u();return o},unzipSync:function(e){for(var t={},n=e.length-22;101010256!=_n(e,n);--n)if(!n||e.length-n>65558)throw"invalid zip file";var o=An(e,n+8);if(!o)return{};var i=_n(e,n+16),s=4294967295==i;if(s){if(n=_n(e,n-12),101075792!=_n(e,n))throw"invalid zip file";o=_n(e,n+32),i=_n(e,n+48)}for(var r=0;r<o;++r){var a=xo(e,i,s),l=a[0],c=a[1],u=a[2],h=a[3],d=a[4],p=a[5],f=wo(e,p);if(i=d,l){if(8!=l)throw"unknown compression type "+l;t[h]=Gn(e.subarray(f,f+c),new xt(u))}else t[h]=Vt(e,f,f+c)}return t}});function Do(e,t,n){const o=n.length-e-1;if(t>=n[o])return o-1;if(t<=n[e])return e;let i=e,s=o,r=Math.floor((i+s)/2);for(;t<n[r]||t>=n[r+1];)t<n[r]?s=r:i=r,r=Math.floor((i+s)/2);return r}function Oo(e,t){let n=1;for(let t=2;t<=e;++t)n*=t;let o=1;for(let e=2;e<=t;++e)o*=e;for(let n=2;n<=e-t;++n)o*=n;return n/o}function zo(e,t,n,o,s){const r=function(e,t,n,o,i){const s=i<e?i:e,r=[],a=Do(e,o,t),l=function(e,t,n,o,i){const s=[];for(let e=0;e<=n;++e)s[e]=0;const r=[];for(let e=0;e<=o;++e)r[e]=s.slice(0);const a=[];for(let e=0;e<=n;++e)a[e]=s.slice(0);a[0][0]=1;const l=s.slice(0),c=s.slice(0);for(let o=1;o<=n;++o){l[o]=t-i[e+1-o],c[o]=i[e+o]-t;let n=0;for(let e=0;e<o;++e){const t=c[e+1],i=l[o-e];a[o][e]=t+i;const s=a[e][o-1]/a[o][e];a[e][o]=n+t*s,n=i*s}a[o][o]=n}for(let e=0;e<=n;++e)r[0][e]=a[e][n];for(let e=0;e<=n;++e){let t=0,i=1;const l=[];for(let e=0;e<=n;++e)l[e]=s.slice(0);l[0][0]=1;for(let s=1;s<=o;++s){let o=0;const c=e-s,u=n-s;e>=s&&(l[i][0]=l[t][0]/a[u+1][c],o=l[i][0]*a[c][u]);const h=e-1<=u?s-1:n-e;for(let e=c>=-1?1:-c;e<=h;++e)l[i][e]=(l[t][e]-l[t][e-1])/a[u+1][c+e],o+=l[i][e]*a[c+e][u];e<=u&&(l[i][s]=-l[t][s-1]/a[u+1][e],o+=l[i][s]*a[e][u]),r[s][e]=o;const d=t;t=i,i=d}}let u=n;for(let e=1;e<=o;++e){for(let t=0;t<=n;++t)r[e][t]*=u;u*=n-e}return r}(a,o,e,s,t),c=[];for(let e=0;e<n.length;++e){const t=n[e].clone(),o=t.w;t.x*=o,t.y*=o,t.z*=o,c[e]=t}for(let t=0;t<=s;++t){const n=c[a-e].clone().multiplyScalar(l[t][0]);for(let o=1;o<=e;++o)n.add(c[a-e+o].clone().multiplyScalar(l[t][o]));r[t]=n}for(let e=s+1;e<=i+1;++e)r[e]=new g(0,0,0);return r}(e,t,n,o,s);return function(e){const t=e.length,n=[],o=[];for(let s=0;s<t;++s){const t=e[s];n[s]=new i(t.x,t.y,t.z),o[s]=t.w}const s=[];for(let e=0;e<t;++e){const t=n[e].clone();for(let n=1;n<=e;++n)t.sub(s[e-n].clone().multiplyScalar(Oo(e,n)*o[n]));s[e]=t.divideScalar(o[0])}return s}(r)}class Fo extends y{constructor(e,t,n,o,i){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=o||0,this.endKnot=i||this.knots.length-1;for(let e=0;e<n.length;++e){const t=n[e];this.controlPoints[e]=new g(t.x,t.y,t.z,t.w)}}getPoint(e,t=new i){const n=t,o=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),s=function(e,t,n,o){const i=Do(e,o,t),s=function(e,t,n,o){const i=[],s=[],r=[];i[0]=1;for(let a=1;a<=n;++a){s[a]=t-o[e+1-a],r[a]=o[e+a]-t;let n=0;for(let e=0;e<a;++e){const t=r[e+1],o=s[a-e],l=i[e]/(t+o);i[e]=n+t*l,n=o*l}i[a]=n}return i}(i,o,e,t),r=new g(0,0,0,0);for(let t=0;t<=e;++t){const o=n[i-e+t],a=s[t],l=o.w*a;r.x+=o.x*l,r.y+=o.y*l,r.z+=o.z*l,r.w+=o.w*a}return r}(this.degree,this.knots,this.controlPoints,o);return 1!==s.w&&s.divideScalar(s.w),n.set(s.x,s.y,s.z)}getTangent(e,t=new i){const n=t,o=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),s=zo(this.degree,this.knots,this.controlPoints,o,1);return n.copy(s[1]).normalize(),n}}let No,Yo,Uo;class jo extends v{constructor(e){super(e)}load(e,t,n,o){const i=this,s=""===i.path?w.extractUrlBase(e):i.path,r=new x(this.manager);r.setPath(i.path),r.setResponseType("arraybuffer"),r.setRequestHeader(i.requestHeader),r.setWithCredentials(i.withCredentials),r.load(e,(function(n){try{t(i.parse(n,s))}catch(t){o?o(t):console.error(t),i.manager.itemError(e)}}),n,o)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===ii(e,0,t.length)}(e))No=(new Xo).parse(e);else{const t=ii(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function o(t){const o=e[t-1];return e=e.slice(n+t),n++,o}for(let e=0;e<t.length;++e){if(o(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(Ko(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Ko(t));No=(new Jo).parse(t)}const n=new b(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Ho(n,this.manager).parse(No)}}class Ho{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Yo=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),o=this.parseDeformers(),i=(new Bo).parse(o);return this.parseScene(o,i,n),Uo}parseConnections(){const e=new Map;if("Connections"in No){No.Connections.connections.forEach((function(t){const n=t[0],o=t[1],i=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const s={ID:o,relationship:i};e.get(n).parents.push(s),e.has(o)||e.set(o,{parents:[],children:[]});const r={ID:n,relationship:i};e.get(o).children.push(r)}))}return e}parseImages(){const e={},t={};if("Video"in No.Objects){const n=No.Objects.Video;for(const o in n){const i=n[o];if(e[parseInt(o)]=i.RelativeFilename||i.Filename,"Content"in i){const e=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,s="string"==typeof i.Content&&""!==i.Content;if(e||s){const e=this.parseImage(n[o]);t[i.RelativeFilename||i.Filename]=e}}}}for(const n in e){const o=e[n];void 0!==t[o]?e[n]=t[o]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,o=n.slice(n.lastIndexOf(".")+1).toLowerCase();let i;switch(o){case"bmp":i="image/bmp";break;case"jpg":case"jpeg":i="image/jpeg";break;case"png":i="image/png";break;case"tif":i="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),i="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+o+'" is not supported.')}if("string"==typeof t)return"data:"+i+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:i}))}}parseTextures(e){const t=new Map;if("Texture"in No.Objects){const n=No.Objects.Texture;for(const o in n){const i=this.parseTexture(n[o],e);t.set(parseInt(o),i)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const o=e.WrapModeU,i=e.WrapModeV,s=void 0!==o?o.value:0,r=void 0!==i?i.value:0;if(n.wrapS=0===s?M:S,n.wrapT=0===r?M:S,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;n.offset.x=t[0],n.offset.y=t[1]}return n}loadTexture(e,t){let n;const o=this.textureLoader.path,i=Yo.get(e.id).children;let s;void 0!==i&&i.length>0&&void 0!==t[i[0].ID]&&(n=t[i[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const r=e.FileName.slice(-3).toLowerCase();if("tga"===r){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),s=new f):(t.setPath(this.textureLoader.path),s=t.load(n))}else"psd"===r?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),s=new f):s=this.textureLoader.load(n);return this.textureLoader.setPath(o),s}parseMaterials(e){const t=new Map;if("Material"in No.Objects){const n=No.Objects.Material;for(const o in n){const i=this.parseMaterial(n[o],e);null!==i&&t.set(parseInt(o),i)}}return t}parseMaterial(e,t){const n=e.id,o=e.attrName;let i=e.ShadingModel;if("object"==typeof i&&(i=i.value),!Yo.has(n))return null;const s=this.parseParameters(e,t,n);let r;switch(i.toLowerCase()){case"phong":r=new T;break;case"lambert":r=new h;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',i),r=new T}return r.setValues(s),r.name=o,r}parseParameters(e,t,n){const o={};e.BumpFactor&&(o.bumpScale=e.BumpFactor.value),e.Diffuse?o.color=(new P).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(o.color=(new P).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(o.displacementScale=e.DisplacementFactor.value),e.Emissive?o.emissive=(new P).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(o.emissive=(new P).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(o.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(o.opacity=parseFloat(e.Opacity.value)),o.opacity<1&&(o.transparent=!0),e.ReflectionFactor&&(o.reflectivity=e.ReflectionFactor.value),e.Shininess&&(o.shininess=e.Shininess.value),e.Specular?o.specular=(new P).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(o.specular=(new P).fromArray(e.SpecularColor.value));const i=this;return Yo.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":o.bumpMap=i.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":o.aoMap=i.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":o.map=i.getTexture(t,e.ID),void 0!==o.map&&(o.map.encoding=A);break;case"DisplacementColor":o.displacementMap=i.getTexture(t,e.ID);break;case"EmissiveColor":o.emissiveMap=i.getTexture(t,e.ID),void 0!==o.emissiveMap&&(o.emissiveMap.encoding=A);break;case"NormalMap":case"Maya|TEX_normal_map":o.normalMap=i.getTexture(t,e.ID);break;case"ReflectionColor":o.envMap=i.getTexture(t,e.ID),void 0!==o.envMap&&(o.envMap.mapping=_,o.envMap.encoding=A);break;case"SpecularColor":o.specularMap=i.getTexture(t,e.ID),void 0!==o.specularMap&&(o.specularMap.encoding=A);break;case"TransparentColor":case"TransparencyFactor":o.alphaMap=i.getTexture(t,e.ID),o.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),o}getTexture(e,t){return"LayeredTexture"in No.Objects&&t in No.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Yo.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in No.Objects){const n=No.Objects.Deformer;for(const o in n){const i=n[o],s=Yo.get(parseInt(o));if("Skin"===i.attrType){const t=this.parseSkeleton(s,n);t.ID=o,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=s.parents[0].ID,e[o]=t}else if("BlendShape"===i.attrType){const e={id:o};e.rawTargets=this.parseMorphTargets(s,n),e.id=o,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[o]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const o=t[e.ID];if("Cluster"!==o.attrType)return;const i={ID:e.ID,indices:[],weights:[],transformLink:(new p).fromArray(o.TransformLink.a)};"Indexes"in o&&(i.indices=o.Indexes.a,i.weights=o.Weights.a),n.push(i)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let o=0;o<e.children.length;o++){const i=e.children[o],s=t[i.ID],r={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;r.geoID=Yo.get(parseInt(i.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(r)}return n}parseScene(e,t,n){Uo=new d;const o=this.parseModels(e.skeletons,t,n),i=No.Objects.Model,s=this;o.forEach((function(e){const t=i[e.ID];s.setLookAtProperties(e,t);Yo.get(e.ID).parents.forEach((function(t){const n=o.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&Uo.add(e)})),this.bindSkeleton(e.skeletons,t,o),this.createAmbientLight(),Uo.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=ti(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const r=(new Go).parse();1===Uo.children.length&&Uo.children[0].isGroup&&(Uo.children[0].animations=r,Uo=Uo.children[0]),Uo.animations=r}parseModels(e,t,n){const o=new Map,i=No.Objects.Model;for(const s in i){const r=parseInt(s),a=i[s],l=Yo.get(r);let c=this.buildSkeleton(l,e,r,a.attrName);if(!c){switch(a.attrType){case"Camera":c=this.createCamera(l);break;case"Light":c=this.createLight(l);break;case"Mesh":c=this.createMesh(l,t,n);break;case"NurbsCurve":c=this.createCurve(l,t);break;case"LimbNode":case"Root":c=new E;break;default:c=new d}c.name=a.attrName?I.sanitizeNodeName(a.attrName):"",c.ID=r}this.getTransformData(c,a),o.set(r,c)}return o}buildSkeleton(e,t,n,o){let i=null;return e.parents.forEach((function(e){for(const s in t){const r=t[s];r.rawBones.forEach((function(t,s){if(t.ID===e.ID){const e=i;i=new E,i.matrixWorld.copy(t.transformLink),i.name=o?I.sanitizeNodeName(o):"",i.ID=n,r.bones[s]=i,null!==e&&i.add(e)}}))}})),i}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=No.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new C;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let o=1;void 0!==n.NearPlane&&(o=n.NearPlane.value/1e3);let i=1e3;void 0!==n.FarPlane&&(i=n.FarPlane.value/1e3);let s=window.innerWidth,r=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(s=n.AspectWidth.value,r=n.AspectHeight.value);const a=s/r;let l=45;void 0!==n.FieldOfView&&(l=n.FieldOfView.value);const c=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new k(l,a,o,i),null!==c&&t.setFocalLength(c);break;case 1:t=new R(-s/2,s/2,r/2,-r/2,o,i);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new C}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=No.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new C;else{let e;e=void 0===n.LightType?0:n.LightType.value;let o=16777215;void 0!==n.Color&&(o=(new P).fromArray(n.Color.value));let i=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(i=0);let s=0;void 0!==n.FarAttenuationEnd&&(s=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const r=1;switch(e){case 0:t=new L(o,i,s,r);break;case 1:t=new z(o,i);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=D.degToRad(n.InnerAngle.value));let a=0;void 0!==n.OuterAngle&&(a=D.degToRad(n.OuterAngle.value),a=Math.max(a,1)),t=new O(o,i,s,e,a,r);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new L(o,i)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let o,i=null,s=null;const r=[];return e.children.forEach((function(e){t.has(e.ID)&&(i=t.get(e.ID)),n.has(e.ID)&&r.push(n.get(e.ID))})),r.length>1?s=r:r.length>0?s=r[0]:(s=new T({color:13421772}),r.push(s)),"color"in i.attributes&&r.forEach((function(e){e.vertexColors=!0})),i.FBX_Deformer?(o=new F(i,s),o.normalizeSkinWeights()):o=new a(i,s),o}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),o=new N({color:3342591,linewidth:1});return new Y(n,o)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?ni(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){if("LookAtProperty"in t){Yo.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=No.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),Uo.add(e.target)):e.lookAt((new i).fromArray(t))}}}))}}bindSkeleton(e,t,n){const o=this.parsePoseNodes();for(const i in e){const s=e[i];Yo.get(parseInt(s.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;Yo.get(t).parents.forEach((function(e){if(n.has(e.ID)){n.get(e.ID).bind(new U(s.bones),o[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in No.Objects){const t=No.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const o=t[n].PoseNode;Array.isArray(o)?o.forEach((function(t){e[t.Node]=(new p).fromArray(t.Matrix.a)})):e[o.Node]=(new p).fromArray(o.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in No&&"AmbientColor"in No.GlobalSettings){const e=No.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],o=e[2];if(0!==t||0!==n||0!==o){const e=new P(t,n,o);Uo.add(new j(e,1))}}}}class Bo{parse(e){const t=new Map;if("Geometry"in No.Objects){const n=No.Objects.Geometry;for(const o in n){const i=Yo.get(parseInt(o)),s=this.parseGeometry(i,n[o],e);t.set(parseInt(o),s)}}return t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const o=n.skeletons,i=[],s=e.parents.map((function(e){return No.Objects.Model[e.ID]}));if(0===s.length)return;const r=e.children.reduce((function(e,t){return void 0!==o[t.ID]&&(e=o[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&i.push(n.morphTargets[e.ID])}));const a=s[0],l={};"RotationOrder"in a&&(l.eulerOrder=ni(a.RotationOrder.value)),"InheritType"in a&&(l.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(l.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(l.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(l.scale=a.GeometricScaling.value);const c=ti(l);return this.genGeometry(t,r,i,c)}genGeometry(e,t,n,o){const i=new H;e.attrName&&(i.name=e.attrName);const s=this.parseGeoNode(e,t),r=this.genBuffers(s),a=new B(r.vertex,3);if(a.applyMatrix4(o),i.setAttribute("position",a),r.colors.length>0&&i.setAttribute("color",new B(r.colors,3)),t&&(i.setAttribute("skinIndex",new G(r.weightsIndices,4)),i.setAttribute("skinWeight",new B(r.vertexWeights,4)),i.FBX_Deformer=t),r.normal.length>0){const e=(new J).getNormalMatrix(o),t=new B(r.normal,3);t.applyNormalMatrix(e),i.setAttribute("normal",t)}if(r.uvs.forEach((function(e,t){let n="uv"+(t+1).toString();0===t&&(n="uv"),i.setAttribute(n,new B(r.uvs[t],2))})),s.material&&"AllSame"!==s.material.mappingType){let e=r.materialIndex[0],t=0;if(r.materialIndex.forEach((function(n,o){n!==e&&(i.addGroup(t,o-t,e),e=n,t=o)})),i.groups.length>0){const t=i.groups[i.groups.length-1],n=t.start+t.count;n!==r.materialIndex.length&&i.addGroup(n,r.materialIndex.length-n,e)}0===i.groups.length&&i.addGroup(0,r.materialIndex.length,r.materialIndex[0])}return this.addMorphTargets(i,e,n,o),i}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(o,i){void 0===n.weightTable[o]&&(n.weightTable[o]=[]),n.weightTable[o].push({id:t,weight:e.weights[i]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,o=0,i=!1,s=[],r=[],a=[],l=[],c=[],u=[];const h=this;return e.vertexIndices.forEach((function(d,p){let f,m=!1;d<0&&(d^=-1,m=!0);let g=[],y=[];if(s.push(3*d,3*d+1,3*d+2),e.color){const t=Qo(p,n,d,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){i||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),i=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(n,o){let i=n,s=g[o];t.forEach((function(t,n,o){if(i>t){o[n]=i,i=t;const r=e[n];e[n]=s,s=r}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)c.push(y[e]),u.push(g[e])}if(e.normal){const t=Qo(p,n,d,e.normal);r.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(f=Qo(p,n,d,e.material)[0]),e.uv&&e.uv.forEach((function(e,t){const o=Qo(p,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(o[0]),l[t].push(o[1])})),o++,m&&(h.genFace(t,e,s,f,r,a,l,c,u,o),n++,o=0,s=[],r=[],a=[],l=[],c=[],u=[])})),t}genFace(e,t,n,o,i,s,r,a,l,c){for(let u=2;u<c;u++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(u-1)]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+2]]),e.vertex.push(t.vertexPositions[n[3*u]]),e.vertex.push(t.vertexPositions[n[3*u+1]]),e.vertex.push(t.vertexPositions[n[3*u+2]]),t.skeleton&&(e.vertexWeights.push(a[0]),e.vertexWeights.push(a[1]),e.vertexWeights.push(a[2]),e.vertexWeights.push(a[3]),e.vertexWeights.push(a[4*(u-1)]),e.vertexWeights.push(a[4*(u-1)+1]),e.vertexWeights.push(a[4*(u-1)+2]),e.vertexWeights.push(a[4*(u-1)+3]),e.vertexWeights.push(a[4*u]),e.vertexWeights.push(a[4*u+1]),e.vertexWeights.push(a[4*u+2]),e.vertexWeights.push(a[4*u+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(u-1)]),e.weightsIndices.push(l[4*(u-1)+1]),e.weightsIndices.push(l[4*(u-1)+2]),e.weightsIndices.push(l[4*(u-1)+3]),e.weightsIndices.push(l[4*u]),e.weightsIndices.push(l[4*u+1]),e.weightsIndices.push(l[4*u+2]),e.weightsIndices.push(l[4*u+3])),t.color&&(e.colors.push(s[0]),e.colors.push(s[1]),e.colors.push(s[2]),e.colors.push(s[3*(u-1)]),e.colors.push(s[3*(u-1)+1]),e.colors.push(s[3*(u-1)+2]),e.colors.push(s[3*u]),e.colors.push(s[3*u+1]),e.colors.push(s[3*u+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(o),e.materialIndex.push(o),e.materialIndex.push(o)),t.normal&&(e.normal.push(i[0]),e.normal.push(i[1]),e.normal.push(i[2]),e.normal.push(i[3*(u-1)]),e.normal.push(i[3*(u-1)+1]),e.normal.push(i[3*(u-1)+2]),e.normal.push(i[3*u]),e.normal.push(i[3*u+1]),e.normal.push(i[3*u+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(r[n][0]),e.uvs[n].push(r[n][1]),e.uvs[n].push(r[n][2*(u-1)]),e.uvs[n].push(r[n][2*(u-1)+1]),e.uvs[n].push(r[n][2*u]),e.uvs[n].push(r[n][2*u+1])}))}addMorphTargets(e,t,n,o){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const i=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const s=No.Objects.Geometry[n.geoID];void 0!==s&&i.genMorphGeometry(e,t,s,o,n.name)}))}))}genMorphGeometry(e,t,n,o,i){const s=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],r=void 0!==n.Vertices?n.Vertices.a:[],a=void 0!==n.Indexes?n.Indexes.a:[],l=3*e.attributes.position.count,c=new Float32Array(l);for(let e=0;e<a.length;e++){const t=3*a[e];c[t]=r[3*e],c[t+1]=r[3*e+1],c[t+2]=r[3*e+2]}const u={vertexIndices:s,vertexPositions:c},h=this.genBuffers(u),d=new B(h.vertex,3);d.name=i||n.attrName,d.applyMatrix4(o),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.Normals.a;let i=[];return"IndexToDirect"===n&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a)),{dataSize:3,buffer:o,indices:i,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.UV.a;let i=[];return"IndexToDirect"===n&&(i=e.UVIndex.a),{dataSize:2,buffer:o,indices:i,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.Colors.a;let i=[];return"IndexToDirect"===n&&(i=e.ColorIndex.a),{dataSize:4,buffer:o,indices:i,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const o=e.Materials.a,i=[];for(let e=0;e<o.length;++e)i.push(e);return{dataSize:1,buffer:o,indices:i,mappingType:t,referenceType:n}}parseNurbsGeometry(e){if(void 0===Fo)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new H;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new H;const n=t-1,o=e.KnotVector.a,i=[],s=e.Points.a;for(let e=0,t=s.length;e<t;e+=4)i.push((new g).fromArray(s,e));let r,a;if("Closed"===e.Form)i.push(i[0]);else if("Periodic"===e.Form){r=n,a=o.length-1-r;for(let e=0;e<n;++e)i.push(i[e])}const l=new Fo(n,o,i,r,a).getPoints(12*i.length);return(new H).setFromPoints(l)}}class Go{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const o=t[n],i=this.addClip(o);e.push(i)}return e}parseClips(){if(void 0===No.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=No.Objects.AnimationCurveNode,t=new Map;for(const n in e){const o=e[n];if(null!==o.attrName.match(/S|R|T|DeformPercent/)){const e={id:o.id,attr:o.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=No.Objects.AnimationCurve;for(const n in t){const o={id:t[n].id,times:t[n].KeyTime.a.map(qo),values:t[n].KeyValueFloat.a},i=Yo.get(o.id);if(void 0!==i){const t=i.parents[0].ID,n=i.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=o:n.match(/Y/)?e.get(t).curves.y=o:n.match(/Z/)?e.get(t).curves.z=o:n.match(/d|DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=o)}}}parseAnimationLayers(e){const t=No.Objects.AnimationLayer,n=new Map;for(const o in t){const t=[],i=Yo.get(parseInt(o));if(void 0!==i){i.children.forEach((function(n,o){if(e.has(n.ID)){const i=e.get(n.ID);if(void 0!==i.curves.x||void 0!==i.curves.y||void 0!==i.curves.z){if(void 0===t[o]){const e=Yo.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const i=No.Objects.Model[e.toString()];if(void 0===i)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const s={modelName:i.attrName?I.sanitizeNodeName(i.attrName):"",ID:i.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Uo.traverse((function(e){e.ID===i.id&&(s.transform=e.matrix,e.userData.transformData&&(s.eulerOrder=e.userData.transformData.eulerOrder))})),s.transform||(s.transform=new p),"PreRotation"in i&&(s.preRotation=i.PreRotation.value),"PostRotation"in i&&(s.postRotation=i.PostRotation.value),t[o]=s}}t[o]&&(t[o][i.attr]=i)}else if(void 0!==i.curves.morph){if(void 0===t[o]){const e=Yo.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,i=Yo.get(e).parents[0].ID,s=Yo.get(i).parents[0].ID,r=Yo.get(s).parents[0].ID,a=No.Objects.Model[r],l={modelName:a.attrName?I.sanitizeNodeName(a.attrName):"",morphName:No.Objects.Deformer[e].attrName};t[o]=l}t[o][i.attr]=i}}})),n.set(parseInt(o),t)}}return n}parseAnimStacks(e){const t=No.Objects.AnimationStack,n={};for(const o in t){const i=Yo.get(parseInt(o)).children;i.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const s=e.get(i[0].ID);n[o]={name:t[o].attrName,layer:s}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new X(e.name,-1,t)}generateTracks(e){const t=[];let n=new i,o=new c,s=new i;if(e.transform&&e.transform.decompose(n,o,s),n=n.toArray(),o=(new V).setFromQuaternion(o,e.eulerOrder).toArray(),s=s.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==o&&t.push(o)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,o,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,o){const i=this.getTimesForAllAxes(t),s=this.getKeyframeTrackValues(i,t,n);return new W(e+"."+o,i,s)}generateRotationTrack(e,t,n,o,i,s){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(D.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(D.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(D.degToRad));const r=this.getTimesForAllAxes(t),a=this.getKeyframeTrackValues(r,t,n);void 0!==o&&((o=o.map(D.degToRad)).push(s),o=(new V).fromArray(o),o=(new c).setFromEuler(o)),void 0!==i&&((i=i.map(D.degToRad)).push(s),i=(new V).fromArray(i),i=(new c).setFromEuler(i).invert());const l=new c,u=new V,h=[];for(let e=0;e<a.length;e+=3)u.set(a[e],a[e+1],a[e+2],s),l.setFromEuler(u),void 0!==o&&l.premultiply(o),void 0!==i&&l.multiply(i),l.toArray(h,e/3*4);return new K(e+".quaternion",r,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),o=Uo.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new q(e.modelName+".morphTargetInfluences["+o+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let o=1;o<t.length;o++){const i=t[o];i!==n&&(t[e]=i,n=i,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const o=n,i=[];let s=-1,r=-1,a=-1;return e.forEach((function(e){if(t.x&&(s=t.x.times.indexOf(e)),t.y&&(r=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==s){const e=t.x.values[s];i.push(e),o[0]=e}else i.push(o[0]);if(-1!==r){const e=t.y.values[r];i.push(e),o[1]=e}else i.push(o[1]);if(-1!==a){const e=t.z.values[a];i.push(e),o[2]=e}else i.push(o[2])})),i}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],o=e.values[t]-n,i=Math.abs(o);if(i>=180){const s=i/180,r=o/s;let a=n+r;const l=e.times[t-1],c=(e.times[t]-l)/s;let u=l+c;const h=[],d=[];for(;u<e.times[t];)h.push(u),u+=c,d.push(a),a+=r;e.times=si(e.times,t,h),e.values=si(e.values,t,d)}}}}class Jo{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new Wo,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,o){const i=e.match(/^[\s\t]*;/),s=e.match(/^[\s\t]*$/);if(i||s)return;const r=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");r?t.parseNodeBegin(e,r):a?t.parseNodeProperty(e,a,n[++o]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),o=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),i={name:n},s=this.parseNodeAttr(o),r=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,i):n in r?("PoseNode"===n?r.PoseNode.push(i):void 0!==r[n].id&&(r[n]={},r[n][r[n].id]=r[n]),""!==s.id&&(r[n][s.id]=i)):"number"==typeof s.id?(r[n]={},r[n][s.id]=i):"Properties70"!==n&&(r[n]="PoseNode"===n?[i]:i),"number"==typeof s.id&&(i.id=s.id),""!==s.name&&(i.attrName=s.name),""!==s.type&&(i.attrType=s.type),this.pushStack(i)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",o="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),o=e[2]),{id:t,name:n,type:o}}parseNodeProperty(e,t,n){let o=t[1].replace(/^"/,"").replace(/"$/,"").trim(),i=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===o&&","===i&&(i=n.replace(/"/g,"").replace(/,$/,"").trim());const s=this.getCurrentNode();if("Properties70"!==s.name){if("C"===o){const e=i.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let r=i.split(",").slice(3);r=r.map((function(e){return e.trim().replace(/^"/,"")})),o="connections",i=[t,n],function(e,t){for(let n=0,o=e.length,i=t.length;n<i;n++,o++)e[o]=t[n]}(i,r),void 0===s[o]&&(s[o]=[])}"Node"===o&&(s.id=i),o in s&&Array.isArray(s[o])?s[o].push(i):"a"!==o?s[o]=i:s.a=i,this.setCurrentProp(s,o),"a"===o&&","!==i.slice(-1)&&(s.a=oi(i))}else this.parseNodeSpecialProperty(e,o,i)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=oi(t.a))}parseNodeSpecialProperty(e,t,n){const o=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),i=o[0],s=o[1],r=o[2],a=o[3];let l=o[4];switch(s){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=oi(l)}this.getPrevNode()[i]={type:s,type2:r,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),i)}}class Xo{parse(e){const t=new Vo(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const o=new Wo;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&o.add(e.name,e)}return o}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},o=t>=7500?e.getUint64():e.getUint32(),i=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const s=e.getUint8(),r=e.getString(s);if(0===o)return null;const a=[];for(let t=0;t<i;t++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",u=a.length>2?a[2]:"";for(n.singleProperty=1===i&&e.getOffset()===o;o>e.getOffset();){const o=this.parseNode(e,t);null!==o&&this.parseSubNode(r,n,o)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==u&&(n.attrType=u),""!==r&&(n.name=r),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],o=n.propertyList[1];const i=n.propertyList[2],s=n.propertyList[3];let r;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===o.indexOf("Lcl ")&&(o=o.replace("Lcl ","Lcl_")),r="Color"===o||"ColorRGB"===o||"Vector"===o||"Vector3D"===o||0===o.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:o,type2:i,flag:s,value:r}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const o=e.getUint32(),i=e.getUint32(),s=e.getUint32();if(0===i)switch(t){case"b":case"c":return e.getBooleanArray(o);case"d":return e.getFloat64Array(o);case"f":return e.getFloat32Array(o);case"i":return e.getInt32Array(o);case"l":return e.getInt64Array(o)}void 0===Lo&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const r=so(new Uint8Array(e.getArrayBuffer(s))),a=new Vo(r.buffer);switch(t){case"b":case"c":return a.getBooleanArray(o);case"d":return a.getFloat64Array(o);case"f":return a.getFloat32Array(o);case"i":return a.getInt32Array(o);case"l":return a.getInt64Array(o)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Vo{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let n=0;n<e;n++)t[n]=this.getUint8();const n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),w.decodeText(new Uint8Array(t))}}class Wo{add(e,t){this[e]=t}}function Ko(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function qo(e){return e/46186158e3}const Zo=[];function Qo(e,t,n,o){let i;switch(o.mappingType){case"ByPolygonVertex":i=e;break;case"ByPolygon":i=t;break;case"ByVertice":i=n;break;case"AllSame":i=o.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+o.mappingType)}"IndexToDirect"===o.referenceType&&(i=o.indices[i]);const s=i*o.dataSize,r=s+o.dataSize;return function(e,t,n,o){for(let i=n,s=0;i<o;i++,s++)e[s]=t[i];return e}(Zo,o.buffer,s,r)}const $o=new V,ei=new i;function ti(e){const t=new p,n=new p,o=new p,s=new p,r=new p,a=new p,l=new p,c=new p,u=new p,h=new p,d=new p,f=new p,m=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(ei.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(D.degToRad);t.push(e.eulerOrder),n.makeRotationFromEuler($o.fromArray(t))}if(e.rotation){const t=e.rotation.map(D.degToRad);t.push(e.eulerOrder),o.makeRotationFromEuler($o.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(D.degToRad);t.push(e.eulerOrder),s.makeRotationFromEuler($o.fromArray(t)),s.invert()}e.scale&&r.scale(ei.fromArray(e.scale)),e.scalingOffset&&l.setPosition(ei.fromArray(e.scalingOffset)),e.scalingPivot&&a.setPosition(ei.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(ei.fromArray(e.rotationOffset)),e.rotationPivot&&u.setPosition(ei.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),h.copy(e.parentMatrixWorld));const g=n.clone().multiply(o).multiply(s),y=new p;y.extractRotation(h);const v=new p;v.copyPosition(h);const w=v.clone().invert().multiply(h),x=y.clone().invert().multiply(w),b=r,M=new p;if(0===m)M.copy(y).multiply(g).multiply(x).multiply(b);else if(1===m)M.copy(y).multiply(x).multiply(g).multiply(b);else{const e=(new p).scale((new i).setFromMatrixScale(d)).clone().invert(),t=x.clone().multiply(e);M.copy(y).multiply(g).multiply(t).multiply(b)}const S=u.clone().invert(),T=a.clone().invert();let P=t.clone().multiply(c).multiply(u).multiply(n).multiply(o).multiply(s).multiply(S).multiply(l).multiply(a).multiply(r).multiply(T);const A=(new p).copyPosition(P),_=h.clone().multiply(A);return f.copyPosition(_),P=f.clone().multiply(M),P.premultiply(h.invert()),P}function ni(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function oi(e){return e.split(",").map((function(e){return parseFloat(e)}))}function ii(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),w.decodeText(new Uint8Array(e,t,n))}function si(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}class ri extends v{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new di(e)})),this.register((function(e){return new wi(e)})),this.register((function(e){return new xi(e)})),this.register((function(e){return new fi(e)})),this.register((function(e){return new mi(e)})),this.register((function(e){return new gi(e)})),this.register((function(e){return new yi(e)})),this.register((function(e){return new hi(e)})),this.register((function(e){return new vi(e)})),this.register((function(e){return new pi(e)})),this.register((function(e){return new ci(e)})),this.register((function(e){return new bi(e)}))}load(e,t,n,o){const i=this;let s;s=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:w.extractUrlBase(e),this.manager.itemStart(e);const r=function(t){o?o(t):console.error(t),i.manager.itemError(e),i.manager.itemEnd(e)},a=new x(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(n){try{i.parse(n,s,(function(n){t(n),i.manager.itemEnd(e)}),r)}catch(e){r(e)}}),n,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,o){let i;const s={},r={};if("string"==typeof e)i=e;else{if(w.decodeText(new Uint8Array(e,0,4))===Mi){try{s[li.KHR_BINARY_GLTF]=new Pi(e)}catch(e){return void(o&&o(e))}i=s[li.KHR_BINARY_GLTF].content}else i=w.decodeText(new Uint8Array(e))}const a=JSON.parse(i);if(void 0===a.asset||a.asset.version[0]<2)return void(o&&o(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new os(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);r[t.name]=t,s[t.name]=!0}if(a.extensionsUsed)for(let e=0;e<a.extensionsUsed.length;++e){const t=a.extensionsUsed[e],n=a.extensionsRequired||[];switch(t){case li.KHR_MATERIALS_UNLIT:s[t]=new ui;break;case li.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:s[t]=new Ii;break;case li.KHR_DRACO_MESH_COMPRESSION:s[t]=new Ai(a,this.dracoLoader);break;case li.KHR_TEXTURE_TRANSFORM:s[t]=new _i;break;case li.KHR_MESH_QUANTIZATION:s[t]=new Ci;break;default:n.indexOf(t)>=0&&void 0===r[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(s),l.setPlugins(r),l.parse(n,o)}parseAsync(e,t){const n=this;return new Promise((function(o,i){n.parse(e,t,o,i)}))}}function ai(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const li={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class ci{constructor(e){this.parser=e,this.name=li.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,o=t.length;n<o;n++){const o=t[n];o.extensions&&o.extensions[this.name]&&void 0!==o.extensions[this.name].light&&e._addNodeRef(this.cache,o.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let o=t.cache.get(n);if(o)return o;const i=t.json,s=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let r;const a=new P(16777215);void 0!==s.color&&a.fromArray(s.color);const l=void 0!==s.range?s.range:0;switch(s.type){case"directional":r=new z(a),r.target.position.set(0,0,-1),r.add(r.target);break;case"point":r=new L(a),r.distance=l;break;case"spot":r=new O(a),r.distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,r.angle=s.spot.outerConeAngle,r.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return r.position.set(0,0,0),r.decay=2,void 0!==s.intensity&&(r.intensity=s.intensity),r.name=t.createUniqueName(s.name||"light_"+e),o=Promise.resolve(r),t.cache.add(n,o),o}createNodeAttachment(e){const t=this,n=this.parser,o=n.json.nodes[e],i=(o.extensions&&o.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return n._getNodeRef(t.cache,i,e)}))}}class ui{constructor(){this.name=li.KHR_MATERIALS_UNLIT}getMaterialType(){return r}extendParams(e,t,n){const o=[];e.color=new P(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==i.baseColorTexture&&o.push(n.assignTexture(e,"map",i.baseColorTexture,A))}return Promise.all(o)}}class hi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=n.extensions[this.name].emissiveStrength;return void 0!==o&&(t.emissiveIntensity=o),Promise.resolve()}}class di{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const o=this.parser,i=o.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=[],r=i.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&s.push(o.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&s.push(o.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(s.push(o.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new n(e,e)}return Promise.all(s)}}class pi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],s=o.extensions[this.name];return void 0!==s.iridescenceFactor&&(t.iridescence=s.iridescenceFactor),void 0!==s.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",s.iridescenceTexture)),void 0!==s.iridescenceIor&&(t.iridescenceIOR=s.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==s.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),void 0!==s.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),void 0!==s.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(i)}}class fi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new P(0,0,0),t.sheenRoughness=0,t.sheen=1;const s=o.extensions[this.name];return void 0!==s.sheenColorFactor&&t.sheenColor.fromArray(s.sheenColorFactor),void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&i.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,A)),void 0!==s.sheenRoughnessTexture&&i.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(i)}}class mi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],s=o.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(i)}}class gi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],s=o.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&i.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||0;const r=s.attenuationColor||[1,1,1];return t.attenuationColor=new P(r[0],r[1],r[2]),Promise.all(i)}}class yi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=n.extensions[this.name];return t.ior=void 0!==o.ior?o.ior:1.5,Promise.resolve()}}class vi{constructor(e){this.parser=e,this.name=li.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Z:null}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],s=o.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&i.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));const r=s.specularColorFactor||[1,1,1];return t.specularColor=new P(r[0],r[1],r[2]),void 0!==s.specularColorTexture&&i.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,A)),Promise.all(i)}}class wi{constructor(e){this.parser=e,this.name=li.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,o=n.textures[e];if(!o.extensions||!o.extensions[this.name])return null;const i=o.extensions[this.name],s=t.options.ktx2Loader;if(!s){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,s)}}class xi{constructor(e){this.parser=e,this.name=li.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,o=n.json,i=o.textures[e];if(!i.extensions||!i.extensions[t])return null;const s=i.extensions[t],r=o.images[s.source];let a=n.textureLoader;if(r.uri){const e=n.options.manager.getHandler(r.uri);null!==e&&(a=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,s.source,a);if(o.extensionsRequired&&o.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class bi{constructor(e){this.name=li.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],o=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([o,i.ready]).then((function(t){const n=e.byteOffset||0,o=e.byteLength||0,s=e.count,r=e.byteStride,a=new ArrayBuffer(s*r),l=new Uint8Array(t[0],n,o);return i.decodeGltfBuffer(new Uint8Array(a),s,r,l,e.mode,e.filter),a}))}return null}}const Mi="glTF",Si=1313821514,Ti=5130562;class Pi{constructor(e){this.name=li.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:w.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Mi)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,o=new DataView(e,12);let i=0;for(;i<n;){const t=o.getUint32(i,!0);i+=4;const n=o.getUint32(i,!0);if(i+=4,n===Si){const n=new Uint8Array(e,12+i,t);this.content=w.decodeText(n)}else if(n===Ti){const n=12+i;this.body=e.slice(n,n+t)}i+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ai{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=li.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,o=this.dracoLoader,i=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,r={},a={},l={};for(const e in s){const t=Ji[e]||e.toLowerCase();r[t]=s[e]}for(const t in e.attributes){const o=Ji[t]||t.toLowerCase();if(void 0!==s[t]){const i=n.accessors[e.attributes[t]],s=ji[i.componentType];l[o]=s,a[o]=!0===i.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){o.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],o=a[t];void 0!==o&&(n.normalized=o)}t(e)}),r,l)}))}))}}class _i{constructor(){this.name=li.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ei extends re{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),n=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),o=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),s=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),r={specular:{value:(new P).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=r,this.onBeforeCompile=function(e){for(const t in r)e.uniforms[t]=r[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",n).replace("#include <roughnessmap_fragment>",o).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",s)},Object.defineProperties(this,{specular:{get:function(){return r.specular.value},set:function(e){r.specular.value=e}},specularMap:{get:function(){return r.specularMap.value},set:function(e){r.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return r.glossiness.value},set:function(e){r.glossiness.value=e}},glossinessMap:{get:function(){return r.glossinessMap.value},set:function(e){r.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Ii{constructor(){this.name=li.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity"]}getMaterialType(){return Ei}extendParams(e,t,n){const o=t.extensions[this.name];e.color=new P(1,1,1),e.opacity=1;const i=[];if(Array.isArray(o.diffuseFactor)){const t=o.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==o.diffuseTexture&&i.push(n.assignTexture(e,"map",o.diffuseTexture,A)),e.emissive=new P(0,0,0),e.glossiness=void 0!==o.glossinessFactor?o.glossinessFactor:1,e.specular=new P(1,1,1),Array.isArray(o.specularFactor)&&e.specular.fromArray(o.specularFactor),void 0!==o.specularGlossinessTexture){const t=o.specularGlossinessTexture;i.push(n.assignTexture(e,"glossinessMap",t)),i.push(n.assignTexture(e,"specularMap",t,A))}return Promise.all(i)}createMaterial(e){const t=new Ei(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=void 0===e.emissiveIntensity?1:e.emissiveIntensity,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=Q,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t}}class Ci{constructor(){this.name=li.KHR_MESH_QUANTIZATION}}class Ri extends Se{constructor(e,t,n,o){super(e,t,n,o)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,o=this.valueSize,i=e*o*3+o;for(let e=0;e!==o;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,o){const i=this.resultBuffer,s=this.sampleValues,r=this.valueSize,a=2*r,l=3*r,c=o-t,u=(n-t)/c,h=u*u,d=h*u,p=e*l,f=p-l,m=-2*d+3*h,g=d-h,y=1-m,v=g-h+u;for(let e=0;e!==r;e++){const t=s[f+e+r],n=s[f+e+a]*c,o=s[p+e+r],l=s[p+e]*c;i[e]=y*t+v*n+m*o+g*l}return i}}const ki=new c;class Li extends Ri{interpolate_(e,t,n,o){const i=super.interpolate_(e,t,n,o);return ki.fromArray(i).normalize().toArray(i),i}}const Di=0,Oi=1,zi=2,Fi=3,Ni=4,Yi=5,Ui=6,ji={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Hi={9728:de,9729:ne,9984:pe,9985:fe,9986:me,9987:oe},Bi={33071:S,33648:ge,10497:M},Gi={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ji={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Xi={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Vi={CUBICSPLINE:void 0,LINEAR:ue,STEP:ye},Wi="OPAQUE",Ki="MASK",qi="BLEND";function Zi(e,t,n){for(const o in n.extensions)void 0===e[o]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[o]=n.extensions[o])}function Qi(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function $i(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,o=t.weights.length;n<o;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,o=n.length;t<o;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function es(e){const t=e.extensions&&e.extensions[li.KHR_DRACO_MESH_COMPRESSION];let n;return n=t?"draco:"+t.bufferView+":"+t.indices+":"+ts(t.attributes):e.indices+":"+ts(e.attributes)+":"+e.mode,n}function ts(e){let t="";const n=Object.keys(e).sort();for(let o=0,i=n.length;o<i;o++)t+=n[o]+":"+e[n[o]]+";";return t}function ns(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class os{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ai,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};const n=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),o=navigator.userAgent.indexOf("Firefox")>-1,i=o?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1;"undefined"==typeof createImageBitmap||n||o&&i<98?this.textureLoader=new b(this.options.manager):this.textureLoader=new $(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new x(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,o=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const s={scene:t[0][o.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:o.asset,parser:n,userData:{}};Zi(i,s,o),Qi(s,o),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(s)}))).then((function(){e(s)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,o=t.length;n<o;n++){const o=t[n].joints;for(let t=0,n=o.length;t<n;t++)e[o[t]].isBone=!0}for(let t=0,o=e.length;t<o;t++){const o=e[t];void 0!==o.mesh&&(this._addNodeRef(this.meshCache,o.mesh),void 0!==o.skin&&(n[o.mesh].isSkinnedMesh=!0)),void 0!==o.camera&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const o=n.clone(),i=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,o]of e.children.entries())i(o,t.children[n])};return i(n,o),o.name+="_instance_"+e.uses[t]++,o}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const o=e(t[n]);if(o)return o}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let o=0;o<t.length;o++){const i=e(t[o]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let o=this.cache.get(n);if(!o){switch(e){case"scene":o=this.loadScene(t);break;case"node":o=this.loadNode(t);break;case"mesh":o=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":o=this.loadAccessor(t);break;case"bufferView":o=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":o=this.loadBuffer(t);break;case"material":o=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":o=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":o=this.loadSkin(t);break;case"animation":o=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":o=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,o)}return o}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,o=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(o.map((function(t,o){return n.getDependency(e,o)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[li.KHR_BINARY_GLTF].body);const o=this.options;return new Promise((function(e,i){n.load(w.resolveURL(t.uri,o.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,o=t.byteOffset||0;return e.slice(o,o+n)}))}loadAccessor(e){const t=this,n=this.json,o=this.json.accessors[e];if(void 0===o.bufferView&&void 0===o.sparse)return Promise.resolve(null);const i=[];return void 0!==o.bufferView?i.push(this.getDependency("bufferView",o.bufferView)):i.push(null),void 0!==o.sparse&&(i.push(this.getDependency("bufferView",o.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",o.sparse.values.bufferView))),Promise.all(i).then((function(e){const i=e[0],s=Gi[o.type],r=ji[o.componentType],a=r.BYTES_PER_ELEMENT,l=a*s,c=o.byteOffset||0,u=void 0!==o.bufferView?n.bufferViews[o.bufferView].byteStride:void 0,h=!0===o.normalized;let d,p;if(u&&u!==l){const e=Math.floor(c/u),n="InterleavedBuffer:"+o.bufferView+":"+o.componentType+":"+e+":"+o.count;let l=t.cache.get(n);l||(d=new r(i,e*u,o.count*u/a),l=new ee(d,u/a),t.cache.add(n,l)),p=new we(l,s,c%u/a,h)}else d=null===i?new r(o.count*s):new r(i,c,o.count*s),p=new te(d,s,h);if(void 0!==o.sparse){const t=Gi.SCALAR,n=ji[o.sparse.indices.componentType],a=o.sparse.indices.byteOffset||0,l=o.sparse.values.byteOffset||0,c=new n(e[1],a,o.sparse.count*t),u=new r(e[2],l,o.sparse.count*s);null!==i&&(p=new te(p.array.slice(),p.itemSize,p.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(p.setX(t,u[e*s]),s>=2&&p.setY(t,u[e*s+1]),s>=3&&p.setZ(t,u[e*s+2]),s>=4&&p.setW(t,u[e*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(e){const t=this.json,n=this.options,o=t.textures[e].source,i=t.images[o];let s=this.textureLoader;if(i.uri){const e=n.manager.getHandler(i.uri);null!==e&&(s=e)}return this.loadTextureImage(e,o,s)}loadTextureImage(e,t,n){const o=this,i=this.json,s=i.textures[e],r=i.images[t],a=(r.uri||r.bufferView)+":"+s.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,n).then((function(t){t.flipY=!1,s.name&&(t.name=s.name);const n=(i.samplers||{})[s.sampler]||{};return t.magFilter=Hi[n.magFilter]||ne,t.minFilter=Hi[n.minFilter]||oe,t.wrapS=Bi[n.wrapS]||M,t.wrapT=Bi[n.wrapT]||M,o.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=l,l}loadImageSource(e,t){const n=this,o=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const s=o.images[e],r=self.URL||self.webkitURL;let a=s.uri||"",l=!1;if(void 0!==s.bufferView)a=n.getDependency("bufferView",s.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:s.mimeType});return a=r.createObjectURL(t),a}));else if(void 0===s.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(a).then((function(e){return new Promise((function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){const t=new f(e);t.needsUpdate=!0,n(t)}),t.load(w.resolveURL(e,i.path),s,void 0,o)}))})).then((function(e){var t;return!0===l&&r.revokeObjectURL(a),e.userData.mimeType=s.mimeType||((t=s.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=c,c}assignTexture(e,t,n,o){const i=this;return this.getDependency("texture",n.index).then((function(s){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),i.extensions[li.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[li.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(s);s=i.extensions[li.KHR_TEXTURE_TRANSFORM].extendTexture(s,e),i.associations.set(s,t)}}return void 0!==o&&(s.encoding=o),e[t]=s,s}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const o=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new ie,se.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new N,se.prototype.copy.call(t,n),t.color.copy(n.color),this.cache.add(e,t)),n=t}if(o||i||s){let e="ClonedMaterial:"+n.uuid+":";n.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),o&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),i&&(t.vertexColors=!0),s&&(t.flatShading=!0),o&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}n.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=n}getMaterialType(){return re}loadMaterial(e){const t=this,o=this.json,i=this.extensions,s=o.materials[e];let a;const l={},c=s.extensions||{},u=[];if(c[li.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=i[li.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=e.getMaterialType(),u.push(e.extendParams(l,s,t))}else if(c[li.KHR_MATERIALS_UNLIT]){const e=i[li.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),u.push(e.extendParams(l,s,t))}else{const n=s.pbrMetallicRoughness||{};if(l.color=new P(1,1,1),l.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;l.color.fromArray(e),l.opacity=e[3]}void 0!==n.baseColorTexture&&u.push(t.assignTexture(l,"map",n.baseColorTexture,A)),l.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,l.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(u.push(t.assignTexture(l,"metalnessMap",n.metallicRoughnessTexture)),u.push(t.assignTexture(l,"roughnessMap",n.metallicRoughnessTexture))),a=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),u.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,l)}))))}!0===s.doubleSided&&(l.side=m);const h=s.alphaMode||Wi;if(h===qi?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,h===Ki&&(l.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&a!==r&&(u.push(t.assignTexture(l,"normalMap",s.normalTexture)),l.normalScale=new n(1,1),void 0!==s.normalTexture.scale)){const e=s.normalTexture.scale;l.normalScale.set(e,e)}return void 0!==s.occlusionTexture&&a!==r&&(u.push(t.assignTexture(l,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(l.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&a!==r&&(l.emissive=(new P).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&a!==r&&u.push(t.assignTexture(l,"emissiveMap",s.emissiveTexture,A)),Promise.all(u).then((function(){let n;return n=a===Ei?i[li.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):new a(l),s.name&&(n.name=s.name),Qi(n,s),t.associations.set(n,{materials:e}),s.extensions&&Zi(i,n,s),n}))}createUniqueName(e){const t=I.sanitizeNodeName(e||"");let n=t;for(let e=1;this.nodeNamesUsed[n];++e)n=t+"_"+e;return this.nodeNamesUsed[n]=!0,n}loadGeometries(e){const t=this,n=this.extensions,o=this.primitiveCache;function i(e){return n[li.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return ss(n,e,t)}))}const s=[];for(let n=0,r=e.length;n<r;n++){const r=e[n],a=es(r),l=o[a];if(l)s.push(l.promise);else{let e;e=r.extensions&&r.extensions[li.KHR_DRACO_MESH_COMPRESSION]?i(r):ss(new H,r,t),o[a]={primitive:r,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){const t=this,n=this.json,o=this.extensions,i=n.meshes[e],s=i.primitives,r=[];for(let e=0,t=s.length;e<t;e++){const t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new re({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ve})),l.DefaultMaterial):this.getDependency("material",s[e].material);r.push(t)}var l;return r.push(t.loadGeometries(s)),Promise.all(r).then((function(n){const r=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){const u=l[n],h=s[n];let d;const p=r[n];if(h.mode===Ni||h.mode===Yi||h.mode===Ui||void 0===h.mode)d=!0===i.isSkinnedMesh?new F(u,p):new a(u,p),!0!==d.isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),h.mode===Yi?d.geometry=rs(d.geometry,xe):h.mode===Ui&&(d.geometry=rs(d.geometry,he));else if(h.mode===Oi)d=new ae(u,p);else if(h.mode===Fi)d=new Y(u,p);else if(h.mode===zi)d=new le(u,p);else{if(h.mode!==Di)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);d=new ce(u,p)}Object.keys(d.geometry.morphAttributes).length>0&&$i(d,i),d.name=t.createUniqueName(i.name||"mesh_"+e),Qi(d,i),h.extensions&&Zi(o,d,h),t.assignFinalMaterial(d),c.push(d)}for(let n=0,o=c.length;n<o;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return c[0];const u=new d;t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u}))}loadCamera(e){let t;const n=this.json.cameras[e],o=n[n.type];if(o)return"perspective"===n.type?t=new k(D.radToDeg(o.yfov),o.aspectRatio||1,o.znear||1,o.zfar||2e6):"orthographic"===n.type&&(t=new R(-o.xmag,o.xmag,o.ymag,-o.ymag,o.znear,o.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),Qi(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(n):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return n.inverseBindMatrices=e,n}))}loadAnimation(e){const t=this.json.animations[e],n=[],o=[],i=[],s=[],r=[];for(let e=0,a=t.channels.length;e<a;e++){const a=t.channels[e],l=t.samplers[a.sampler],c=a.target,u=void 0!==c.node?c.node:c.id,h=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;n.push(this.getDependency("node",u)),o.push(this.getDependency("accessor",h)),i.push(this.getDependency("accessor",d)),s.push(l),r.push(c)}return Promise.all([Promise.all(n),Promise.all(o),Promise.all(i),Promise.all(s),Promise.all(r)]).then((function(n){const o=n[0],i=n[1],s=n[2],r=n[3],a=n[4],l=[];for(let e=0,t=o.length;e<t;e++){const t=o[e],n=i[e],c=s[e],u=r[e],h=a[e];if(void 0===t)continue;let d;switch(t.updateMatrix(),Xi[h.path]){case Xi.weights:d=q;break;case Xi.rotation:d=K;break;default:d=W}const p=t.name?t.name:t.uuid,f=void 0!==u.interpolation?Vi[u.interpolation]:ue,m=[];Xi[h.path]===Xi.weights?t.traverse((function(e){e.morphTargetInfluences&&m.push(e.name?e.name:e.uuid)})):m.push(p);let g=c.array;if(c.normalized){const e=ns(g.constructor),t=new Float32Array(g.length);for(let n=0,o=g.length;n<o;n++)t[n]=g[n]*e;g=t}for(let e=0,t=m.length;e<t;e++){const t=new d(m[e]+"."+Xi[h.path],n.array,g,f);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new(this instanceof K?Li:Ri)(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const c=t.name?t.name:"animation_"+e;return new X(c,void 0,l)}))}createNodeMesh(e){const t=this.json,n=this,o=t.nodes[e];return void 0===o.mesh?null:n.getDependency("mesh",o.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,o.mesh,e);return void 0!==o.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=o.weights.length;t<n;t++)e.morphTargetInfluences[t]=o.weights[t]})),t}))}loadNode(e){const t=this.json,n=this.extensions,o=this,i=t.nodes[e],s=i.name?o.createUniqueName(i.name):"";return function(){const t=[],n=o._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return n&&t.push(n),void 0!==i.camera&&t.push(o.getDependency("camera",i.camera).then((function(e){return o._getNodeRef(o.cameraCache,i.camera,e)}))),o._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let r;if(r=!0===i.isBone?new E:t.length>1?new d:1===t.length?t[0]:new C,r!==t[0])for(let e=0,n=t.length;e<n;e++)r.add(t[e]);if(i.name&&(r.userData.name=i.name,r.name=s),Qi(r,i),i.extensions&&Zi(n,r,i),void 0!==i.matrix){const e=new p;e.fromArray(i.matrix),r.applyMatrix4(e)}else void 0!==i.translation&&r.position.fromArray(i.translation),void 0!==i.rotation&&r.quaternion.fromArray(i.rotation),void 0!==i.scale&&r.scale.fromArray(i.scale);return o.associations.has(r)||o.associations.set(r,{}),o.associations.get(r).nodes=e,r}))}loadScene(e){const t=this.json,n=this.extensions,o=this.json.scenes[e],i=this,s=new d;o.name&&(s.name=i.createUniqueName(o.name)),Qi(s,o),o.extensions&&Zi(n,s,o);const r=o.nodes||[],a=[];for(let e=0,n=r.length;e<n;e++)a.push(is(r[e],s,t,i));return Promise.all(a).then((function(){return i.associations=(e=>{const t=new Map;for(const[e,n]of i.associations)(e instanceof se||e instanceof f)&&t.set(e,n);return e.traverse((e=>{const n=i.associations.get(e);null!=n&&t.set(e,n)})),t})(s),s}))}}function is(e,t,n,o){const i=n.nodes[e];return o.getDependency("node",e).then((function(e){if(void 0===i.skin)return e;let t;return o.getDependency("skin",i.skin).then((function(e){t=e;const n=[];for(let e=0,i=t.joints.length;e<i;e++)n.push(o.getDependency("node",t.joints[e]));return Promise.all(n)})).then((function(n){return e.traverse((function(e){if(!e.isMesh)return;const o=[],i=[];for(let e=0,s=n.length;e<s;e++){const s=n[e];if(s){o.push(s);const n=new p;void 0!==t.inverseBindMatrices&&n.fromArray(t.inverseBindMatrices.array,16*e),i.push(n)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}e.bind(new U(o,i),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const s=[];if(i.children){const t=i.children;for(let i=0,r=t.length;i<r;i++){const r=t[i];s.push(is(r,e,n,o))}}return Promise.all(s)}))}function ss(e,t,n){const o=t.attributes,s=[];function r(t,o){return n.getDependency("accessor",t).then((function(t){e.setAttribute(o,t)}))}for(const t in o){const n=Ji[t]||t.toLowerCase();n in e.attributes||s.push(r(o[t],n))}if(void 0!==t.indices&&!e.index){const o=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));s.push(o)}return Qi(e,t),function(e,t,n){const o=t.attributes,s=new be;if(void 0===o.POSITION)return;{const e=n.json.accessors[o.POSITION],t=e.min,r=e.max;if(void 0===t||void 0===r)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(s.set(new i(t[0],t[1],t[2]),new i(r[0],r[1],r[2])),e.normalized){const t=ns(ji[e.componentType]);s.min.multiplyScalar(t),s.max.multiplyScalar(t)}}const r=t.targets;if(void 0!==r){const e=new i,t=new i;for(let o=0,i=r.length;o<i;o++){const i=r[o];if(void 0!==i.POSITION){const o=n.json.accessors[i.POSITION],s=o.min,r=o.max;if(void 0!==s&&void 0!==r){if(t.setX(Math.max(Math.abs(s[0]),Math.abs(r[0]))),t.setY(Math.max(Math.abs(s[1]),Math.abs(r[1]))),t.setZ(Math.max(Math.abs(s[2]),Math.abs(r[2]))),o.normalized){const e=ns(ji[o.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(e)}e.boundingBox=s;const a=new Me;s.getCenter(a.center),a.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(s).then((function(){return void 0!==t.targets?function(e,t,n){let o=!1,i=!1,s=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(o=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(s=!0),o&&i&&s)break}if(!o&&!i&&!s)return Promise.resolve(e);const r=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){const u=t[c];if(o){const t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;r.push(t)}if(i){const t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(s){const t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(l)]).then((function(t){const n=t[0],r=t[1],a=t[2];return o&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=r),s&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}function rs(e,t){let n=e.getIndex();if(null===n){const t=[],o=e.getAttribute("position");if(void 0===o)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<o.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const o=n.count-2,i=[];if(t===he)for(let e=1;e<=o;e++)i.push(n.getX(0)),i.push(n.getX(e)),i.push(n.getX(e+1));else for(let e=0;e<o;e++)e%2==0?(i.push(n.getX(e)),i.push(n.getX(e+1)),i.push(n.getX(e+2))):(i.push(n.getX(e+2)),i.push(n.getX(e+1)),i.push(n.getX(e)));i.length/3!==o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=e.clone();return s.setIndex(i),s}class as{constructor(e,t,n,o,i,s){var r=new l,c=null;let u,h,p,f,m;var g,y=null,v=null;const w=(e,t)=>{(new jo).load(g,(function(n){(v=n).name="player",v.tag="player",v.traverse((function(e){e instanceof a&&(e.castShadow=!0,e.tag="player",e.owner=i),e instanceof F&&(e.castShadow=!0,e.tag="player",e.owner=i)})),v.position.set(0,0,0),v.rotation.set(0,0,0);let o=.01;v.scale.set(o,o,o),c=new Te(v),b=[];for(let e=0;e<v.animations.length;e++){const t=v.animations[e];b.push({clipAction:t,timeScale:1,clipIndex:e,animName:t.name,connectAnim:"",targetIndex:-1})}null!=e?(M(e),t(v)):t(v)}))},x=(e,t)=>{(new ri).load(g,(function(n){(v=n.scene).name="player",v.tag="player",console.log("加载到的 角色模型",v),v.traverse((function(e){e instanceof a&&(e.castShadow=!0,e.tag="player",e.owner=i),e instanceof F&&(e.castShadow=!0,e.tag="player",e.owner=i)})),v.position.set(0,0,0),v.rotation.set(0,3.14,0),c=new Te(v),b=[];for(let e=0;e<n.animations.length;e++){const t=n.animations[e];b.push({clipAction:t,timeScale:1,clipIndex:e,animName:t.name,connectAnim:"",targetIndex:-1})}null!=e?(M(e),t(v)):t(v)}))};let b=[];function M(e){if(null!=c){for(let t=0;t<e.length;t++){const n=e[t];"idle"!=n.animName?"walk"!=n.animName?"jump"==n.animName&&b.length>=e.length&&(p=c.clipAction(b[n.targetIndex].clipAction),p.timeScale=n.timeScale,m["modify jump scale"]=n.timeScale):(h=c.clipAction(b[n.targetIndex].clipAction),null==n.timeScale?(h.timeScale=1,m["modify walk scale"]=1):(h.timeScale=n.timeScale,m["modify walk scale"]=n.timeScale)):(u=c.clipAction(b[n.targetIndex].clipAction),u.timeScale=n.timeScale,m["modify idle scale"]=n.timeScale)}f=[u,h,p]}}function S(){T(u,m["modify idle weight"],m["modify idle scale"]),T(h,m["modify walk weight"],m["modify walk scale"]),T(p,m["modify jump weight"],m["modify jump scale"]),f.forEach((function(e){null!=e&&(e.reset(),e.play())}))}function T(e,t,n){null!=e&&(e.enabled=!0,e.setEffectiveTimeScale(n),e.setEffectiveWeight(t))}this.GetAnimation=function(){return b},this.ChangeAnimByIndex=function(e,t){for(let e=0;e<b.length;e++)c.clipAction(b[e].clipAction).stop();let n=c.clipAction(b[e].clipAction);n.timeScale=t,n.play()},this.SetActionByIndex=function(e){M(e)},(()=>{m={"show model":!0,"show skeleton":!1,"activate all":S,"modify step size":.05,"from walk to idle":function(){prepareCrossFade(h,u,1)},"from idle to walk":function(){prepareCrossFade(u,h,.5)},"from walk to run":function(){prepareCrossFade(h,p,2.5)},"from run to walk":function(){prepareCrossFade(p,h,5)},"use default duration":!0,"set custom duration":3.5,"modify idle weight":1,"modify idle scale":1,"modify walk weight":0,"modify walk scale":1,"modify jump weight":0,"modify jump scale":1,"modify time scale":1},y=new d,t.add(y);let e="fbx";((g=n).indexOf(".gltf")>-1||g.indexOf(".glb")>-1)&&(e="gltf"),"fbx"==e&&w(o,s),"gltf"==e&&x(o,s)})(),this.ChangeAnim=function(e){"idle"==e&&(m["modify idle weight"]=1,m["modify walk weight"]=0,m["modify jump weight"]=0),"walk"==e&&(m["modify idle weight"]=0,m["modify walk weight"]=.51,m["modify jump weight"]=0),"jump"==e&&(m["modify idle weight"]=0,m["modify walk weight"]=0,m["modify jump weight"]=1),S()},this.SetWalkWeight=function(e){0!=e?h.setEffectiveWeight(e+.4):h.setEffectiveWeight(0)},this.ChangeAvatar=function(e,t,n){let o="fbx";((g=e).indexOf(".gltf")>-1||g.indexOf(".glb")>-1)&&(o="gltf"),"fbx"==o&&w(t,n),"gltf"==o&&x(t,n)},this.DelPlayer=function(){!function(e){const t=e=>{"Mesh"===e.type&&(e.geometry.dispose(),e.material.dispose())},n=e=>{let o=e.children.filter((e=>e));o.forEach((e=>{e.children.length?n(e):(t(e),e.clear())})),e.clear(),o=null};n(e)}(y),t.remove(y),cancelAnimationFrame(P)},function e(){P=requestAnimationFrame(e),null!==c&&c.update(r.getDelta())}();var P=null}}class ls{constructor(e,t,n,o,s,r,l,c,u,p){var f=null;function m(){let n=e._YJSceneManager.checkLoadMesh(o);if(null!=n)return void function(n){console.log(" 已存在mesh ,复用之 ！",c);let o=n.clone();(f=o.children[0]).name=c,f.position.set(s.x,s.y,s.z),f.rotation.set(r.x,r.y,r.z),f.scale.set(l.x,l.y,l.z),t.add(f),c.indexOf("land")>-1&&(f.tag="floor",e.pointsParent.add(f));u&&y();g()}(n);let i=new d;(new ri).load(o,(function(n){(f=n.scene).name=c,f.position.set(s.x,s.y,s.z),f.rotation.set(r.x,r.y,r.z),f.scale.set(l.x,l.y,l.z),i.add(f),t.add(i),e._YJSceneManager.addLoadMesh(o,i.clone()),c.indexOf("land")>-1&&(f.tag="floor",e.pointsParent.add(f)),u&&y(),g()}),void 0,(function(e){console.error(e)}))}function g(){p&&p()}function y(){let t=!1;f.traverse((function(n){n instanceof a&&(n.name.indexOf("collider")>-1?(t=!0,e._YJSceneManager.CreateTriangeMeshCollider(n,n.scale),n.visible=!1):(n.castShadow=!0,n.receiveShadow=!0))})),t||f.traverse((function(t){if(t instanceof a){let n=new i(0,0,0);n.x=t.scale.x*l.x,n.y=t.scale.y*l.y,n.z=t.scale.z*l.z,t.name.indexOf("trigger")>-1||e._YJSceneManager.CreateTriangeMeshCollider(t,n)}}))}this.id=n,this.GetModel=function(){return f},this.SetState=function(e){},function(){let n="fbx";(o.indexOf(".gltf")>-1||o.indexOf(".glb")>-1)&&(n="gltf"),o.indexOf(".json")>-1&&(n="json"),"fbx"==n&&(new jo).load(o,(function(e){(f=e).name=c,f.position.set(s.x,s.y,s.z),f.rotation.set(r.x,r.y,r.z);let n=.01;f.scale.set(n,n,n),t.add(f),u&&(y(),f.name=c),g()})),"gltf"==n&&m(),"json"==n&&function(){const n=new Pe;console.log("正在加载json"),n.load(e.$publicUrl+"models/json/CS15_E_pro_t10_Door_BB.json",(function(e){const n=new h({color:16119285}),o=new a(e,n);t.add(o)}),(function(e){console.log(e.loaded/e.total*100+"% loaded")}),(function(e){console.log("An error happened")}))}()}(),this.ResetSetPosRota=function(e,t){null!=f&&(this.SetPosRota(e,t),this.DestroyCollider(),y())},this.SetPosRota=function(e,t){null!=f&&(f.position.set(e.x,e.y,e.z),null!=t&&f.rotation.set(t.x,t.y,t.z))},this.GetPosRota=function(e){e(f.position,f.rotation)},this.SetDown=function(e,t){y(),f.name=c},this.Destroy=function(){g(),null!=f&&(this.DestroyCollider(),t.remove(f))},this.DestroyCollider=function(){null!=f&&f.traverse((function(t){if(t instanceof a){e._YJSceneManager.RemoveCollider(t),t.geometry.dispose();try{t.material.dispose()}catch(e){}}}))}}}class cs{constructor(e,t,n,o,c){var u=this;new l;var h=null,p=null,f=!1,m=!1,g=null;let y=null,v=null;h=new d,e.pointsParent.add(h),v=new d,h.add(v);var w=0,x=1,M="";let S=null;function T(t){let n=[],o=e.$parent.GetAvatarData(t);return M=o.modelPath,w=o.height,x=o.modelScale,n=o.animationsData,o.flyMount&&(S=new ls(e,v,"id",e.GetPublicUrl()+o.flyMount,new i(0,0,0),new i(0,Math.PI,0),new i(1,1,1),"flyMount",!1,(()=>{S.GetModel().visible=!1}))),n}function P(t,o){y=new as(e,e.scene,e.GetPublicUrl()+t,o,u,(e=>{null!=p&&R(v),p=e,v.add(p),p.position.set(0,0,0);let t=x;p.scale.set(t,t,t),n?c(v,h):console.log("创建角色镜像"),f=!0,m&&(h.position.set(k.x,k.y,k.z),v.rotation.set(0,L+1.57+3.14,0))}))}this.SetFlyMountDisplay=function(e){null!=S&&(S.GetModel().visible=e)},this.LoadPlayer=function(e){let t=T(e);P(M,t)},this.LoadPlayerByCustom=function(e){P(e.modelPath,e.height,e.animationsData)},this.ChangeAvatar=function(t,n){console.log("切换角色11");let o=T(t);y.ChangeAvatar(e.GetPublicUrl()+M,o,(t=>{R(v),p=t,v.add(p),p.position.set(0,0,0),C="idle",I(),n&&(c(),e.YJController.SetTargetHeight(w))}))},this.ChangeAvatarByCustom=function(t,n){console.log("切换角色112222222222"),w=t.height,y.ChangeAvatar(e.GetPublicUrl()+t.modelPath,t.animationsData,(t=>{R(v),p=t,v.add(p),p.position.set(0,0,0),C="idle",I(),n&&(c(),e.YJController.SetTargetHeight(w))}))},this.SetWalkWeight=function(e){y.SetWalkWeight(e)},this.GetAllMesh=function(){let e=[];return p.traverse((function(t){return t instanceof a||t instanceof F?(e.push(t),e):void 0})),e};let A=null;this.CreateVideo=function(e){if(null!=e)if(console.log("用户视频",e),null==A){const t=document.getElementById("video_"+e);let n=.25,o=new Ae(n,n,.01,40,1);const i=new _e(t),s=new r({map:i});A=new a(o,s),A.rotation.y=Math.PI/2,A.rotation.x=Math.PI/2,A.position.set(0,.5,0),A.name="video",g.add(A)}else{const t=document.getElementById("video_"+e);A.material.map=new _e(t)}else null!=A&&(E(A),g.remove(A),A=null)};let _=null;function E(e){e.traverse((function(e){e instanceof a&&(e.geometry.dispose(),e.material.dispose())}))}function I(){g.position.set(0,w+.3,0)}this.CreateAudio=function(t){if(null!=t){if(console.log("用户音频",t),null==_){let t=.2;const n=(new b).load(e.GetPublicUrl()+"images/mico.png");let o=new s(t,t,1,1);const i=new r({map:n,transparent:!0});_=new a(o,i),_.rotation.y=Math.PI+Math.PI,_.position.set(0,.15,0),_.name="audio",g.add(_)}}else null!=_&&(E(_),g.remove(_),_=null)},this.GetPlayerGroup=function(){return h},this.GetPlayerNamePos=function(){return e=g,t=new i,e.getWorldPosition(t),t;var e,t};var C="";function R(e){const t=e=>{let n=e.children.filter((e=>e));n.forEach((e=>{e.children.length?t(e):((e=>{"Mesh"===e.type&&(e.geometry.dispose(),e.material.dispose())})(e),e.clear())})),e.clear(),n=null};t(e)}this.ChangeAnim=function(e){if(f&&C!=e)return null!=y?(y.ChangeAnim(e),void(C=e)):void 0},this.DelPlayer=function(){h.remove(g),R(h),t.remove(h),cancelAnimationFrame(O)};var k=new i(0,0,0),L=0;this.GetHasPlayer=function(){return f};var D=new i;this.SetUserData=function(e){var t=e.pos;if(null==e.pos&&(t=new i(0,0,0)),!f)return k=t,L=e.rotateY,m=!0,void h.position.set(t.x,t.y-0,t.z);this.ChangeAnim(e.animName);var n=new i(t.x,t.y,t.z);D.x==n.x&&D.z==n.z||(h.position.set(t.x,t.y,t.z),D=n),v.rotation.set(0,e.rotateY+1.57+3.14,0)},new i,new i(0,0,0),function e(){if(O=requestAnimationFrame(e),!f)return}();var O=null}}class us{constructor(e,t,n){let o=null;let s="10000-10000-",r=[{x:-1,z:0},{x:1,z:0},{x:-1,z:-1},{x:1,z:-1},{x:0,z:-1},{x:-1,z:1},{x:1,z:1},{x:0,z:1}],a=[],l=[],c=40,u=-10,h=-10,p=20;function f(){var t,o;null!=n&&function(t){let n,o,i;if(n=t.x<0?Math.ceil(t.x/p):Math.floor(t.x/p),i=t.z<0?Math.ceil(t.z/p):Math.floor(t.z/p),n==u&&i==h)return;u=n,h=i,t.x<0?(t.x-=p,n=Math.ceil(t.x/c)+1e4):(t.x+=p,n=Math.floor(t.x/c)+1e4),o=1e4,t.z<0?(t.z-=p,i=Math.ceil(t.z/c)+1e4):(t.z+=p,i=Math.floor(t.z/c)+1e4);let d=n+"-10000-"+i;if(d==s)return;s=d,e._YJSceneManager.SetCenterPlaneId(d);let f=n-1e4,m=i-1e4;l=[],l.push({id:s,x:f*c,y:0,z:m*c});for(let e=0;e<r.length;e++){let t=r[e];const o=f+t.x,s=m+t.z,a=n+t.x,u=i+t.z;l.push({id:a+"-10000-"+u,x:o*c,y:0,z:s*c})}let g=[];for(let e=0;e<a.length;e++){const t=a[e];let n=!1;for(let e=0;e<l.length;e++){const o=l[e];t.id==o.id&&(n=!0)}n||g.push(t)}for(let t=a.length-1;t>=0;t--){const n=a[t];for(let o=g.length-1;o>=0;o--){const i=g[o];n.id!=i.id||(e._YJSceneManager.RemoveAmmoPlane(i.id),g.splice(o,1),a.splice(t,1))}}let y=[];for(let e=0;e<l.length;e++){const t=l[e];let n=!1;for(let e=0;e<a.length;e++){const o=a[e];t.id==o.id&&(n=!0)}n||y.push(t)}for(let t=0;t<y.length;t++){const n=y[t];a.push(n),e._YJSceneManager.AddAmmoPlane(n.id)}e._YJSceneManager.GetPlayerInMap(a),l=[]}((t=n,o=new i,t.getWorldPosition(o),o)),requestAnimationFrame(f)}o=new d,t.add(o),o.position.set(-0,.1,0),f()}}class hs{constructor(e,t,s,r,h,p){const f=new l;new n,new o,new T({color:2105376});let m,g,y,v,w,x,S=new i,P=new c;Ammo().then((function(t){Ammo=t,m=new Ammo.btDefaultCollisionConfiguration,g=new Ammo.btCollisionDispatcher(m),y=new Ammo.btDbvtBroadphase,v=new Ammo.btSequentialImpulseConstraintSolver,w=new Ammo.btDiscreteDynamicsWorld(g,y,v,m),w.setGravity(new Ammo.btVector3(0,-9.8,0)),console.log("初始化 ammo  完成"),x=new Ammo.btTransform,Z=new Ammo.ConcreteContactResultCallback,Z.addSingleResult=function(e,t,n,o,i,s,r){if(Ammo.wrapPointer(e,Ammo.btManifoldPoint).getDistance()>0)return;let a=Ammo.wrapPointer(t,Ammo.btCollisionObjectWrapper),l=Ammo.castObject(a.getCollisionObject(),Ammo.btRigidBody),c=Ammo.wrapPointer(i,Ammo.btCollisionObjectWrapper),u=Ammo.castObject(c.getCollisionObject(),Ammo.btRigidBody);l.threeObject;let h=u.threeObject,d=!1;for(let e=0;e<ne.length;e++)ne[e]==h&&(d=!0);d||ne.push(h),!X&&V>0&&h.name.indexOf("land")>-1&&(X=!0,W())},Q=new Ammo.ConcreteContactResultCallback,Q.hasContact=!1,Q.addSingleResult=function(e,t,n,o,i,s,r){Ammo.wrapPointer(e,Ammo.btManifoldPoint).getDistance()>0||(this.hasContact=!0,console.log("碰到物体"+t))},function(){let t=null,n=null,o=.22,s=h;S.set(10,s/2,0);let l=new T({color:16777215,alphaTest:!0,transparent:!0,opacity:.5});t=new a(new Ee(o,s-2*o,20,16),l),n=new Ammo.btCapsuleShape(o,s-2*o),n.setMargin(z),t.position.set(0,0,0);const c=10*o,u=new Ammo.btVector3(0,0,0);n.calculateLocalInertia(c,u);const p=new Ammo.btTransform;p.setIdentity(),S=t.position,p.setOrigin(new Ammo.btVector3(S.x,S.y,S.z));const f=new Ammo.btDefaultMotionState(p),m=new Ammo.btRigidBodyConstructionInfo(c,f,n,u),g=new Ammo.btRigidBody(m);g.setActivationState(j),g.setAngularFactor(0,1,0),t.userData.physicsBody=g,t.userData.tag="ball",e.add(t),L=t,w.addRigidBody(g),(O=g).setDamping(.01,.01),g.setRollingFriction(10),O.setFriction(10),O.setGravity(new Ammo.btVector3(0,0,0)),O.setActivationState(!0),(ae=new Ammo.btVector3(0,0,0)).setY(J),D=new d,L.add(D),D.rotateY(Math.PI/2),G=new d,L.add(G),G.rotateY(-Math.PI/2),G.rotateZ(-.469),O.threeObject=L,P.setFromAxisAngle(new i(0,1,0),0*Math.PI/180),L.quaternion.copy(P),r.YJController.SetAmmoPlayer(L,s),console.log("初始化角色刚体")}(),p(),se()})),this.addRigidBody=function(e){w.addRigidBody(e)};let A=[];this.AddAmmoPlane=function(e,t){!function(e,t){for(let t=0;t<A.length;t++){if(A[t].id==e)return}var n=(new b).load(r.$publicUrl+"models/player/Model/unitychan_tile6.png");n.wrapS=M,n.wrapT=M,n.repeat.set(10,10);const o=new re({color:10994533,castShadow:!0,transparent:!0,opacity:0,alphaTest:!0});S.set(t.x,t.y-.05,t.z);let i={w:40,h:40};const s=function(e,t,n,o,i,s,r){null==I&&(I=new a(new u(e,t,n,1,1,1),r));const l=new a(new u(e,t,n,1,1,1),r),c=new Ammo.btBoxShape(new Ammo.btVector3(.5*e,.5*t,.5*n));c.setMargin(z);return E(l,c,o,i,s).threeObject=l,l}(i.w,.1,i.h,0,S,P,o);s.name="floor",s.receiveShadow=!0,r.pointsParent.add(s),A.push({id:e,model:s})}(e,t)},this.RemoveAmmoPlane=function(e){for(let n=A.length-1;n>=0;n--){var t=A[n];t.id!=e||(r.pointsParent.remove(t.model),w.removeRigidBody(t.model),A.splice(n,1))}},this.GetMapIdMesh=function(e){for(let t=0;t<A.length;t++)if(A[t].id==e)return A[t].model;return null};const _=[];function E(t,n,o,i,s,r,a){i?t.position.copy(i):i=t.position,s?t.quaternion.copy(s):s=t.quaternion;const l=new Ammo.btTransform;l.setIdentity(),l.setOrigin(new Ammo.btVector3(i.x,i.y,i.z)),l.setRotation(new Ammo.btQuaternion(s.x,s.y,s.z,s.w));const c=new Ammo.btDefaultMotionState(l),u=new Ammo.btVector3(0,0,0);n.calculateLocalInertia(o,u);const h=new Ammo.btRigidBodyConstructionInfo(o,c,n,u),d=new Ammo.btRigidBody(h);return d.setFriction(.5),r&&d.setLinearVelocity(new Ammo.btVector3(r.x,r.y,r.z)),a&&d.setAngularVelocity(new Ammo.btVector3(a.x,a.y,a.z)),t.userData.physicsBody=d,t.userData.collided=!1,e.add(t),o>0&&(_.push(t),d.setActivationState(4)),w.addRigidBody(d),d}let I=null;function C(e){var t=new i;return e.getWorldPosition(t),t}function R(e,t,n,o,i,s,r){o?e.position.copy(o):o=C(e),i?e.quaternion.copy(i):i=e.quaternion;const a=new Ammo.btTransform;a.setIdentity(),a.setOrigin(new Ammo.btVector3(o.x,o.y,o.z)),a.setRotation(new Ammo.btQuaternion(i.x,i.y,i.z,i.w));const l=new Ammo.btDefaultMotionState(a),c=new Ammo.btVector3(0,0,0);t.calculateLocalInertia(n,c);const u=new Ammo.btRigidBodyConstructionInfo(n,l,t,c),h=new Ammo.btRigidBody(u);return e.userData.physicsBody=h,e.userData.collided=!0,n>0&&h.setActivationState(4),w.addRigidBody(h),h}function k(e,t,n,o,i,s,r){o||(o=e.position);const a=new Ammo.btTransform;a.setIdentity(),o=C(e),i=e.getWorldQuaternion(new c),a.setOrigin(new Ammo.btVector3(o.x,o.y,o.z)),a.setRotation(new Ammo.btQuaternion(i.x,i.y,i.z,i.w));const l=new Ammo.btDefaultMotionState(a),u=new Ammo.btVector3(0,0,0);t.calculateLocalInertia(n,u);const h=new Ammo.btRigidBodyConstructionInfo(n,l,t,u),d=new Ammo.btRigidBody(h);return e.userData.physicsBody=d,n>0&&(_.push(e),d.setActivationState(4)),w.addRigidBody(d),d}this.removeRigidBody=function(e){null!=e&&w.removeRigidBody(e.userData.physicsBody)},this.createCylinderTrigger=function(e,t,n,o,i){const s=function(e,t,n,o){const i=e,s=new Ammo.btCylinderShape(new Ammo.btVector3(t,n,o));s.setMargin(z);const r=R(i,s,0);return i.userData.tag="trigger",r.setCollisionFlags(4),r.threeObject=i,i}(e,t.x,t.y,t.z);return s.triggerName=o,s.modelId=n,s.owner=i,s},this.SetPlayerParent=function(e){L.add(e)};var L=null,D=null,O=null;const z=.05;var F=!1,N=!1,Y=!1,U=!1;const j=4;var H=null;function B(e,t){let n=e.geometry.getAttribute("position").array,o=e.geometry.index.array;const i=[t.x,t.y,t.z],s=new Ammo.btTriangleMesh(!0,!0);s.setScaling(new Ammo.btVector3(i[0],i[1],i[2]));for(let e=0;3*e<o.length;e++)s.addTriangle(new Ammo.btVector3(n[3*o[3*e]],n[3*o[3*e]+1],n[3*o[3*e]+2]),new Ammo.btVector3(n[3*o[3*e+1]],n[3*o[3*e+1]+1],n[3*o[3*e+1]+2]),new Ammo.btVector3(n[3*o[3*e+2]],n[3*o[3*e+2]+1],n[3*o[3*e+2]+2]),!1);return new Ammo.btBvhTriangleMeshShape(s,!0,!0)}this.createBoxTrigger=function(e,t,n,o,i){const s=function(e,t,n,o,i){null==H&&(H=new T({color:1616928870,transparent:!0,opacity:.3}));const s=new a(new u(e,t,n,1,1,1),H),r=new Ammo.btBoxShape(new Ammo.btVector3(.5*e,.5*t,.5*n));r.setMargin(z);const l=R(s,r,0,o,i);return s.userData.tag="trigger",l.setCollisionFlags(4),l.threeObject=s,s}(e.x,e.y,e.z,t,n);return s.triggerName=i,s.modelId=o,s},this.createMeshTrigger=function(e,t,n,o,i,s){const r=e;let a;null!=r.userData.physicsBody&&w.removeRigidBody(r.userData.physicsBody);let l=e.geometry.getAttribute("position").array,c=[];for(let e=0;e<l.length-3;e+=3)c.push({x:l[e],y:l[e+1],z:l[e+2]});a=function(e,t){const n=[t.x,t.y,t.z];var o=new Ammo.btTriangleMesh,i=new Ammo.btConvexHullShape;let s=new Ammo.btVector3(0,0,0),r=new Ammo.btVector3(0,0,0),a=new Ammo.btVector3(0,0,0);for(let t=0;t<e.length-3;t+=3)s.setX(e[t].x*n[0]),s.setY(e[t].y*n[1]),s.setZ(e[t].z*n[2]),i.addPoint(s,!0),r.setX(e[t+1].x*n[0]),r.setY(e[t+1].y*n[1]),r.setZ(e[t+1].z*n[2]),i.addPoint(r,!0),a.setX(e[t+2].x*n[0]),a.setY(e[t+2].y*n[1]),a.setZ(e[t+2].z*n[2]),i.addPoint(a,!0),o.addTriangle(s,r,a,!0);return i}(c,t),a.setMargin(z);const u=k(r,a,0,n,o);r.userData.tag="collider",u.threeObject=r},this.CreateTriangeMeshCollider=function(e,t,n,o,i,s){const r=e;let a;null!=r.userData.physicsBody&&w.removeRigidBody(r.userData.physicsBody),a=B(e,t),a.setMargin(z);const l=k(r,a,0,n,o);r.userData.tag="collider",l.threeObject=r},this.CreateTriangeMeshTrigger=function(e,t,n,o,i){const s=e;let r;r=B(e,t),r.setMargin(z);const a=R(s,r,0);s.userData.tag="trigger",a.setCollisionFlags(4),a.threeObject=s,a.triggerName=o,a.modelId=n,a.owner=i,s.owner=i},this.GetRotaRefChild=function(){return G},this.GetRotaRefChild2=function(){return D};let G=null,J=0;let X=!0,V=0;function W(){X?(O.setGravity(new Ammo.btVector3(0,-49,0)),ce=!1,r.YJController.setJumpToFalse(),me=0,V=-1,fe=ve):(V=0,O.setGravity(new Ammo.btVector3(0,0,0)),fe=te),r.YJController.SetFlyMountDisplay(!X)}this.SetGravityActive=function(e){X=e,W()},this.GetGravityActive=function(){return X},this.ToggleGravityActive=function(){X=!X,W()},this.SetIsMoving=function(e){q(e)};let K=!1;function q(e){K!=e&&(K=e,O.setFriction(e?.1:1))}this.SetPlayerPos=function(e){const t=O.getMotionState();if(t){for(let n=0;n<3;n++)t.setWorldTransform(x),x.setOrigin(new Ammo.btVector3(e.x,e.y,e.z));const n=x.getOrigin();L.position.set(n.x(),n.y(),n.z()),O.setMotionState(t)}},this.onKeyDown=function(e){switch(O.setActivationState(!0),e.code){case"ArrowUp":case"KeyW":F=!0;break;case"ArrowLeft":case"KeyA":Y=!0;break;case"ArrowDown":case"KeyS":N=!0;break;case"ArrowRight":case"KeyD":U=!0;break;case"Space":if(X){if(ce)return;ae.setY(15),O.setLinearVelocity(ae),ce=!0,setTimeout((()=>{ae.setY(J)}),100)}}},this.onKeyUp=function(e){switch(e.code){case"ArrowUp":case"KeyW":F=!1;break;case"ArrowLeft":case"KeyA":Y=!1;break;case"ArrowDown":case"KeyS":N=!1;break;case"ArrowRight":case"KeyD":U=!1}};let Z,Q,$=null,ee=1,te=1;this.SetFlySpeed=function(e,t){ee=e,te=t},this.SetJumpFly=function(){X||(ae.setY(ee),O.setLinearVelocity(ae),null!=$&&clearTimeout($),$=setTimeout((()=>{ae.setY(-0),O.setLinearVelocity(ae)}),100),V++,fe=te)},this.SetMoveForward=function(e){F=e},this.lookAtPos=function(e){L.lookAt(e)};let ne=[],oe=[];var ie=null;function se(){requestAnimationFrame(se),function(){const e=f.getDelta();ft.update(),function(e){w.stepSimulation(e,10);for(let e=0,t=_.length;e<t;e++){const t=_[e],n=t.userData.physicsBody.getMotionState();if(n){n.getWorldTransform(x);const e=x.getOrigin(),o=x.getRotation();t.position.set(e.x(),e.y(),e.z()),t.quaternion.set(o.x(),o.y(),o.z(),o.w())}}(function(){if(null!=O&&!ce)if(F||N||Y||U){le=!0,q(!0),1==we&&(ge&&(fe+=.1),ye&&(fe-=.1),fe>=pe&&(fe=pe),fe<=de&&(fe=de));let e=0,t=0,n=!1,o=!1;(F||N)&&(n=!0,F&&(t=1),N&&(t=-1)),(Y||U)&&(o=!0,Y&&(e=1),U&&(e=-1)),he(n,o,e,t)}else le&&(ue||(O.setLinearVelocity(-ae),ae.setX(0),ae.setZ(0),le=!1,ge=!1,ye=!1,q(!1)));if(ce){let e=O.getLinearVelocity();const t=Math.abs(e.y());if(t<.1)ce=!1,r.YJController.setJumpToFalse(),me=0;else if(t<2){const e=24*f.getDelta()*3;me+=e,me>.2&&(r.YJController.setJumpToFalse(),me=0,ce=!1)}}const e=L,t=e.userData.physicsBody.getMotionState();if(t){t.getWorldTransform(x);const n=x.getOrigin();x.getRotation(),e.position.set(n.x(),n.y(),n.z())}!function(){if(0==oe.length&&0==ne.length){if(ce)return void(null!=ie&&(clearTimeout(ie),ie=null));ie=setTimeout((()=>{J=-4,ae.setY(J)}),100)}else null!=ie&&(clearTimeout(ie),ie=null),J=0,ae.setY(J);for(let e=0;e<ne.length;e++){const t=ne[e];let n=!1;for(let e=0;e<oe.length;e++)t==oe[e]&&(n=!0);if(!n){if(null==t)continue;"trigger"==t.userData.tag&&(console.log(" 进入 碰撞到物体的 trigger,modelId = ",t.modelId),r._YJSceneManager.ChangeJiaohuArea(!0,t.modelId,t.triggerName,t))}}for(let e=0;e<oe.length;e++){const t=oe[e];let n=!1;for(let e=0;e<ne.length;e++)t==ne[e]&&(n=!0);if(!n){if(null==t)continue;"trigger"==t.userData.tag&&(console.log("离开 碰撞到物体的 trigger,modelId = ",t.modelId),r._YJSceneManager.ChangeJiaohuArea(!1,t.modelId,t.triggerName,t))}}oe=[];for(let e=0;e<ne.length;e++)oe.push(ne[e]);ne=[]}()})(),w.contactTest(L.userData.physicsBody,Z)}(e)}()}var ae,le=!1,ce=!1;let ue=!1;function he(e,t,n,o){let s=new i(0,0,0);L.getWorldDirection(s);let a=new i(0,0,0);if(D.getWorldDirection(a),X);else{let e=r.YJController.GetCamTargetWorldDire().y;F?ae.setY(e*fe):N?ae.setY(e*-fe):ae.setY(0)}let l=n,c=o,u=0,h=0;e&&(u=s.x*c*fe,h=s.z*c*fe),t&&(u=a.x*l*fe,h=a.z*l*fe),e&&t&&(u=.7*(s.x*c+a.x*l)*fe,h=.7*(s.z*c+a.z*l)*fe),ae.setX(u),ae.setZ(h),O.setLinearVelocity(ae)}this.MoveByJoystickAxis=(e,t)=>{if(0==e&&0==t)return void(le&&(O.setLinearVelocity(-ae),ae.setX(0),ae.setZ(0),le=!1,ue=!1,q(!1)));le=!0,q(!0),ue=!0;let n=0,o=0,i=!1,s=!1;Math.abs(e)>.1&&(s=!0,n=e),Math.abs(t)>.1&&(i=!0,o=t),he(i,s,n,o)};let de=1.5,pe=5;var fe=de;let me=0,ge=!1,ye=!1;this.ResetMoveSpeed=function(){fe=de};let ve=5;this.SetMoveSpeed=function(e){ve=e,X&&(fe=e)},this.SetMaxMoveSpeed=function(e){pe=e},this.GetMoveSpeed=function(){return 1*fe/pe},this.MoveBegin=function(){ge||(ge=!0,ye=!1,1==we&&(fe=de))},this.MoveEnd=function(){ye||(ge=!1,ye=!0)};let we=0;this.ChangeContrlState=function(e){we=e}}}const ds=new o,ps=new i,fs=new i,ms=new c,gs={X:new i(1,0,0),Y:new i(0,1,0),Z:new i(0,0,1)},ys={type:"change"},vs={type:"mouseDown"},ws={type:"mouseUp",mode:null},xs={type:"objectChange"};class bs extends C{constructor(e,t){super(),void 0===t&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),this.isTransformControls=!0,this.visible=!1,this.domElement=t,this.domElement.style.touchAction="none";const n=new Hs;this._gizmo=n,this.add(n);const o=new Bs;this._plane=o,this.add(o);const s=this;function r(e,t){let i=t;Object.defineProperty(s,e,{get:function(){return void 0!==i?i:t},set:function(t){i!==t&&(i=t,o[e]=t,n[e]=t,s.dispatchEvent({type:e+"-changed",value:t}),s.dispatchEvent(ys))}}),s[e]=t,o[e]=t,n[e]=t}r("camera",e),r("object",void 0),r("enabled",!0),r("axis",null),r("mode","translate"),r("translationSnap",null),r("rotationSnap",null),r("scaleSnap",null),r("space","world"),r("size",1),r("dragging",!1),r("showX",!0),r("showY",!0),r("showZ",!0);const a=new i,l=new i,u=new c,h=new c,d=new i,p=new c,f=new i,m=new i,g=new i,y=new i;r("worldPosition",a),r("worldPositionStart",l),r("worldQuaternion",u),r("worldQuaternionStart",h),r("cameraPosition",d),r("cameraQuaternion",p),r("pointStart",f),r("pointEnd",m),r("rotationAxis",g),r("rotationAngle",0),r("eye",y),this._offset=new i,this._startNorm=new i,this._endNorm=new i,this._cameraScale=new i,this._parentPosition=new i,this._parentQuaternion=new c,this._parentQuaternionInv=new c,this._parentScale=new i,this._worldScaleStart=new i,this._worldQuaternionInv=new c,this._worldScale=new i,this._positionStart=new i,this._quaternionStart=new c,this._scaleStart=new i,this._getPointer=Ms.bind(this),this._onPointerDown=Ts.bind(this),this._onPointerHover=Ss.bind(this),this._onPointerMove=Ps.bind(this),this._onPointerUp=As.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye):this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(e){if(void 0===this.object||!0===this.dragging)return;ds.setFromCamera(e,this.camera);const t=_s(this._gizmo.picker[this.mode],ds);this.axis=t?t.object.name:null}pointerDown(e){if(void 0!==this.object&&!0!==this.dragging&&0===e.button&&null!==this.axis){ds.setFromCamera(e,this.camera);const t=_s(this._plane,ds,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,vs.mode=this.mode,this.dispatchEvent(vs)}}pointerMove(e){const t=this.axis,n=this.mode,o=this.object;let i=this.space;if("scale"===n?i="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(i="world"),void 0===o||null===t||!1===this.dragging||-1!==e.button)return;ds.setFromCamera(e,this.camera);const s=_s(this._plane,ds,!0);if(s){if(this.pointEnd.copy(s.point).sub(this.worldPositionStart),"translate"===n)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===i&&"XYZ"!==t&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===t.indexOf("X")&&(this._offset.x=0),-1===t.indexOf("Y")&&(this._offset.y=0),-1===t.indexOf("Z")&&(this._offset.z=0),"local"===i&&"XYZ"!==t?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),o.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===i&&(o.position.applyQuaternion(ms.copy(this._quaternionStart).invert()),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.position.applyQuaternion(this._quaternionStart)),"world"===i&&(o.parent&&o.position.add(ps.setFromMatrixPosition(o.parent.matrixWorld)),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.parent&&o.position.sub(ps.setFromMatrixPosition(o.parent.matrixWorld))));else if("scale"===n){if(-1!==t.search("XYZ")){let e=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(e*=-1),fs.set(e,e,e)}else ps.copy(this.pointStart),fs.copy(this.pointEnd),ps.applyQuaternion(this._worldQuaternionInv),fs.applyQuaternion(this._worldQuaternionInv),fs.divide(ps),-1===t.search("X")&&(fs.x=1),-1===t.search("Y")&&(fs.y=1),-1===t.search("Z")&&(fs.z=1);o.scale.copy(this._scaleStart).multiply(fs),this.scaleSnap&&(-1!==t.search("X")&&(o.scale.x=Math.round(o.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(o.scale.y=Math.round(o.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(o.scale.z=Math.round(o.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===n){this._offset.copy(this.pointEnd).sub(this.pointStart);const e=20/this.worldPosition.distanceTo(ps.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1):"XYZE"===t?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(ps.copy(this.rotationAxis).cross(this.eye))*e):"X"!==t&&"Y"!==t&&"Z"!==t||(this.rotationAxis.copy(gs[t]),ps.copy(gs[t]),"local"===i&&ps.applyQuaternion(this.worldQuaternion),this.rotationAngle=this._offset.dot(ps.cross(this.eye).normalize())*e),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===i&&"E"!==t&&"XYZE"!==t?(o.quaternion.copy(this._quaternionStart),o.quaternion.multiply(ms.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),o.quaternion.copy(ms.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),o.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ys),this.dispatchEvent(xs)}}pointerUp(e){0===e.button&&(this.dragging&&null!==this.axis&&(ws.mode=this.mode,this.dispatchEvent(ws)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse((function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}))}attach(e){return this.object=e,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ys),this.dispatchEvent(xs),this.pointStart.copy(this.pointEnd))}getRaycaster(){return ds}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}update(){console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}}function Ms(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function Ss(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e))}}function Ts(e){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function Ps(e){this.enabled&&this.pointerMove(this._getPointer(e))}function As(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function _s(e,t,n){const o=t.intersectObject(e,!0);for(let e=0;e<o.length;e++)if(o[e].object.visible||n)return o[e];return!1}const Es=new V,Is=new i(0,1,0),Cs=new i(0,0,0),Rs=new p,ks=new c,Ls=new c,Ds=new i,Os=new p,zs=new i(1,0,0),Fs=new i(0,1,0),Ns=new i(0,0,1),Ys=new i,Us=new i,js=new i;class Hs extends C{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new r({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new N({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),n=e.clone();n.opacity=.15;const o=t.clone();o.opacity=.5;const i=e.clone();i.color.setHex(16711680);const s=e.clone();s.color.setHex(65280);const l=e.clone();l.color.setHex(255);const c=e.clone();c.color.setHex(16711680),c.opacity=.5;const h=e.clone();h.color.setHex(65280),h.opacity=.5;const d=e.clone();d.color.setHex(255),d.opacity=.5;const p=e.clone();p.opacity=.25;const f=e.clone();f.color.setHex(16776960),f.opacity=.25;e.clone().color.setHex(16776960);const m=e.clone();m.color.setHex(7895160);const g=new Ae(0,.04,.1,12);g.translate(0,.05,0);const y=new u(.08,.08,.08);y.translate(0,.04,0);const v=new H;v.setAttribute("position",new B([0,0,0,1,0,0],3));const w=new Ae(.0075,.0075,.5,3);function x(e,t){const n=new Re(e,.0075,3,64,t*Math.PI*2);return n.rotateY(Math.PI/2),n.rotateX(Math.PI/2),n}w.translate(0,.25,0);const b={X:[[new a(g,i),[.5,0,0],[0,0,-Math.PI/2]],[new a(g,i),[-.5,0,0],[0,0,Math.PI/2]],[new a(w,i),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new a(g,s),[0,.5,0]],[new a(g,s),[0,-.5,0],[Math.PI,0,0]],[new a(w,s)]],Z:[[new a(g,l),[0,0,.5],[Math.PI/2,0,0]],[new a(g,l),[0,0,-.5],[-Math.PI/2,0,0]],[new a(w,l),null,[Math.PI/2,0,0]]],XYZ:[[new a(new Ie(.1,0),p.clone()),[0,0,0]]],XY:[[new a(new u(.15,.15,.01),d.clone()),[.15,.15,0]]],YZ:[[new a(new u(.15,.15,.01),c.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new u(.15,.15,.01),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},M={X:[[new a(new Ae(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new a(new Ae(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new a(new Ae(.2,0,.6,4),n),[0,.3,0]],[new a(new Ae(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new a(new Ae(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new a(new Ae(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new a(new Ie(.2,0),n)]],XY:[[new a(new u(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new a(new u(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new u(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]]},S={START:[[new a(new Ie(.01,2),o),null,null,null,"helper"]],END:[[new a(new Ie(.01,2),o),null,null,null,"helper"]],DELTA:[[new Y(function(){const e=new H;return e.setAttribute("position",new B([0,0,0,1,1,1],3)),e}(),o),null,null,null,"helper"]],X:[[new Y(v,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Y(v,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Y(v,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},T={XYZE:[[new a(x(.5,1),m),null,[0,Math.PI/2,0]]],X:[[new a(x(.5,.5),i)]],Y:[[new a(x(.5,.5),s),null,[0,0,-Math.PI/2]]],Z:[[new a(x(.5,.5),l),null,[0,Math.PI/2,0]]],E:[[new a(x(.75,1),f),null,[0,Math.PI/2,0]]]},P={AXIS:[[new Y(v,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={XYZE:[[new a(new Ce(.25,10,8),n)]],X:[[new a(new Re(.5,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new a(new Re(.5,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new a(new Re(.5,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new a(new Re(.75,.1,2,24),n)]]},_={X:[[new a(y,i),[.5,0,0],[0,0,-Math.PI/2]],[new a(w,i),[0,0,0],[0,0,-Math.PI/2]],[new a(y,i),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new a(y,s),[0,.5,0]],[new a(w,s)],[new a(y,s),[0,-.5,0],[0,0,Math.PI]]],Z:[[new a(y,l),[0,0,.5],[Math.PI/2,0,0]],[new a(w,l),[0,0,0],[Math.PI/2,0,0]],[new a(y,l),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new a(new u(.15,.15,.01),d),[.15,.15,0]]],YZ:[[new a(new u(.15,.15,.01),c),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new u(.15,.15,.01),h),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new a(new u(.1,.1,.1),p.clone())]]},E={X:[[new a(new Ae(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new a(new Ae(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new a(new Ae(.2,0,.6,4),n),[0,.3,0]],[new a(new Ae(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new a(new Ae(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new a(new Ae(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new a(new u(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new a(new u(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new u(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new a(new u(.2,.2,.2),n),[0,0,0]]]},I={X:[[new Y(v,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Y(v,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Y(v,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function R(e){const t=new C;for(const n in e)for(let o=e[n].length;o--;){const i=e[n][o][0].clone(),s=e[n][o][1],r=e[n][o][2],a=e[n][o][3],l=e[n][o][4];i.name=n,i.tag=l,s&&i.position.set(s[0],s[1],s[2]),r&&i.rotation.set(r[0],r[1],r[2]),a&&i.scale.set(a[0],a[1],a[2]),i.updateMatrix();const c=i.geometry.clone();c.applyMatrix4(i.matrix),i.geometry=c,i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=R(b)),this.add(this.gizmo.rotate=R(T)),this.add(this.gizmo.scale=R(_)),this.add(this.picker.translate=R(M)),this.add(this.picker.rotate=R(A)),this.add(this.picker.scale=R(E)),this.add(this.helper.translate=R(S)),this.add(this.helper.rotate=R(P)),this.add(this.helper.scale=R(I)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const t="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:Ls;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let n=[];n=n.concat(this.picker[this.mode].children),n=n.concat(this.gizmo[this.mode].children),n=n.concat(this.helper[this.mode].children);for(let e=0;e<n.length;e++){const o=n[e];let i;if(o.visible=!0,o.rotation.set(0,0,0),o.position.copy(this.worldPosition),i=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),o.scale.set(1,1,1).multiplyScalar(i*this.size/4),"helper"!==o.tag){if(o.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){const e=.99,n=.2;"X"===o.name&&Math.abs(Is.copy(zs).applyQuaternion(t).dot(this.eye))>e&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"Y"===o.name&&Math.abs(Is.copy(Fs).applyQuaternion(t).dot(this.eye))>e&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"Z"===o.name&&Math.abs(Is.copy(Ns).applyQuaternion(t).dot(this.eye))>e&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"XY"===o.name&&Math.abs(Is.copy(Ns).applyQuaternion(t).dot(this.eye))<n&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"YZ"===o.name&&Math.abs(Is.copy(zs).applyQuaternion(t).dot(this.eye))<n&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"XZ"===o.name&&Math.abs(Is.copy(Fs).applyQuaternion(t).dot(this.eye))<n&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1)}else"rotate"===this.mode&&(ks.copy(t),Is.copy(this.eye).applyQuaternion(ms.copy(t).invert()),-1!==o.name.search("E")&&o.quaternion.setFromRotationMatrix(Rs.lookAt(this.eye,Cs,Fs)),"X"===o.name&&(ms.setFromAxisAngle(zs,Math.atan2(-Is.y,Is.z)),ms.multiplyQuaternions(ks,ms),o.quaternion.copy(ms)),"Y"===o.name&&(ms.setFromAxisAngle(Fs,Math.atan2(Is.x,Is.z)),ms.multiplyQuaternions(ks,ms),o.quaternion.copy(ms)),"Z"===o.name&&(ms.setFromAxisAngle(Ns,Math.atan2(Is.y,Is.x)),ms.multiplyQuaternions(ks,ms),o.quaternion.copy(ms)));o.visible=o.visible&&(-1===o.name.indexOf("X")||this.showX),o.visible=o.visible&&(-1===o.name.indexOf("Y")||this.showY),o.visible=o.visible&&(-1===o.name.indexOf("Z")||this.showZ),o.visible=o.visible&&(-1===o.name.indexOf("E")||this.showX&&this.showY&&this.showZ),o.material._color=o.material._color||o.material.color.clone(),o.material._opacity=o.material._opacity||o.material.opacity,o.material.color.copy(o.material._color),o.material.opacity=o.material._opacity,this.enabled&&this.axis&&(o.name===this.axis||this.axis.split("").some((function(e){return o.name===e})))&&(o.material.color.setHex(16776960),o.material.opacity=1)}else o.visible=!1,"AXIS"===o.name?(o.position.copy(this.worldPositionStart),o.visible=!!this.axis,"X"===this.axis&&(ms.setFromEuler(Es.set(0,0,0)),o.quaternion.copy(t).multiply(ms),Math.abs(Is.copy(zs).applyQuaternion(t).dot(this.eye))>.9&&(o.visible=!1)),"Y"===this.axis&&(ms.setFromEuler(Es.set(0,0,Math.PI/2)),o.quaternion.copy(t).multiply(ms),Math.abs(Is.copy(Fs).applyQuaternion(t).dot(this.eye))>.9&&(o.visible=!1)),"Z"===this.axis&&(ms.setFromEuler(Es.set(0,Math.PI/2,0)),o.quaternion.copy(t).multiply(ms),Math.abs(Is.copy(Ns).applyQuaternion(t).dot(this.eye))>.9&&(o.visible=!1)),"XYZE"===this.axis&&(ms.setFromEuler(Es.set(0,Math.PI/2,0)),Is.copy(this.rotationAxis),o.quaternion.setFromRotationMatrix(Rs.lookAt(Cs,Is,Fs)),o.quaternion.multiply(ms),o.visible=this.dragging),"E"===this.axis&&(o.visible=!1)):"START"===o.name?(o.position.copy(this.worldPositionStart),o.visible=this.dragging):"END"===o.name?(o.position.copy(this.worldPosition),o.visible=this.dragging):"DELTA"===o.name?(o.position.copy(this.worldPositionStart),o.quaternion.copy(this.worldQuaternionStart),ps.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),ps.applyQuaternion(this.worldQuaternionStart.clone().invert()),o.scale.copy(ps),o.visible=this.dragging):(o.quaternion.copy(t),this.dragging?o.position.copy(this.worldPositionStart):o.position.copy(this.worldPosition),this.axis&&(o.visible=-1!==this.axis.search(o.name)))}super.updateMatrixWorld(e)}}class Bs extends a{constructor(){super(new s(1e5,1e5,2,2),new r({visible:!1,wireframe:!0,side:m,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(t="local"),Ys.copy(zs).applyQuaternion("local"===t?this.worldQuaternion:Ls),Us.copy(Fs).applyQuaternion("local"===t?this.worldQuaternion:Ls),js.copy(Ns).applyQuaternion("local"===t?this.worldQuaternion:Ls),Is.copy(Us),this.mode){case"translate":case"scale":switch(this.axis){case"X":Is.copy(this.eye).cross(Ys),Ds.copy(Ys).cross(Is);break;case"Y":Is.copy(this.eye).cross(Us),Ds.copy(Us).cross(Is);break;case"Z":Is.copy(this.eye).cross(js),Ds.copy(js).cross(Is);break;case"XY":Ds.copy(js);break;case"YZ":Ds.copy(Ys);break;case"XZ":Is.copy(js),Ds.copy(Us);break;case"XYZ":case"E":Ds.set(0,0,0)}break;default:Ds.set(0,0,0)}0===Ds.length()?this.quaternion.copy(this.cameraQuaternion):(Os.lookAt(ps.set(0,0,0),Ds,Is),this.quaternion.setFromRotationMatrix(Os)),super.updateMatrixWorld(e)}}class Gs{constructor(e,t,n,o,l,c,u,h){var p=this;let g,y,v=null,w=null;var x=null;let b;function M(){b=l.radius,l=l.modelData,g=l.height,y=1;let t=l.animationsData;v=new as(e,e.scene,e.$publicUrl+l.modelPath,t,p,(t=>{x=t,w.add(x),w.position.set(c.x,c.y,c.z),w.rotation.set(u.x,u.y,u.z),function(e){P=new d,P.name="npcname",w.add(P),P.position.set(0,g+.3,0);const t=new d,n=function(e,t){const n=document.createElement("canvas"),o=n.getContext("2d");let i=null;const l=100;o.font="normal 100px Arial",i=o.measureText(e);const c=i.width;n.width=c,n.height=l,o.font="normal 100px Arial",o.textAlign="center",o.textBaseline="middle",o.fillStyle="#ffffff",o.fillText(e,c/2,50);const u=new f(n);u.needsUpdate=!0;const h=new r({color:16777215,side:m,map:u,transparent:!0}),d=new s(t*c/l,t);return new a(d,h)}(e,.06);t.add(n),n.position.set(0,0,.0051),n.scale.set(1,1,1),P.add(t),t.name="ignoreRaycast",t.position.set(0,0,0);var o=2;t.scale.set(o,o,o),P.scale.set(y,y,y)}(l.name),function(t){const o=new Ae(t,t,2,18,5),s=new T({color:255,transparent:!0,opacity:0,alphaTest:!0});S=new a(o,s),S.name="ignoreRaycast",w.add(S),e._YJSceneManager.CreateCylinderTrigger(S,new i(t,2,t),n,"npc")}(b),E(),v.ChangeAnim("idle")}))}this.GetModel=function(){return this.DestroyCollider(),w},this.LoadPlayerByCustom=function(e){},this.GetAllMesh=function(){let e=[];return x.traverse((function(t){return t instanceof a||t instanceof F?(e.push(t),e):void 0})),e};let S,P=null;let A,_=null;function E(){e._YJSceneManager.LoadSingleModelCompleted()}this.SetOverlapPlayer=function(e){_=e,null==_?w.rotation.copy(A):A=w.rotation.clone()},this.ResetSetPosRota=function(e,t){null!=x&&this.SetPosRota(e,t)},this.SetPosRota=function(e,t){null!=x&&(w.position.set(e.x,e.y,e.z),null!=t&&w.rotation.set(t.x,t.y,t.z))},this.SetDown=function(t,o){e._YJSceneManager.CreateCylinderTrigger(S,new i(b,2,b),n,"npc")},this.Destroy=function(){E(),this.DestroyCollider(),t.remove(w)},this.DestroyCollider=function(){null!=S.userData.physicsBody&&null!=S.userData.physicsBody&&e._YJSceneManager.RemoveCollider(S)},this.GetPosRota=function(e){e(w.position,w.rotation)},w=new d,e.pointsParent.add(w),null==l?async function(e,t){let n=new FormData;n.append("dataPath",t+"/"+e+"/"+e+"_avatar.txt");let o=await je(n);null!=o&&""!=o&&(l=o,M())}(o,"C:/wamp/www/vue/yjwebgame/public/models/npc"):M(),function e(){if(requestAnimationFrame(e),null!=_){var t=new i;_.getWorldPosition(t),w.lookAt(t.x,t.y,t.z)}}()}}new p;class Js{constructor(e,t,n){let o=!1,i=null,l=null;function u(){l=e.$parent.GetMinMapData(),f=l.minMapOffset,p=l.minMapScale,i=l.minMapPlanePos,o=e.$parent.avatarData.setting.inMinMapEditor;let t=new s(.5*1.024,.5*.512,1,1),n=new r({transparent:!0,color:16777215});const u=(new b).load(e.GetPublicUrl()+l.minMapUrl);n.map=u;let m=new a(t,n);if(e.YJController.GetCam().add(m),m.rotation.set(Math.PI,Math.PI,Math.PI),o){m.position.set(-0,-.35,-1);let e=2;m.scale.set(e,e,e),n.opacity=.8}else{m.position.set(i.x,i.y,i.z),n.opacity=1;let e=.7;m.scale.set(e,e,1)}m.getWorldQuaternion(new c),console.log("-------创建小地图完成--------"),function(t,n){h=new d,t.add(h);let o={x:.499,y:.696},i=.1,c=new s(o.x*i,o.y*i,1,1),u=new r({transparent:!0,color:16777215,alphaTest:!0});const p=(new b).load(e.GetPublicUrl()+l.minMapPointUrl);u.map=p;let f=new a(c,u);h.add(f),f.rotation.set(Math.PI,Math.PI,Math.PI),f.position.set(0,o.y*i/2,1e-4)}(m)}let h=null;let p={x:.0024,y:.0024},f={x:0,y:0};this.SetScale=function(e,t){p.x=e,p.y=t},this.SetOffset=function(e,t){f.x=e,f.y=t},u(),this._update=function(){!function(e){let t=e.x*p.x+f.x,n=e.z*p.y+f.y;h.position.set(t,-n,0)}(e.YJController.GetPlayerWorldPos())}}}class Xs{constructor(e,t,n,o,i,s,r,c){var u=new l,h=null;let d;var p=null;function f(){null!=e._YJSceneManager?e._YJSceneManager.AddProcess():console.log("！！！注意，不应该进入此判断 。 加载静态模型 ")}function m(){requestAnimationFrame(m),null!==h&&h.update(u.getDelta())}this.GetModel=function(){return p},this.id=n,function(){if(i.indexOf("fbx")>-1)return void(new jo).load(i,(function(e){(p=e).traverse((function(e){e instanceof a&&(e.castShadow=!0,e.receiveShadow=!0)})),p.position.set(s.x,s.y,s.z),p.rotation.set(r.x,r.y,r.z),console.log(p);let i=.01;p.scale.set(i,i,i),p.tag=o,p.name=n,t.add(p),(h=new Te(p)).clipAction(p.animations[0]).play(),m(),f()}));(new ri).load(i,(function(e){(p=e.scene).traverse((function(e){e instanceof a&&(e.castShadow=!0,e.receiveShadow=!0)})),p.position.set(s.x,s.y,s.z),p.rotation.set(r.x,r.y,r.z),p.scale.set(c.x,c.y,c.z),p.tag=o,p.name=n,t.add(p),h=new Te(p);try{d=h.clipAction(e.animations[0])}catch(e){return console.log("加载动画物体 出错 ",o),void f()}d.enabled=!0,d.setEffectiveWeight(1),d.reset(),d.play(),m(),f()}),void 0,(function(e){console.error(e)}))}()}}class Vs{constructor(e,t,n,o,i){let s=!1,r=null;this.play=function(e){s=e,null!=r&&(e?r.play():r.pause())},this.load=function(e){o=e,(new ke).load(o,(function(e){r=new Le(n),r.setBuffer(e),r.setRefDistance(12),r.setLoop(!0),s&&r.play();let o=new d;o.position.set(i.x,i.y,i.z),t.add(o),o.add(r),r.position.set(0,0,0)}))},this.Destroy=function(){}}}class Ws{constructor(e,t,n,o,i,s,l,c,u){let h=null,d=null;new De;let p=null,f=null;var m,g,y;function v(t,o){!function(){for(let t=e.videoList.length-1;t>=0;t--){e.videoList[t].id==n&&e.videoList.splice(t,1)}}(),"video"==t&&function(t){let o=n;const i=`<video id="${o}"  loop src="${t}" ></video>`;e.videoList.push({id:o,html:i}),e.$nextTick((function(){const e=document.getElementById(o);e.play(),h=new _e(e),d.map=h}))}(o),"texture"==t&&function(e){console.log("加载 广告牌 贴图 ",e);const t=(new b).load(e);d.map=t}(o)}m=c,g=s,y=l,d=new r({map:h,color:16777215}),(new ri).load(o,(function(n){var o;p=n.scene,p.position.set(g.x,g.y,g.z),p.rotation.set(y.x,y.y,y.z),p.scale.set(m.x,m.y,m.z),t.add(p),p.traverse((function(e){e instanceof a&&(e.material=d)})),null==i?null!=u?v((o=u).type,o.path):v("texture",e.$publicUrl+"images/共享大屏.png"):i.indexOf("png")>-1||i.indexOf("jpg")>-1?v("texture",i):v("video",i)})),this.SendState=function(e){v(e.type,e.path)},this.SetState=function(e){v(e.type,e.path)},this.Destroy=function(){e._YJSceneManager.LoadSingleModelCompleted(),null!=p&&(this.DestroyCollider(),e._YJSceneManager.RemoveHotPoint(f),e.pointsParent.remove(f),t.remove(p))},this.DestroyCollider=function(){null!=p&&(p.traverse((function(e){e instanceof a&&(e.geometry.dispose(),e.material.dispose())})),f.traverse((function(e){e instanceof a&&(e.geometry.dispose(),e.material.dispose())})))}}}class Ks{constructor(e,t,n,o,s,r,l,u){var h=this;let p=null;this.GetModel=function(){return this.DestroyCollider(),p};let f=null,m=!1;var g=new i(0,0,0),y=new i(0,0,0);let v=null;this.SetOverlapPlayer=function(t){m=null!=t,"旋转放大"!=A&&"旋转变色"!=A||(m?(null!=v&&e._YJSceneManager.AddCanHitModel(v),y=p.rotation.clone(),g=p.getWorldQuaternion(new c).clone(),E()):(null!=v&&e._YJSceneManager.RemoveCanHitModel(v),S=!0)),"变色"==A&&(m?f.traverse((function(e){e instanceof a&&(e.material.color=255)})):f.traverse((function(e){e instanceof a&&(e.material.color=16777215)})))};var w=null;let x=new i(1,1,1),b=new i(1.3,1.3,1.3);this.SetMouseHover=function(e){if("旋转放大"==A)if(M=!e,e){null!=w&&w.stop();let e=p.scale.clone(),t=()=>{p.scale.set(e.x,e.y,e.z)};(w=new ft.Tween(e).to(b,300).easing(ft.Easing.Linear.None)).onUpdate(t),w.start(),w.onComplete((()=>{}))}else{null!=w&&w.stop();let e=p.scale.clone(),t=()=>{p.scale.set(e.x,e.y,e.z)};(w=new ft.Tween(e).to(x,300).easing(ft.Easing.Linear.None)).onUpdate(t),w.start(),w.onComplete((()=>{}))}else M=!1};let M=!0,S=!1;var T=0;let P=.01;this.SetData=function(e){P=e};let A="旋转放大";this.SetMessage=function(e){null!=e&&null!=e&&(A=e)},this.ResetSetPosRota=function(e,t){},this.SetPosRota=function(e,t){},this.SetDown=function(e,t){},this.Destroy=function(){},this.DestroyCollider=function(){},this.GetPosRota=function(e){},function(){p=new d,t.add(p),p.position.set(r.x,r.y,r.z),p.rotation.set(l.x,l.y,l.z),r=new i(0,0,0);let c=new i(0,0,0),m=new ls(e,p,n,s,r,c,u,o,!0,(()=>{setTimeout((()=>{f=m.GetModel(),f.traverse((function(t){if(t instanceof a)if(t.name.indexOf("trigger")>-1){let o=new i(0,0,0);o.x=t.scale.x*u.x,o.y=t.scale.y*u.y,o.z=t.scale.z*u.z,e._YJSceneManager.CreateTriangeMeshTrigger(t,o,n,"triggerArea",h),t.visible=!1}else t.name.indexOf("hit")>-1&&(v=t,t.visible=!1),t.name=o,t.tag="链接logo",t.owner=h}))}),100)}))}(),E();var _=null;function E(){_=requestAnimationFrame(E),m&&null!=f&&M?p.rotation.y+=P:function(){if("旋转放大"==A){if(S){T=.02,p.quaternion.rotateTowards(g,T);let e=p.quaternion;Math.abs(g.z-e.z)<.01&&Math.abs(g.x-e.x)<.01&&Math.abs(g.y-e.y)<.01&&Math.abs(g.w-e.w)<.01&&(S=!1,T=0,p.rotation.set(y.x,y.y,y.z),cancelAnimationFrame(_))}}else cancelAnimationFrame(_)}()}}}class qs{constructor(e,t,n,o){function s(n,o,i,s,a,c){let u=e._YJSceneManager.checkLoadMesh(o);if(null!=u)return void function(n,o,i,s,a,c){let u=n.clone().children[0];u.name=o,u.position.set(i.x,i.y,i.z),u.rotation.set(s.x,s.y,s.z),u.scale.set(a.x,a.y,a.z),t.add(u),o.indexOf("land")>-1&&(u.tag="floor",e.pointsParent.add(u));c&&r(u,a);l()}(u,n,i,s,a,c);let h=new d;(new ri).load(o,(function(u){let d=u.scene;d.name=n,d.position.set(i.x,i.y,i.z),d.rotation.set(s.x,s.y,s.z),d.scale.set(a.x,a.y,a.z),h.add(d),t.add(h),e._YJSceneManager.addLoadMesh(o,h.clone()),n.indexOf("land")>-1&&(d.tag="floor",e.pointsParent.add(d)),c&&r(d,a),l()}),void 0,(function(e){console.error(e)}))}function r(t,n){let o=!1;t.traverse((function(t){t instanceof a&&(t.name.indexOf("collider")>-1?(o=!0,e._YJSceneManager.CreateTriangeMeshCollider(t,t.scale),t.visible=!1):(t.castShadow=!0,t.receiveShadow=!0,t.material.emissiveIntensity=2))})),o||t.traverse((function(t){if(t instanceof a){let o=new i(0,0,0);o.x=t.scale.x*n.x,o.y=t.scale.y*n.y,o.z=t.scale.z*n.z,e._YJSceneManager.CreateTriangeMeshCollider(t,o)}}))}function l(){null!=e._YJSceneManager?(e._YJSceneManager.AddProcess(),c++,u()):console.log("！！！注意，不应该进入此判断 。 加载静态模型 ")}let c=0;function u(){if(c>=n.length)return;let o=n[c];if("playerPos"==o.modelName)return e._YJSceneManager.SetPlayerPosData(o.pos,o.rotaV3),c++,void u();if("lookatCamPos"==o.modelName)return e._YJSceneManager.SetNiaokanPos(o.pos,o.rotaV3),e._YJSceneManager.AddProcess(),c++,void u();if("lookatPos"==o.modelName)return e._YJSceneManager.SetNiaokanLookatPos(o.pos,o.rotaV3),e._YJSceneManager.AddProcess(),c++,void u();if("3DAudio"==o.modelName){let n=new Vs(e,t,e._YJSceneManager.GetListener(),"",o.pos);return e._YJSceneManager.Set3DAudio(n),e._YJSceneManager.AddProcess(),c++,void u()}!function(n,o,r){let a=o.modelName,l=o.modelPath,h=o.modelType;o.assetId;let d=o.pos,p=o.rotaV3,f=o.size,m=new i(d.x,d.y,d.z),g=new i(p.x,p.y,p.z),y=new i(f.x,f.y,f.z);if("anim"==h)return new Xs(e,t,n,a,e.GetPublicUrl()+l,m,g,y),c++,void u();if("Billboard"==h)return new Ws(e,t,n,e.publicUrl+a,e.$publicUrl+l,m,g,y),e._YJSceneManager.AddProcess(),c++,void u();if("TriggerArea"==h){let i=new Ks(e,t,n,a,e.publicUrl+l,m,g,y);return i.SetData(e.$parent.avatarData.hotPointData.triggerAreaRotaSpeed),i.SetMessage(o.message),e._YJSceneManager.AddProcess(),c++,void u()}s(a,e.GetPublicUrl()+l,m,g,y,!0)}(o.id,o,o.state)}u()}}class Zs{constructor(e,t,n,o,s,r){let a,c,u=this;new l;let h=[],d=null;const p=new De;let f=null,m=[],g=null;!function(){g=o.$parent.avatarData.AmbientLightData;var i=new j(16777215,g.AmbientLightIntensity);e.add(i),"pcweb"==s&&v(g.DirectionalLightPos,g.DirectionalLightIntensity);"ar"!=s&&(e.background=new P(10998015),e.fog=new Oe(10998015,30,1e3));let a=o.$parent.avatarData.setting.playerHeight;c=new hs(e,n,t,o,a,(()=>{if(r&&r(),o.$parent.avatarData.setting.hasMinMap&&(f=new Js(o,u,e),m.push(f)),o.$parent.avatarData.setting.hasEnvmap){const n=new ze(t);let i,s;n.compileEquirectangularShader(),Fe.onLoad=function(){n.dispose()},(new EXRLoader).load(o.GetPublicUrl()+o.$parent.avatarData.setting.envmapPath,(function(t){i=n.fromEquirectangular(t),s=i.texture,t.dispose(),e.background=s,S()}))}else S()}))}(),function(){a=new bs(n,t.domElement),a.addEventListener("dragging-changed",(function(e){o.YJController.enabled=!e.value})),a.name="ignoreRaycast";let i=a;i.setSpace("local"),window.addEventListener("keydown",(function(e){switch(e.keyCode){case 81:case 16:break;case 87:i.setMode("translate"),i.showY=!0,i.showX=!0,i.showZ=!0;break;case 69:i.setMode("rotate"),i.showY=!0,i.showX=!1,i.showZ=!1}})),e.add(a)}(),this.SetMinMap=function(e,t,n,o){f.SetScale(e,t),f.SetOffset(n,o)};let y=[];function v(t,n){if(null==d){const o=new z(16777215,n);d=o,o.position.set(t.x,t.y,t.z),o.castShadow=!0;const i=400,s=.25*i;o.shadow.camera.left=-s,o.shadow.camera.right=s,o.shadow.camera.top=s,o.shadow.camera.bottom=-s,o.shadow.camera.near=i/30,o.shadow.camera.far=i,o.shadow.mapSize.x=4096,o.shadow.mapSize.y=4096,e.add(o)}}this.addLoadMesh=function(e,t){for(let t=y.length-1;t>=0;t--)if(y[t].path==e)return;y.push({path:e,mesh:t})},this.checkLoadMesh=function(e){for(let t=y.length-1;t>=0;t--)if(y[t].path==e)return y[t].mesh;return null},this.AddObjToOutLine=function(e){},this.RemoveObjToOutLine=function(){},this.SetPlayerPos=function(e){c.SetGravityActive(!1),c.SetPlayerPos(new i(e.x,e.y,e.z)),setTimeout((()=>{c.SetGravityActive(!0)}),20)},this.SetCenterPlaneId=function(e){},this.UpdateLightPos=function(){let e=Y();v(new i(100+e.x,100,50+e.z))};let w,x=null,b={};this.SetPlayerPosData=function(e,t){x=e,b.pos=e,b.rotaV3=t},this.SetPlayerPosRota=function(e,t){this.SetPlayerPos(e),o.YJController.SetPlayerRota(t)},this.SetNiaokanPos=e=>{let t=new i(e.x,e.y,e.z);o.YJController.SetNiaokanPos(t)},this.SetNiaokanLookatPos=e=>{let t=new i(e.x,e.y,e.z);o.YJController.SetNiaokanLookatPos(t)},this.CreateMap=function(){console.log(" 初始化创建地图 和 设置角色位置 "),"pcweb"==s&&(o.YJController.SetPlayerRota(b.rotaV3),o.YJController.SetAmmoCtrl(c),o.YJController.GetAmmoPlayer().add(p),p.rotation.y=3.14);let t=new i(x.x,x.y+5,x.z);w=o.$parent.avatarData.setting,w.inMinMapEditor&&(t.x=0,t.z=0),c.SetPlayerPos(t),o.YJController.SetCameraOffsetY(w.camOffsetY),o.YJController.SetCameraOffset(w.cameraOffset),o.YJController.SetMinMax(w.targetRota),o.YJController.SetMoveSpeed(w.moveSpeed),o.YJController.SetContrlState(w.contrlState,w.wheelValue),c.SetMaxMoveSpeed(w.maxMoveSpeed),c.SetFlySpeed(w.upSpeed,w.flySpeed),c.ChangeContrlState(w.contrlState),o.$nextTick((function(){setTimeout((()=>{o.YJController.SetChangeViewBegin(),setTimeout((()=>{}),200)}),500),setTimeout((()=>{"pcweb"==s&&new us(o,e,o.YJController.GetPlayer()),o.$parent.LoadState("success")}),800),c.SetGravityActive(!0)}))},this.BeginEnter=function(){o.YJController.SetChangeViewBeginEnter((()=>{o.YJController.ChangeCtrlState()}))};let M={};async function S(){const t=await o.$axios.get(o.GetPublicUrl()+o.$parent.GetSceneTexPath());M=t.data,o.$parent.LoadState("begin"),I=M.modelDataList.length-1,T=0,new qs(o,e,M.modelDataList)}let T=0;function A(){if(T>=M.modelDataList.length)return;const t=M.modelDataList[T];if("playerPos"==t.modelName)return x=t.pos,T++,void A();t.modelData={},t.modelData.modelName=t.modelName,t.modelData.modelPath=t.modelPath,t.modelData.modelType=t.modelType,t.modelData.size=t.size,t.modelData.pos=t.pos,t.modelData.rotaV3=t.rotaV3,t.modelData.mapId=t.mapId,t.modelData.userId="GameManager",t.state="false",function(t,n,s){let r=n.modelName,a=n.modelPath,l=n.modelType,c=n.assetId,u=n.pos,h=n.rotaV3,d=n.size,p=new i(u.x,u.y,u.z),f=new i(h.x,h.y,h.z),m=new i(d.x,d.y,d.z),g=null;"digger"==r||"door"==r||("npc"==l?g=new Gs(o,e,t,c,null,p,f,null):"ppt"==r||"mmd"==r||(g=new ls(o,e,t,o.GetPublicUrl()+a,p,f,m,r,!0)));o.sceneModels.push({mapId:n.mapId,id:t,modelPath:a,modelImg:n.img,modelType:l,userId:n.userId,assetId:c,name:r,model:g,state:s})}(t.id,t.modelData,t.state)}this.LoadSingleModelCompleted=function(){C++,T++,console.log("---加载模型进度----",C,"/",I),o.$nextTick((function(){A(),o.$parent.LoadingProcess(parseInt(1*C/I*100)),C>I||C>=I&&(console.error("----需要加载的模型全部加载完成---- "+I),o.LoadDone())}))},this.AddProcess=function(){C++,o.$parent.LoadingProcess(parseInt(1*C/I*100)),C>=I&&this.LoadDone()},this.LoadDone=function(){o.$parent.LoadingProcess(100),o.GeneratePlayer()},this.GetListener=function(){return p};let _=null;this.Set3DAudio=function(e){_=e},this.Set3DAudioPlay=function(e){_.play(e)},this.Set3DAudioLoad=function(e){_.load(e)},this.AddHotPoint=function(e){h.push(e)},this.RemoveHotPoint=function(e){for(let t=h.length-1;t>=0;t--)if(h[t]==e)return void h.splice(t,1)},this.AddCanHitModel=function(e){o.canHitModelList.push(e)},this.RemoveCanHitModel=function(e){for(let t=o.canHitModelList.length-1;t>=0;t--)if(o.canHitModelList[t]==e)return void o.canHitModelList.splice(t,1)};let E="";this.GetPlayerInMap=function(e){E="";for(let t=0;t<e.length;t++)E+=e[t].id+"|"},this.AddAmmoPlane=function(e){},this.RemoveAmmoPlane=function(e){},this.CreateMapByIdFromServer=function(e){},this.RemoveMapById=function(e){};let I=0,C=0;this.CreateModelTrigger=function(e,t,n,o,i){return c.createBoxTrigger(e,t,n,o,i)},this.CreateCylinderTrigger=function(e,t,n,o,i){return c.createCylinderTrigger(e,t,n,o,i)},this.CreateModelMeshCollider=function(e,t,n,o){c.createMeshTrigger(e,t,n,o)},this.CreateTriangeMeshCollider=function(e,t,n,o){c.CreateTriangeMeshCollider(e,t,n,o)},this.CreateTriangeMeshTrigger=function(e,t,n,o,i){c.CreateTriangeMeshTrigger(e,t,n,o,i)},this.RemoveCollider=function(e){c.removeRigidBody(e)};var R=!1,k=null,L="",D="",O=null;function F(e,t){for(let i=0;i<o.sceneModels.length;i++){var n=o.sceneModels[i];n.id!=e||n.model.SetOverlapPlayer(t)}}this.ChangeJiaohuArea=function(e,t,n,i){if(0==e)return null!=k&&(clearTimeout(k),k=null),R=e,null!=i.owner||null!=i.owner?void i.owner.SetOverlapPlayer(null):"npc"==D?void F(t,null):void o.ChangeTip(!1);L=t,R=e,O=i,"npc"!=(D=n)?null==i.owner&&null==i.owner?(o.ChangeTip(R),R&&(null!=k&&(clearTimeout(k),k=null),k=setTimeout((()=>{o.ChangeTip(!1)}),3e3))):i.owner.SetOverlapPlayer(o.YJController.GetPlayer()):F(t,o.YJController.GetPlayer())},this.ClickInteractive=function(){if(R){for(let t=0;t<o.sceneModels.length;t++){var e=o.sceneModels[t];e.id!=L||("door"==D&&e.model.PlayAnim(),"digger"==D&&(o.$parent.SetDigger(e.model),o.YJController.SetToOtherPos(getWorldPosition(O),-20),console.log("碰到 digger 查询其动画 ")))}o.ChangeTip(!1)}};let N=null;function Y(){return"pcweb"==s?o.YJController.GetCameraWorldPos():"vr"==s?o.YJVRController.GetCameraWorldPos():void 0}this.HoverObject=function(e,t){if(null!=e)e.owner.SetMouseHover(!0),N=e;else{if(null==N)return;N.owner.SetMouseHover(!1),N=null}},this.update=function(){for(let e=0;e<m.length;e++)m[e]._update()},this.GetCameraWorldPoss=function(){return Y()}}}var Qs=new l;let $s,er=0;var tr={data:()=>({hasStats:!1}),mounted(){this.scene=null,this.camera=null,this.renderer=null,this.pointsParent=null,this.canHitModelList=[],this.hotPointsParent=null,this.YJRaycaster=null,this.YJController=null,this._YJSceneManager=null,this.clock=null,this.logtext="",this.colliderList=[],this.lookatList=[],this.sceneModels=[],this.pos=new i(0,0,0),this.rota=new i(0,0,0),this.platform="pcweb",this.publicUrl=this.$parent.$publicUrl},methods:{GetPublicUrl(){return this.$parent.$publicUrl},initListener(){var e=this;this.$refs.container.addEventListener("click",(function(t){e.threeJSfocus()})),this.$refs.container.addEventListener("touchstart",(function(t){e.threeJSfocus(),e.YJController.mouseDragOn=!0}))},threeJSfocus(){this.$refs.container.focus(),this.YJController.addEventListener()},onWindowResize(){console.log("改变窗口大小"),null!=this.camera&&(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight))},removeEventListener(){this.YJController.dispose()},BeforeLoadThreejs(){this.initScene(),"pcweb"==this.platform&&(this.initListener(),this.initYJRaycaster(),window.addEventListener("resize",this.onWindowResize),this.$refs.container.append(this.renderer.domElement),this.InitYJController(),this.InitSceneManager())},InitThreejs(e,t){this.initScene(),window.addEventListener("resize",this.onWindowResize),this.$refs.container.append(this.renderer.domElement),this.platform=t.platform,this.initListener(),this.initYJRaycaster(),this.InitYJController(),this.InitSceneManager((()=>{this.renderScene()}))},initYJRaycaster(){this.YJRaycaster=new Ze(this,this.scene,this.camera,this.renderer.domElement,((e,t)=>{null!=e?"floor"==e.name||e.name.indexOf("land")>-1||"Plane001"==e.name?this.ClickFloor(e,t):("qq"==e.name&&this.ClickQQ(),"hotPoint"==e.tag&&this.ClickHotPoint(e.modelData)):this.selected=!1}),(e=>{this.logtext=e}),((e,t)=>{if(null==e)return void this._YJSceneManager.HoverObject(e);"链接logo"==e.tag&&this._YJSceneManager.HoverObject(e,t)}),((e,t)=>{"链接logo"==e.tag&&this.InsertPanel(e.name)}),(()=>{this.SelectModel()}))},InsertPanel(e){this.$parent.isInsertPanel=!0,this.$nextTick((()=>{this.$parent.$refs.farmInsetPanel.SetIframeSrc(this.publicUrl+"minMap.png")}))},ClickHotPoint(e){this.$parent.CreateHotContent(e)},SelectModel(e){},ClickFloor(e,t){this.YJController.lookAtPos(t)},HoverObject(e,t){e.owner.SetMouseHover(!0)},initScene(){this.scene=new Ne,this.camera=new k(60,window.innerWidth/window.innerHeight,.1,1e4),this.renderer=new Ye({antialias:!0,alpha:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.setPixelRatio(2),this.pointsParent=new d,this.pointsParent.name="pointsParent",this.scene.add(this.pointsParent),this.hasStats&&($s=new Ue,$s.domElement.style.position="absolute",$s.domElement.style.top="0px",this.$refs.container.appendChild($s.domElement))},InitSceneManager(e){console.log("初始化场景管理器"),this._YJSceneManager=new Zs(this.scene,this.renderer,this.camera,this,this.platform,e)},InitSceneManagerAR(e){this._YJSceneManager=new Zs(this.scene,this.renderer,this.camera,this,"ar",e)},InitYJController(){this.YJController=new mt(this.scene,this.camera,this.renderer.domElement,this),this.YJController.wheelMin=-30,this.YJController.wheelMax=-.01,this.YJController.minY=-1.25,this.YJController.maxY=1.25;let e=new i(0,0,-.3925);this.YJController.SetTargetRota(e)},ChangeAvatar(e,t){this.$parent.LoadState("begin"),this.YJPlayer.ChangeAvatar(e,!0)},ChangeAvatarByCustom(e,t){this.$parent.LoadState("begin"),this.YJPlayer.ChangeAvatarByCustom(e,!0)},ClickJump(){null!=this.YJController&&this.YJController.ClickJump()},ClickInteractive(){null!=this.YJController&&this.YJController.ClickInteractive()},JoystickAxis(e,t){isNaN(e)||isNaN(t)||null==this.YJController||"pcweb"==this.platform&&this.YJController.MoveByJoystickAxis(e,t)},JoystickAxisRight(e,t){isNaN(e)||isNaN(t)||null==this.YJController||"pcweb"==this.platform&&this.YJController.RotaByJoystickAxis(e,t)},ThreeLoadCompleted(){this.$parent.ThreeLoadCompleted()},GetAnimState(){return this.YJDoor.GetAnimState()},ChangeTip(e){this.$parent.ChangeTip(e)},SendSceneState(e,t,n){},GeneratePlayer(){this.YJPlayer=new cs(this,this.scene,!0,"nickName",((e,t)=>{null!=e&&(this.YJController.SetPlayerToCamTarget(e),this.YJController.SetPlayerGroup(t),this._YJSceneManager.CreateMap())}));let e=this.YJPlayer.LoadPlayer(this.$parent.user.playerData.name);this.YJController.SetPlayer(this.YJPlayer),this.YJController.SetTarget(new i(0,e,0),this.$parent.avatarData.setting.camZ)},ClickQQ(){window.location.href="tencent://message/?uin=406729769"},renderScene(){const e=Qs.getDelta();er+=e,er>.03333333333333333&&(this.renderer.render(this.scene,this.camera),er%=.03333333333333333,this._YJSceneManager.update(),this.YJController.update()),this.hasStats&&$s.update(),requestAnimationFrame(this.renderScene)},UpdatePlayerName(){if(null!=this.YJPlayer&&(this.YJPlayer.update(),this.YJPlayer.GetHasPlayer())){let e=this.getScreenPosition(this.YJPlayer.GetPlayerNamePos());this.$parent.updateRotaHotPoint(this.id,e)}},GetLocalPlayerPos(e){let t=this.YJPlayer.GetPlayerNamePos();e&&e(t.x,t.z)},SetLocalPlayerToPos(e){let t={x:e.x,y:5,z:e.z};this._YJSceneManager.SetPlayerPos(t)},SetLocalPlayerToOtherUserPos(e){},SetLocalPlayerToCustomModel(e){},getScreenPosition(e){let t=e.project(this.camera),n=window.innerWidth/2,o=window.innerHeight/2;return{x:Math.round(t.x*n+n),y:Math.round(-t.y*o+o)}}}};const nr={tabindex:"-1",id:"contain",class:"absolute left-0 top-0 w-full h-full bg-gray-400 overflow-hidden",ref:"container"},or={id:"videoParent",class:"hidden w-1/2 h-1/2 absolute top-0 left-0"},ir=["innerHTML"];tr.render=function(e,t,n,o,i,s){return Xe(),He(Ge,null,[Be("div",nr,null,512),Be("div",or,[(Xe(!0),He(Ge,null,Je(e.videoList,((e,t)=>(Xe(),He("div",{key:t,class:"video-box w-40 h-40 p-5 rounded-full"},[Be("div",{class:Ve(e?"distant-stream w-full h-full  rounded-full":"  w-full h-full  rounded-full"),innerHTML:e.html},null,10,ir),Be("div",null,We(e.id),1)])))),128))])],64)};var sr={components:{},data:()=>({offsetX:0,offsetY:0,scaleX:.0026,scaleY:.0024,camPosX:-54,camPosY:40,camPosZ:200,camTargetPosX:0,camTargetPosY:0,camTargetPosZ:0}),mounted(){let e=this;setTimeout((()=>{e.GetMinMapData()}),2e3)},methods:{GetMinMapData(){let e=this.$parent.GetMinMapData(),t=e.minMapOffset;this.offsetX=t.x,this.offsetY=t.y;let n=e.minMapScale;this.scaleX=n.x,this.scaleY=n.y},Change(){this.$parent.SetMinMap(this.scaleX,this.scaleY,this.offsetX,this.offsetY)},ChangeNiankan(){this.$parent.SetCamPos(this.camPosX,this.camPosY,this.camPosZ,this.camTargetPosX,this.camTargetPosY,this.camTargetPosZ)}}};const rr={class:"absolute top-0 w-1/4 h-1/4 left-10 flex"},ar={class:"relative self-center w-full h-full bg-gray-100 rounded-md text-xs px-10"},lr={class:"mt-2 w-full h-10 flex gap-x-5"},cr=Be("div",{class:"self-center"},"地图偏移 X",-1),ur={class:"mt-2 w-full h-10 flex gap-x-5"},hr=Be("div",{class:"self-center"},"地图偏移 Y",-1),dr={class:"mt-2 w-full h-10 flex gap-x-5"},pr=Be("div",{class:"self-center"},"地图缩放 X",-1),fr={class:"mt-2 w-full h-10 flex gap-x-5"},mr=Be("div",{class:"self-center"},"地图缩放 Y",-1);sr.render=function(e,t,n,o,i,s){return Xe(),He("div",rr,[Be("div",ar,[Be("div",lr,[cr,Ke(Be("input",{class:"w-20 h-10 px-1","onUpdate:modelValue":t[0]||(t[0]=e=>i.offsetX=e),onChange:t[1]||(t[1]=e=>s.Change()),type:"number",step:"0.0005"},null,544),[[qe,i.offsetX]])]),Be("div",ur,[hr,Ke(Be("input",{class:"w-20 h-10 px-1","onUpdate:modelValue":t[2]||(t[2]=e=>i.offsetY=e),onChange:t[3]||(t[3]=e=>s.Change()),type:"number",step:"0.0005"},null,544),[[qe,i.offsetY]])]),Be("div",dr,[pr,Ke(Be("input",{class:"w-20 h-10 px-1","onUpdate:modelValue":t[4]||(t[4]=e=>i.scaleX=e),onChange:t[5]||(t[5]=e=>s.Change()),type:"number",step:"0.00005"},null,544),[[qe,i.scaleX]])]),Be("div",fr,[mr,Ke(Be("input",{class:"w-20 h-10 px-1","onUpdate:modelValue":t[6]||(t[6]=e=>i.scaleY=e),onChange:t[7]||(t[7]=e=>s.Change()),type:"number",step:"0.00005"},null,544),[[qe,i.scaleY]])])])])};class gr{constructor(e,t,n,o,i,s,r){this.axisX=0,this.axisY=0,this.domElement=void 0!==i?i:document;var a=!1,l=new Image,c=new Image,u=e.height,h=.6*u,d=u/2,p=u/2,f=100,m=100,g=0,y=0;window.addEventListener("load",(function(){g=u/2+(f=t),y=u/2+(m=n),console.log(" offsetX load = "+f+" offsetY = "+m)}),!1);var v=e.getContext("2d"),w=0,x=0;l.onload=function(){v.drawImage(l,d-h/2,p-h/2,h,h)},c.onload=function(){v.drawImage(c,d-u/2,p-u/2,u,u)},l.src=s,c.src=r;var b=0,M=23;function S(e,t,n,o,i,s,r){var a,l,c=(r-i)/(s-o),u=r-c*s,h=e*e+(u-t)*(u-t)-n*n,d=1+c*c,p=2*e-2*c*(u-t),f=Math.sqrt(p*p-4*d*h);return[a=(p+f)/(2*d),c*a+u,l=(p-f)/(2*d),c*l+u]}this.Reload=function(e,t){g=u/2+(f=e),y=u/2+(m=t),console.log(" offsetX reload = "+f+" offsetY = "+m)},this.onMouseDown=function(e){console.log(" onMouseDown ");var t=e.target.id;a=t.indexOf(o)>-1},this.onMouseUp=function(e){w=0,x=0,a=!1,this.axisX=w/M,this.axisY=x/M},this.onMouseMove=function(e){if(a){if(Math.sqrt(Math.pow(e.clientX-g,2)+Math.pow(e.clientY-y,2))<=u/2-h/2)w=e.clientX-g,x=e.clientY-y;else{var t=e.clientX,n=e.clientY,o=S(g,y,u/2-h/2,g,y,t,n);Math.sqrt((o[0]-t)*(o[0]-t)+(o[1]-n)*(o[1]-n))<Math.sqrt((o[2]-t)*(o[2]-t)+(o[3]-n)*(o[3]-n))?(w=o[0]-g,x=o[1]-y):(w=o[2]-g,x=o[3]-y)}w>M&&(w=M),w<-23&&(w=-23),x>M&&(x=M),x<-23&&(x=-23),this.axisX=w/M,this.axisY=x/M}},this.onTouchStart=function(e){if(e.preventDefault(),e.stopPropagation(),e.target.id.indexOf(o)>-1){a=!0;var t=e.touches;b=t.length>1?1:0}},this.onTouchEnd=function(e){if(e.target.id.indexOf(o)>-1)return w=0,x=0,a=!1,this.axisX=w/M,void(this.axisY=x/M);var t=e.touches;b=t.length>1?1:0},this.onTouchMove=function(e){if(a){if(Math.sqrt(Math.pow(e.touches[b].clientX-g,2)+Math.pow(e.touches[b].clientY-y,2))<=u/2-h/2)w=e.touches[b].clientX-g,x=e.touches[b].clientY-y;else{var t=e.touches[b].clientX,n=e.touches[b].clientY,o=S(g,y,u/2-h/2,g,y,t,n);Math.sqrt((o[0]-t)*(o[0]-t)+(o[1]-n)*(o[1]-n))<Math.sqrt((o[2]-t)*(o[2]-t)+(o[3]-n)*(o[3]-n))?(w=o[0]-g,x=o[1]-y):(w=o[2]-g,x=o[3]-y)}this.axisX=w/M,this.axisY=x/M}},requestAnimationFrame((function e(){v.clearRect(d-u/2,p-u/2,u,u),v.drawImage(c,d-u/2,p-u/2,u,u),v.drawImage(l,d-h/2+w,p-h/2+x,h,h),requestAnimationFrame(e)})),this.update=function(e){v.clearRect(d-u/2,p-u/2,u,u),v.drawImage(c,d-u/2,p-u/2,u,u),v.drawImage(l,d-h/2+w,p-h/2+x,h,h)},this.dispose=function(){this.domElement.removeEventListener("mousedown",P,!1),this.domElement.removeEventListener("mousemove",T,!1),this.domElement.removeEventListener("mouseup",A,!1),this.domElement.removeEventListener("touchstart",_,!1),this.domElement.removeEventListener("touchend",E,!1),this.domElement.removeEventListener("touchmove",I,!1)},this.addEventListener=function(){this.domElement.addEventListener("mousemove",T,!1),this.domElement.addEventListener("mousedown",P,!1),this.domElement.addEventListener("mouseup",A,!1),this.domElement.addEventListener("touchstart",_,!1),this.domElement.addEventListener("touchend",E,!1),this.domElement.addEventListener("touchmove",I,!1),this.domElement.addEventListener("contextmenu",yr)};var T=C(this,this.onMouseMove),P=C(this,this.onMouseDown),A=C(this,this.onMouseUp),_=C(this,this.onTouchStart),E=C(this,this.onTouchEnd),I=C(this,this.onTouchMove);function C(e,t){return function(){t.apply(e,arguments)}}this.addEventListener()}}function yr(e){e.preventDefault()}var vr,wr,xr={name:"joystickLeft",components:{},data:()=>({diplay:!0,Joystick:null,laterHiddenJoystick:null}),created(){},mounted(){this.CreateJoytick()},methods:{CreateJoytick(){vr=document.getElementById("joystick_left_parent").offsetLeft,wr=document.getElementById("joystick_left_parent").offsetTop,vr+=document.getElementById("joystick_left").offsetLeft,wr+=document.getElementById("joystick_left").offsetTop,console.log(" 左摇杆坐标 ",vr,wr),this.Joystick=new gr(document.getElementById("joystick_left"),vr,wr,"left",document.getElementById("joystick_left"),this.$publicUrl+"images/joystick2/joystickin.png",this.$publicUrl+"images/joystick2/RadialJoy_Area.png"),this.Joystick.Reload(vr,wr),this.UpdateJoystick()},UpdateJoystick(){if(requestAnimationFrame(this.UpdateJoystick),this.$parent.$refs.ThreejsHumanChat.JoystickAxis(this.Joystick.axisX,this.Joystick.axisY),0!=this.Joystick.axisX||0!=this.Joystick.axisY){this.display=!0,null!=this.laterHiddenJoystick&&clearTimeout(this.laterHiddenJoystick);var e=this;this.laterHiddenJoystick=setTimeout((()=>{e.display=!1}),2e3)}}}};const br={class:"w-40 h-40 flex rounded-full"},Mr={class:"self-center mx-auto rounded-full pointer-events-auto stop-long-hover",ref:"joystick",id:"joystick_left",width:"120",height:"120"};var Sr,Tr;xr.render=function(e,t,n,o,i,s){return Xe(),He("div",{id:"joystick_left_parent",class:Ve(["absolute z-50 w-40 h-40 left-0 bottom-0 pointer-events-none",i.diplay?" opacity-100 ":" opacity-0 "])},[Be("div",br,[Be("canvas",Mr,null,512)])],2)};var Pr={name:"joystickRight",components:{},data:()=>({diplay:!0,Joystick:null,laterHiddenJoystick:null}),created(){},mounted(){this.CreateJoytick()},methods:{CreateJoytick(){Sr=document.getElementById("joystick_right_parent").offsetLeft,Tr=document.getElementById("joystick_right_parent").offsetTop,Sr+=document.getElementById("joystick_right").offsetLeft,Tr+=document.getElementById("joystick_right").offsetTop,console.log(" 又摇杆坐标 ",Sr,Tr),this.Joystick=new gr(document.getElementById("joystick_right"),Sr,Tr,"right",document.getElementById("joystick_right"),this.$publicUrl+"images/joystick2/joystickin.png",this.$publicUrl+"images/joystick2/RadialJoy_Area.png"),this.Joystick.Reload(Sr,Tr),this.UpdateJoystick()},UpdateJoystick(){if(requestAnimationFrame(this.UpdateJoystick),this.$parent.$refs.ThreejsHumanChat.JoystickAxisRight(this.Joystick.axisX,this.Joystick.axisY),0!=this.Joystick.axisX||0!=this.Joystick.axisY){this.display=!0,null!=this.laterHiddenJoystick&&clearTimeout(this.laterHiddenJoystick);var e=this;this.laterHiddenJoystick=setTimeout((()=>{e.display=!1}),2e3)}}}};const Ar={class:"w-40 h-40 flex rounded-full"},_r={class:"self-center mx-auto rounded-full pointer-events-auto stop-long-hover",ref:"joystick",id:"joystick_right",width:"120",height:"120"};Pr.render=function(e,t,n,o,i,s){return Xe(),He("div",{id:"joystick_right_parent",class:Ve(["absolute z-50 w-40 h-40 right-0 bottom-0 pointer-events-none",i.diplay?" opacity-100 ":" opacity-0 "])},[Be("div",Ar,[Be("canvas",_r,null,512)])],2)};var Er={languageCN:{language:{zh:"中文",en:"英文"},content:{selectAvatar:"选择形象",enterUserName:"输入昵称",selectOK:"确定",enter3D:"进入",sendMsg:"发送",clearMsg:"清空",secretSpeak:"悄悄话",jump:"传送",toSpeak:"对你说",speak:"说",speakTo:"你对",skin:"皮肤",onlineList:"在线用户"}},languageEN:{language:{zh:"chinese",en:"english"},content:{selectAvatar:"Select Avatar",enterUserName:"User Name",selectOK:"OK",enter3D:"ENTER",sendMsg:"Send",clearMsg:"Clear",secretSpeak:"SecretSpeak",jump:"JUMP",toSpeak:"speak to you",speak:"",speakTo:"you speak to",skin:"Skin",onlineList:"onLine"}}};export{Er as L,sr as a,xr as b,Pr as c,tr as s};
